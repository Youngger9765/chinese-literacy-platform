name: Cleanup Orphan Preview Services

on:
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday midnight UTC
  workflow_dispatch:  # Manual trigger

permissions:
  contents: read

env:
  PROJECT_ID: lingoleap-dev
  REGION: asia-east1

jobs:
  cleanup:
    name: Delete orphan preview services
    runs-on: ubuntu-latest

    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Find and delete orphan preview services
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');

            // Get all preview services
            const output = execSync(
              `gcloud run services list --region=${process.env.REGION} --project=${process.env.PROJECT_ID} --format='value(name)'`
            ).toString().trim();

            const services = output.split('\n').filter(s =>
              s.includes('-issue-') || s.includes('-pr-')
            );

            if (services.length === 0) {
              console.log('No preview services found. All clean!');
              return;
            }

            console.log(`Found ${services.length} preview services to check`);

            // Get open PRs
            const { data: openPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
            });

            // Extract issue/PR numbers from open PRs
            const activeNumbers = new Set();
            for (const pr of openPRs) {
              // PR number
              activeNumbers.add(String(pr.number));
              // Issue number from branch name
              const match = pr.head.ref.match(/issue-(\d+)/);
              if (match) activeNumbers.add(match[1]);
            }

            console.log(`Active issue/PR numbers: ${[...activeNumbers].join(', ') || 'none'}`);

            let deleted = 0;
            for (const svc of services) {
              // Extract number from service name
              const match = svc.match(/(?:issue|pr)-(\d+)/);
              if (!match) continue;

              const num = match[1];
              if (activeNumbers.has(num)) {
                console.log(`KEEP: ${svc} (PR/issue #${num} still open)`);
                continue;
              }

              console.log(`DELETE: ${svc} (PR/issue #${num} closed/merged)`);
              try {
                execSync(
                  `gcloud run services delete ${svc} --region=${process.env.REGION} --project=${process.env.PROJECT_ID} --quiet`,
                  { timeout: 60000 }
                );
                deleted++;
              } catch (e) {
                console.log(`  Failed to delete ${svc}: ${e.message}`);
              }
            }

            console.log(`\nCleanup complete: ${deleted} services deleted, ${services.length - deleted} kept`);
