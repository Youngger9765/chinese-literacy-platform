# å¤šç§Ÿæˆ¶å¯¦ä½œï¼ˆè¦æ¨¡åŒ–é—œéµæŠ€è¡“ï¼‰

> è¨˜éŒ„æ—¥æœŸï¼š2026-02-13
> ä¾†æºï¼šLMS_EXTENDED_SYSTEMS.md ç³»çµ± 6
> é—œéµæ€§ï¼šâ­â­â­â­â­ï¼ˆè¦æ¨¡åŒ–æ ¸å¿ƒæŠ€è¡“ï¼‰

---

## ğŸ“‹ æ–‡ä»¶ç›®çš„

æœ¬æ–‡ä»¶è©³ç´°èªªæ˜å¤šç§Ÿæˆ¶æ¶æ§‹çš„æŠ€è¡“å¯¦ä½œï¼ŒåŒ…å«ï¼š
1. **Row Level Security (RLS)** - è³‡æ–™åº«å±¤éš”é›¢
2. **æ¬Šé™åˆ†ç´šç®¡ç†** - 5 ç¨®è§’è‰²æ¬Šé™è¨­è¨ˆ
3. **æŸ¥è©¢éæ¿¾ç­–ç•¥** - æ‡‰ç”¨å±¤éš”é›¢
4. **æ©Ÿæ§‹ç´šå„€è¡¨æ¿** - è·¨æ ¡æ•¸æ“šåˆ†æ
5. **è¨‚é–±èˆ‡è¨ˆè²»ç®¡ç†** - å•†æ¥­æ¨¡å¼æ”¯æ´

---

## ğŸ”’ è³‡æ–™éš”é›¢æ©Ÿåˆ¶

### æ ¸å¿ƒåŸå‰‡

```
æ©Ÿæ§‹ A çš„è³‡æ–™ âœ— çµ•å°ç„¡æ³•å­˜å– âœ— æ©Ÿæ§‹ B çš„è³‡æ–™
```

**ä¸‰å±¤é˜²è­·**ï¼š
1. **æ‡‰ç”¨å±¤**ï¼šmiddleware å¼·åˆ¶æª¢æŸ¥ organization_id
2. **è³‡æ–™åº«å±¤**ï¼šRow Level Security (RLS) å¼·åˆ¶éš”é›¢
3. **å¯©è¨ˆå±¤**ï¼šè¨˜éŒ„æ‰€æœ‰è·¨æ©Ÿæ§‹æŸ¥è©¢å˜—è©¦

---

### Row Level Security (RLS) è¨­è¨ˆ

#### ä»€éº¼æ˜¯ RLSï¼Ÿ

PostgreSQL çš„ Row Level Security å¯åœ¨è³‡æ–™åº«å±¤å¼·åˆ¶åŸ·è¡Œè³‡æ–™éš”é›¢ï¼Œå³ä½¿ SQL æ³¨å…¥ä¹Ÿç„¡æ³•ç¹éã€‚

---

#### å•Ÿç”¨ RLS

```sql
-- å°éœ€è¦éš”é›¢çš„è¡¨å•Ÿç”¨ RLS
ALTER TABLE courses ENABLE ROW LEVEL SECURITY;
ALTER TABLE course_nodes ENABLE ROW LEVEL SECURITY;
ALTER TABLE assignments ENABLE ROW LEVEL SECURITY;
ALTER TABLE student_activities ENABLE ROW LEVEL SECURITY;
```

---

#### æ”¿ç­–ç¯„ä¾‹ 1ï¼šæ©Ÿæ§‹éš”é›¢

```sql
-- ç¢ºä¿ç”¨æˆ¶åªèƒ½æŸ¥è©¢è‡ªå·±æ©Ÿæ§‹çš„èª²ç¨‹
CREATE POLICY org_isolation_policy ON courses
  FOR ALL
  USING (
    organization_id = current_setting('app.current_org_id')::uuid
    OR
    organization_id IS NULL  -- å®˜æ–¹èª²ç¨‹é™¤å¤–
  );
```

**èªªæ˜**ï¼š
- `current_setting('app.current_org_id')` å¾ session è®Šæ•¸å–å¾—ç•¶å‰æ©Ÿæ§‹ ID
- `organization_id IS NULL` è¡¨ç¤ºå®˜æ–¹èª²ç¨‹ï¼Œæ‰€æœ‰æ©Ÿæ§‹å¯è¦‹

---

#### æ”¿ç­–ç¯„ä¾‹ 2ï¼šå­¸æ ¡ç®¡ç†å“¡æ¬Šé™

```sql
-- å­¸æ ¡ç®¡ç†å“¡åªèƒ½æŸ¥è©¢æœ¬æ ¡è³‡æ–™
CREATE POLICY school_admin_policy ON classrooms
  FOR ALL
  USING (
    school_id = current_setting('app.current_school_id')::uuid
    OR
    EXISTS (
      SELECT 1 FROM users
      WHERE user_id = current_setting('app.current_user_id')::uuid
        AND role IN ('org_admin', 'platform_admin')
    )
  );
```

**èªªæ˜**ï¼š
- å­¸æ ¡ç®¡ç†å“¡åªèƒ½çœ‹æœ¬æ ¡ç­ç´š
- æ©Ÿæ§‹ç®¡ç†å“¡å’Œå¹³å°ç®¡ç†å“¡å¯çœ‹æ‰€æœ‰ç­ç´š

---

#### æ”¿ç­–ç¯„ä¾‹ 3ï¼šæ•™å¸«æ¬Šé™

```sql
-- æ•™å¸«åªèƒ½æŸ¥è©¢è‡ªå·±ç­ç´šçš„å­¸ç”Ÿæ´»å‹•
CREATE POLICY teacher_policy ON student_activities
  FOR SELECT
  USING (
    -- ç­ç´šä½œæ¥­ï¼šå¿…é ˆæ˜¯è‡ªå·±æ´¾ç™¼çš„
    (
      teacher_assigned = true
      AND assignment_id IN (
        SELECT assignment_id FROM assignments
        WHERE teacher_id = current_setting('app.current_user_id')::uuid
      )
    )
    OR
    -- è‡ªå­¸æ´»å‹•ï¼šåªè¦å­¸ç”Ÿåœ¨è‡ªå·±ç­ç´šå°±å¯è¦‹
    (
      teacher_assigned = false
      AND student_id IN (
        SELECT cs.student_id
        FROM class_students cs
        JOIN class_teachers ct ON cs.classroom_id = ct.classroom_id
        WHERE ct.teacher_id = current_setting('app.current_user_id')::uuid
      )
    )
  );
```

---

#### æ”¿ç­–ç¯„ä¾‹ 4ï¼šå­¸ç”Ÿæ¬Šé™

```sql
-- å­¸ç”Ÿåªèƒ½æŸ¥è©¢è‡ªå·±çš„æ´»å‹•
CREATE POLICY student_policy ON student_activities
  FOR ALL
  USING (
    student_id = current_setting('app.current_user_id')::uuid
  );
```

---

### è¨­å®š Session è®Šæ•¸

#### æ‡‰ç”¨å±¤è¨­å®šï¼ˆæ¯æ¬¡è«‹æ±‚ï¼‰

```python
# FastAPI middleware ç¯„ä¾‹
from fastapi import Request
import asyncpg

@app.middleware("http")
async def set_rls_context(request: Request, call_next):
    user = request.state.user  # å¾ JWT å–å¾—

    async with db.pool.acquire() as conn:
        # è¨­å®š session è®Šæ•¸
        await conn.execute(
            "SET app.current_user_id = $1",
            str(user.user_id)
        )
        await conn.execute(
            "SET app.current_org_id = $1",
            str(user.organization_id)
        )
        if user.school_id:
            await conn.execute(
                "SET app.current_school_id = $1",
                str(user.school_id)
            )

        response = await call_next(request)
        return response
```

---

### RLS æ¸¬è©¦

```sql
-- æ¸¬è©¦ 1ï¼šè¨­å®šç‚ºæ©Ÿæ§‹ A ç”¨æˆ¶
SET app.current_org_id = 'org_a_uuid';
SELECT * FROM courses;
-- çµæœï¼šåªèƒ½çœ‹åˆ°æ©Ÿæ§‹ A çš„èª²ç¨‹ + å®˜æ–¹èª²ç¨‹

-- æ¸¬è©¦ 2ï¼šè¨­å®šç‚ºæ©Ÿæ§‹ B ç”¨æˆ¶
SET app.current_org_id = 'org_b_uuid';
SELECT * FROM courses;
-- çµæœï¼šåªèƒ½çœ‹åˆ°æ©Ÿæ§‹ B çš„èª²ç¨‹ + å®˜æ–¹èª²ç¨‹

-- æ¸¬è©¦ 3ï¼šå˜—è©¦ç›´æ¥æŸ¥è©¢æ©Ÿæ§‹ A çš„èª²ç¨‹ï¼ˆæ‡‰è©²å¤±æ•—ï¼‰
SET app.current_org_id = 'org_b_uuid';
SELECT * FROM courses WHERE organization_id = 'org_a_uuid';
-- çµæœï¼šç©ºçµæœï¼ˆRLS è‡ªå‹•éæ¿¾ï¼‰
```

---

## ğŸ‘¥ æ¬Šé™åˆ†ç´šç®¡ç†

### è§’è‰²å®šç¾©è¡¨

```sql
CREATE TYPE user_role AS ENUM (
  'platform_admin',   -- å¹³å°è¶…ç´šç®¡ç†å“¡
  'org_admin',        -- æ©Ÿæ§‹ç®¡ç†å“¡
  'school_admin',     -- å­¸æ ¡ç®¡ç†å“¡
  'teacher',          -- æ•™å¸«
  'student',          -- å­¸ç”Ÿ
  'parent'            -- å®¶é•·
);

CREATE TABLE users (
  user_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(100) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  role user_role NOT NULL,

  -- ç§Ÿæˆ¶æ¨™è­˜
  organization_id UUID REFERENCES organizations(org_id),
  school_id UUID REFERENCES schools(school_id),

  -- å€‹äººè³‡æ–™
  name VARCHAR(50) NOT NULL,
  phone VARCHAR(20),

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_users_org_id ON users(organization_id);
CREATE INDEX idx_users_school_id ON users(school_id);
CREATE INDEX idx_users_role ON users(role);
```

---

### æ¬Šé™çŸ©é™£

| è³‡æº/æ“ä½œ | Platform Admin | Org Admin | School Admin | Teacher | Student | Parent |
|----------|----------------|-----------|--------------|---------|---------|--------|
| **æ©Ÿæ§‹ç®¡ç†** | CRUD | R (æœ¬æ©Ÿæ§‹) | - | - | - | - |
| **å­¸æ ¡ç®¡ç†** | CRUD | CRUD (æ——ä¸‹) | R (æœ¬æ ¡) | - | - | - |
| **ç­ç´šç®¡ç†** | CRUD | CRUD (æ——ä¸‹) | CRUD (æœ¬æ ¡) | R (ä»»æ•™ç­) | - | - |
| **æ•™å¸«ç®¡ç†** | CRUD | CRUD (æ——ä¸‹) | CRUD (æœ¬æ ¡) | - | - | - |
| **å­¸ç”Ÿç®¡ç†** | CRUD | CRUD (æ——ä¸‹) | CRUD (æœ¬æ ¡) | CRUD (æœ¬ç­) | R (è‡ªå·±) | R (å­å¥³) |
| **å®˜æ–¹èª²ç¨‹** | CRUD | R | R | R | R | - |
| **æ©Ÿæ§‹èª²ç¨‹** | R | CRUD (æœ¬æ©Ÿæ§‹) | R (æœ¬æ©Ÿæ§‹) | R (æœ¬æ©Ÿæ§‹) | - | - |
| **æ ¡ç´šèª²ç¨‹** | R | R (æ——ä¸‹) | CRUD (æœ¬æ ¡) | R (æœ¬æ ¡) | - | - |
| **ç­ç´šèª²ç¨‹** | R | R (æ——ä¸‹) | R (æœ¬æ ¡) | CRUD (æœ¬ç­) | R (æ´¾ç™¼çš„) | - |
| **ä½œæ¥­æ´¾ç™¼** | - | - | - | CRUD (æœ¬ç­) | - | - |
| **å­¸ç¿’æ´»å‹•** | R (æ‰€æœ‰) | R (æ——ä¸‹) | R (æœ¬æ ¡) | R (æœ¬ç­) | CRUD (è‡ªå·±) | R (å­å¥³) |
| **çµ±è¨ˆå ±è¡¨** | All | Org Level | School Level | Class Level | Personal | Child |

**åœ–ä¾‹**ï¼š
- C = Create (å»ºç«‹)
- R = Read (è®€å–)
- U = Update (æ›´æ–°)
- D = Delete (åˆªé™¤)
- `-` = ç„¡æ¬Šé™

---

### æ¬Šé™æª¢æŸ¥å‡½æ•¸

```sql
-- æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æœ‰æ¬Šé™å­˜å–è³‡æº
CREATE OR REPLACE FUNCTION check_permission(
  p_user_id UUID,
  p_resource VARCHAR,
  p_action VARCHAR,
  p_target_org_id UUID DEFAULT NULL,
  p_target_school_id UUID DEFAULT NULL
)
RETURNS BOOLEAN AS $$
DECLARE
  user_role user_role;
  user_org_id UUID;
  user_school_id UUID;
BEGIN
  -- å–å¾—ç”¨æˆ¶è³‡æ–™
  SELECT role, organization_id, school_id
  INTO user_role, user_org_id, user_school_id
  FROM users
  WHERE user_id = p_user_id;

  -- Platform Adminï¼šå…¨æ¬Šé™
  IF user_role = 'platform_admin' THEN
    RETURN true;
  END IF;

  -- Org Adminï¼šæœ¬æ©Ÿæ§‹æ¬Šé™
  IF user_role = 'org_admin' THEN
    IF p_target_org_id IS NULL OR p_target_org_id = user_org_id THEN
      RETURN true;
    END IF;
  END IF;

  -- School Adminï¼šæœ¬æ ¡æ¬Šé™
  IF user_role = 'school_admin' THEN
    IF p_target_school_id IS NULL OR p_target_school_id = user_school_id THEN
      RETURN true;
    END IF;
  END IF;

  -- Teacher/Student/Parentï¼šéœ€è¦æ›´ç´°ç·»çš„æª¢æŸ¥
  -- ï¼ˆæ ¹æ“šå…·é«”è³‡æºé¡å‹åˆ¤æ–·ï¼‰

  RETURN false;
END;
$$ LANGUAGE plpgsql;
```

---

### æ‡‰ç”¨å±¤æ¬Šé™æª¢æŸ¥

```python
# FastAPI dependency ç¯„ä¾‹
from fastapi import Depends, HTTPException, status
from typing import List

def require_role(allowed_roles: List[str]):
    def role_checker(current_user: User = Depends(get_current_user)):
        if current_user.role not in allowed_roles:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="Insufficient permissions"
            )
        return current_user
    return role_checker

# ä½¿ç”¨ç¯„ä¾‹
@app.post("/api/organizations")
async def create_organization(
    org_data: OrganizationCreate,
    current_user: User = Depends(require_role(['platform_admin']))
):
    # åªæœ‰ platform_admin å¯ä»¥å»ºç«‹æ©Ÿæ§‹
    ...

@app.get("/api/schools/{school_id}/students")
async def list_students(
    school_id: UUID,
    current_user: User = Depends(require_role(['org_admin', 'school_admin']))
):
    # æª¢æŸ¥æ˜¯å¦æœ‰æ¬Šé™å­˜å–æ­¤å­¸æ ¡
    if current_user.role == 'school_admin':
        if current_user.school_id != school_id:
            raise HTTPException(status_code=403)
    elif current_user.role == 'org_admin':
        school = await get_school(school_id)
        if school.organization_id != current_user.organization_id:
            raise HTTPException(status_code=403)

    return await get_students(school_id)
```

---

## ğŸ“Š æ©Ÿæ§‹ç´šå„€è¡¨æ¿

### çµ±è¨ˆæ•¸æ“šè¡¨

```sql
-- æ©Ÿæ§‹çµ±è¨ˆè¡¨ï¼ˆæ¯æ—¥æ›´æ–°ï¼‰
CREATE TABLE organization_stats (
  stat_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(org_id) ON DELETE CASCADE,
  stat_date DATE NOT NULL,

  -- åŸºç¤æ•¸æ“š
  total_schools INT DEFAULT 0,
  total_teachers INT DEFAULT 0,
  total_students INT DEFAULT 0,

  -- æ´»èºåº¦
  active_students_today INT DEFAULT 0,
  active_students_week INT DEFAULT 0,
  active_students_month INT DEFAULT 0,

  -- å­¸ç¿’æ•¸æ“š
  total_assignments_created INT DEFAULT 0,
  total_assignments_completed INT DEFAULT 0,
  avg_completion_rate NUMERIC(5,2) DEFAULT 0,
  avg_daily_learning_minutes INT DEFAULT 0,

  -- æˆç¸¾æ•¸æ“š
  avg_accuracy NUMERIC(5,2) DEFAULT 0,
  avg_speed NUMERIC(8,2) DEFAULT 0,

  calculated_at TIMESTAMP DEFAULT NOW(),

  UNIQUE(organization_id, stat_date)
);

CREATE INDEX idx_org_stats_org_date ON organization_stats(organization_id, stat_date DESC);
```

---

### å­¸æ ¡æ’åè¡¨

```sql
-- å­¸æ ¡æ’åè¡¨
CREATE TABLE school_rankings (
  ranking_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(org_id) ON DELETE CASCADE,
  school_id UUID REFERENCES schools(school_id) ON DELETE CASCADE,

  ranking_type VARCHAR(20) CHECK (ranking_type IN (
    'completion_rate',  -- å®Œæˆç‡æ’å
    'improvement',      -- é€²æ­¥å¹…åº¦æ’å
    'engagement',       -- æ´»èºåº¦æ’å
    'accuracy'          -- æº–ç¢ºç‡æ’å
  )),

  rank INT NOT NULL,
  score NUMERIC(8,2),
  period_start DATE,
  period_end DATE,

  calculated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_school_rankings_org_type ON school_rankings(organization_id, ranking_type);
```

---

### çµ±è¨ˆæŸ¥è©¢ API

#### æ©Ÿæ§‹ç¸½è¦½

```sql
-- æ©Ÿæ§‹ç¸½è¦½æ•¸æ“š
SELECT
  o.org_name,
  os.total_schools,
  os.total_students,
  os.active_students_month,
  ROUND(os.active_students_month::NUMERIC / os.total_students * 100, 2) AS monthly_active_rate,
  os.avg_completion_rate,
  os.avg_daily_learning_minutes
FROM organizations o
LEFT JOIN organization_stats os ON o.org_id = os.organization_id
WHERE o.org_id = :org_id
  AND os.stat_date = CURRENT_DATE
ORDER BY os.stat_date DESC
LIMIT 1;
```

---

#### è·¨æ ¡æ¯”è¼ƒ

```sql
-- è·¨æ ¡å®Œæˆç‡æ¯”è¼ƒ
SELECT
  s.school_name,
  COUNT(DISTINCT a.assignment_id) AS total_assignments,
  COUNT(DISTINCT CASE WHEN asub.status = 'passed' THEN asub.submission_id END) AS completed_assignments,
  ROUND(
    COUNT(DISTINCT CASE WHEN asub.status = 'passed' THEN asub.submission_id END)::NUMERIC /
    NULLIF(COUNT(DISTINCT a.assignment_id), 0) * 100,
    2
  ) AS completion_rate,
  sr.rank
FROM schools s
LEFT JOIN classrooms c ON s.school_id = c.school_id
LEFT JOIN assignments a ON c.classroom_id = a.classroom_id
LEFT JOIN assignment_submissions asub ON a.assignment_id = asub.assignment_id
LEFT JOIN school_rankings sr ON
  s.school_id = sr.school_id
  AND sr.ranking_type = 'completion_rate'
  AND sr.period_end = CURRENT_DATE
WHERE s.organization_id = :org_id
GROUP BY s.school_id, s.school_name, sr.rank
ORDER BY completion_rate DESC;
```

---

#### æ™‚é–“è¶¨å‹¢

```sql
-- æ©Ÿæ§‹å­¸ç¿’æ™‚é•·è¶¨å‹¢ï¼ˆè¿‘ 30 å¤©ï¼‰
SELECT
  stat_date,
  avg_daily_learning_minutes,
  active_students_today
FROM organization_stats
WHERE organization_id = :org_id
  AND stat_date >= CURRENT_DATE - INTERVAL '30 days'
ORDER BY stat_date ASC;
```

---

### çµ±è¨ˆè¨ˆç®—ä»»å‹™ï¼ˆå®šæ™‚ä»»å‹™ï¼‰

```python
# Celery å®šæ™‚ä»»å‹™ç¯„ä¾‹
from celery import Celery
from datetime import date, timedelta

@celery.task
def calculate_daily_organization_stats():
    """æ¯æ—¥å‡Œæ™¨ 2:00 åŸ·è¡Œ"""
    today = date.today()
    yesterday = today - timedelta(days=1)

    # å–å¾—æ‰€æœ‰æ©Ÿæ§‹
    organizations = await db.fetch("SELECT org_id FROM organizations WHERE status = 'active'")

    for org in organizations:
        org_id = org['org_id']

        # è¨ˆç®—åŸºç¤æ•¸æ“š
        total_schools = await db.fetchval(
            "SELECT COUNT(*) FROM schools WHERE organization_id = $1",
            org_id
        )

        total_students = await db.fetchval(
            """
            SELECT COUNT(DISTINCT s.student_id)
            FROM students s
            JOIN class_students cs ON s.student_id = cs.student_id
            JOIN classrooms c ON cs.classroom_id = c.classroom_id
            JOIN schools sch ON c.school_id = sch.school_id
            WHERE sch.organization_id = $1
            """,
            org_id
        )

        # è¨ˆç®—æ´»èºå­¸ç”Ÿï¼ˆæ˜¨å¤©æœ‰å­¸ç¿’æ´»å‹•ï¼‰
        active_students_yesterday = await db.fetchval(
            """
            SELECT COUNT(DISTINCT sa.student_id)
            FROM student_activities sa
            JOIN students s ON sa.student_id = s.student_id
            JOIN class_students cs ON s.student_id = cs.student_id
            JOIN classrooms c ON cs.classroom_id = c.classroom_id
            JOIN schools sch ON c.school_id = sch.school_id
            WHERE sch.organization_id = $1
              AND DATE(sa.created_at) = $2
            """,
            org_id,
            yesterday
        )

        # è¨ˆç®—å¹³å‡å®Œæˆç‡
        avg_completion_rate = await db.fetchval(
            """
            WITH assignment_stats AS (
              SELECT
                a.assignment_id,
                COUNT(DISTINCT asub.submission_id) AS total_submissions,
                COUNT(DISTINCT CASE WHEN asub.status = 'passed' THEN asub.submission_id END) AS completed_submissions
              FROM assignments a
              JOIN classrooms c ON a.classroom_id = c.classroom_id
              JOIN schools s ON c.school_id = s.school_id
              LEFT JOIN assignment_submissions asub ON a.assignment_id = asub.assignment_id
              WHERE s.organization_id = $1
                AND a.created_at >= $2 - INTERVAL '30 days'
              GROUP BY a.assignment_id
            )
            SELECT AVG(
              CASE
                WHEN total_submissions > 0 THEN completed_submissions::NUMERIC / total_submissions * 100
                ELSE 0
              END
            )
            FROM assignment_stats
            """,
            org_id,
            yesterday
        )

        # å„²å­˜çµ±è¨ˆæ•¸æ“š
        await db.execute(
            """
            INSERT INTO organization_stats (
              organization_id,
              stat_date,
              total_schools,
              total_students,
              active_students_today,
              avg_completion_rate
            )
            VALUES ($1, $2, $3, $4, $5, $6)
            ON CONFLICT (organization_id, stat_date)
            DO UPDATE SET
              total_schools = EXCLUDED.total_schools,
              total_students = EXCLUDED.total_students,
              active_students_today = EXCLUDED.active_students_today,
              avg_completion_rate = EXCLUDED.avg_completion_rate,
              calculated_at = NOW()
            """,
            org_id,
            yesterday,
            total_schools,
            total_students,
            active_students_yesterday,
            avg_completion_rate or 0
        )
```

---

## ğŸ’° è¨‚é–±èˆ‡è¨ˆè²»ç®¡ç†

### è¨‚é–±è¡¨

```sql
CREATE TABLE subscriptions (
  subscription_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(org_id) ON DELETE CASCADE,

  -- æ–¹æ¡ˆ
  plan VARCHAR(20) CHECK (plan IN ('trial', 'basic', 'pro', 'enterprise')),

  -- æœŸé–“
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  auto_renew BOOLEAN DEFAULT true,

  -- é…é¡
  school_quota INT,           -- å­¸æ ¡æ•¸ä¸Šé™ï¼ˆNULL = ç„¡é™åˆ¶ï¼‰
  student_quota INT,          -- å­¸ç”Ÿæ•¸ä¸Šé™ï¼ˆNULL = ç„¡é™åˆ¶ï¼‰

  -- ç•¶å‰ä½¿ç”¨é‡
  current_school_count INT DEFAULT 0,
  current_student_count INT DEFAULT 0,

  -- ç‹€æ…‹
  status VARCHAR(20) CHECK (status IN ('active', 'suspended', 'expired', 'cancelled')),

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_subscriptions_org_id ON subscriptions(organization_id);
CREATE INDEX idx_subscriptions_status ON subscriptions(status);
```

---

### è¨ˆè²»è¨˜éŒ„è¡¨

```sql
CREATE TABLE billing_records (
  record_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  organization_id UUID REFERENCES organizations(org_id) ON DELETE CASCADE,
  subscription_id UUID REFERENCES subscriptions(subscription_id),

  -- è¨ˆè²»æœŸé–“
  billing_period_start DATE NOT NULL,
  billing_period_end DATE NOT NULL,

  -- è²»ç”¨
  base_fee NUMERIC(10,2) DEFAULT 0,      -- åŸºæœ¬è²»ç”¨
  overage_fee NUMERIC(10,2) DEFAULT 0,   -- è¶…é¡è²»ç”¨
  total_amount NUMERIC(10,2) NOT NULL,

  -- ä»˜æ¬¾
  paid_at TIMESTAMP,
  payment_method VARCHAR(50),
  invoice_url TEXT,

  -- ç‹€æ…‹
  status VARCHAR(20) CHECK (status IN ('pending', 'paid', 'overdue', 'cancelled')),

  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_billing_records_org_id ON billing_records(organization_id);
CREATE INDEX idx_billing_records_status ON billing_records(status);
```

---

### è¨‚é–±æ–¹æ¡ˆè¨­è¨ˆ

| æ–¹æ¡ˆ | é©ç”¨å°è±¡ | å­¸æ ¡æ•¸ä¸Šé™ | å­¸ç”Ÿæ•¸ä¸Šé™ | å¹´è²»ï¼ˆç¯„ä¾‹ï¼‰ | åŠŸèƒ½é™åˆ¶ |
|------|---------|-----------|-----------|------------|---------|
| **è©¦ç”¨ç‰ˆ** | è©•ä¼°æœŸ | 1 | 100 | å…è²» 30 å¤© | åŸºç¤åŠŸèƒ½ |
| **åŸºç¤ç‰ˆ** | å–®ä¸€å­¸æ ¡ | 1 | 500 | $30,000 | ç„¡éŠæˆ²åŒ–ã€ç„¡è¨ºæ–·è©•é‡ |
| **å°ˆæ¥­ç‰ˆ** | å°å‹æ©Ÿæ§‹ | 5 | 2,000 | $120,000 | å®Œæ•´åŠŸèƒ½ |
| **ä¼æ¥­ç‰ˆ** | å¤§å‹æ©Ÿæ§‹ | ç„¡é™åˆ¶ | ç„¡é™åˆ¶ | å®¢è£½åŒ–å ±åƒ¹ | å®Œæ•´åŠŸèƒ½ + å®¢è£½åŒ– |

---

### é…é¡æª¢æŸ¥

```sql
-- æª¢æŸ¥æ˜¯å¦è¶…éå­¸æ ¡æ•¸é…é¡
CREATE OR REPLACE FUNCTION check_school_quota(p_org_id UUID)
RETURNS BOOLEAN AS $$
DECLARE
  current_schools INT;
  school_quota INT;
BEGIN
  SELECT
    s.school_quota,
    s.current_school_count
  INTO school_quota, current_schools
  FROM subscriptions s
  WHERE s.organization_id = p_org_id
    AND s.status = 'active'
    AND s.end_date >= CURRENT_DATE
  ORDER BY s.end_date DESC
  LIMIT 1;

  -- NULL = ç„¡é™åˆ¶
  IF school_quota IS NULL THEN
    RETURN true;
  END IF;

  RETURN current_schools < school_quota;
END;
$$ LANGUAGE plpgsql;

-- ä½¿ç”¨ç¯„ä¾‹
SELECT check_school_quota('org_a_uuid');
```

---

### è¨ˆè²»è¨ˆç®—ï¼ˆæœˆçµï¼‰

```python
@celery.task
def calculate_monthly_billing():
    """æ¯æœˆ 1 è™ŸåŸ·è¡Œ"""
    last_month_start = date.today().replace(day=1) - timedelta(days=1)
    last_month_start = last_month_start.replace(day=1)
    last_month_end = date.today().replace(day=1) - timedelta(days=1)

    active_subs = await db.fetch(
        """
        SELECT * FROM subscriptions
        WHERE status = 'active'
          AND start_date <= $1
        """,
        last_month_end
    )

    for sub in active_subs:
        org_id = sub['organization_id']
        plan = sub['plan']

        # è¨ˆç®—å­¸ç”Ÿæ•¸
        student_count = await db.fetchval(
            """
            SELECT COUNT(DISTINCT s.student_id)
            FROM students s
            JOIN class_students cs ON s.student_id = cs.student_id
            JOIN classrooms c ON cs.classroom_id = c.classroom_id
            JOIN schools sch ON c.school_id = sch.school_id
            WHERE sch.organization_id = $1
            """,
            org_id
        )

        # è¨ˆç®—è²»ç”¨
        if plan == 'basic':
            base_fee = 30000
            overage_fee = 0
        elif plan == 'pro':
            base_fee = 120000
            # è¶…é 2000 äººï¼Œæ¯äºº $50
            if student_count > 2000:
                overage_fee = (student_count - 2000) * 50
            else:
                overage_fee = 0
        else:
            continue  # ä¼æ¥­ç‰ˆå®¢è£½åŒ–

        total = base_fee + overage_fee

        # å»ºç«‹å¸³å–®
        await db.execute(
            """
            INSERT INTO billing_records (
              organization_id,
              subscription_id,
              billing_period_start,
              billing_period_end,
              base_fee,
              overage_fee,
              total_amount,
              status
            )
            VALUES ($1, $2, $3, $4, $5, $6, $7, 'pending')
            """,
            org_id,
            sub['subscription_id'],
            last_month_start,
            last_month_end,
            base_fee,
            overage_fee,
            total
        )
```

---

## ğŸ” æŸ¥è©¢éæ¿¾ç­–ç•¥ç¸½çµ

### æ‡‰ç”¨å±¤éæ¿¾ï¼ˆMiddlewareï¼‰

```python
# æ‰€æœ‰æŸ¥è©¢éƒ½å¸¶ä¸Šç§Ÿæˆ¶éæ¿¾
def build_org_filter(user: User) -> str:
    if user.role == 'platform_admin':
        return ""  # ç„¡éæ¿¾
    elif user.role == 'org_admin':
        return f"AND organization_id = '{user.organization_id}'"
    elif user.role == 'school_admin':
        return f"AND school_id = '{user.school_id}'"
    else:
        raise ValueError("Invalid role")

# ä½¿ç”¨ç¯„ä¾‹
@app.get("/api/courses")
async def list_courses(current_user: User = Depends(get_current_user)):
    org_filter = build_org_filter(current_user)

    query = f"""
        SELECT * FROM courses
        WHERE 1=1
          {org_filter}
          OR organization_id IS NULL  -- å®˜æ–¹èª²ç¨‹
        ORDER BY created_at DESC
    """

    return await db.fetch(query)
```

---

### è³‡æ–™åº«å±¤é˜²è­·ï¼ˆRLSï¼‰

å³ä½¿æ‡‰ç”¨å±¤è¢«ç¹éï¼ˆSQL æ³¨å…¥ï¼‰ï¼ŒRLS ä»æœƒç”Ÿæ•ˆï¼š

```sql
-- æ°¸é å¼·åˆ¶æª¢æŸ¥ organization_id
CREATE POLICY enforce_org_isolation ON courses
  FOR ALL
  USING (
    organization_id = current_setting('app.current_org_id')::uuid
    OR organization_id IS NULL
  );
```

---

### å¯©è¨ˆè¨˜éŒ„

```sql
-- è¨˜éŒ„æ‰€æœ‰æ•æ„Ÿæ“ä½œ
CREATE TABLE audit_logs (
  log_id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID,
  action VARCHAR(50),
  resource_type VARCHAR(50),
  resource_id UUID,
  organization_id UUID,
  ip_address INET,
  user_agent TEXT,
  success BOOLEAN,
  error_message TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at DESC);
```

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [README.md](./README.md) - æ¶æ§‹ç¸½è¦½
- [01-å¹³å°å±¤ç´šè¨­è¨ˆ.md](./01-å¹³å°å±¤ç´šè¨­è¨ˆ.md) - å¤šç§Ÿæˆ¶æ¶æ§‹è¨­è¨ˆ
- [02-Schemaè¨­è¨ˆå“²å­¸.md](./02-Schemaè¨­è¨ˆå“²å­¸.md) - è³‡æ–™åº«è¨­è¨ˆ
- [03-èª²ç¨‹çµæ§‹è¨­è¨ˆ.md](./03-èª²ç¨‹çµæ§‹è¨­è¨ˆ.md) - æ¥­å‹™é‚è¼¯

---

**æ–‡ä»¶ç”¨é€”**ï¼š
æ­¤æ–‡ä»¶å®šç¾©å¤šç§Ÿæˆ¶æ¶æ§‹çš„æŠ€è¡“å¯¦ä½œç´°ç¯€ï¼ŒåŒ…å« RLS è¨­è¨ˆã€æ¬Šé™ç®¡ç†ã€çµ±è¨ˆåˆ†æç­‰é—œéµæŠ€è¡“ã€‚æ‰€æœ‰æ¶‰åŠè³‡æ–™éš”é›¢èˆ‡æ¬Šé™æ§åˆ¶çš„é–‹ç™¼éƒ½å¿…é ˆéµå¾ªæ­¤æ–‡ä»¶ã€‚
