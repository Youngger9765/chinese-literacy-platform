# èª²ç¨‹çµæ§‹è¨­è¨ˆï¼ˆæ¥­å‹™é‚è¼¯æ ¸å¿ƒï¼‰

> è¨˜éŒ„æ—¥æœŸï¼š2026-02-13
> ä¾†æºï¼šBUSINESS_LOGIC_DECISIONS.md å•é¡Œ 1-5
> é—œéµæ€§ï¼šâ­â­â­â­â­ï¼ˆæ¥­å‹™é‚è¼¯åŸºç¤ï¼‰

---

## ğŸ“‹ æ ¸å¿ƒæ±ºç­–ç¸½è¦½

æœ¬æ–‡ä»¶è¨˜éŒ„ 5 å€‹é—œéµæ¥­å‹™é‚è¼¯æ±ºç­–ï¼š

| æ±ºç­– | å•é¡Œ | æ–¹æ¡ˆ | å½±éŸ¿ |
|------|------|------|------|
| **æ±ºç­– 1** | å­¸ç”Ÿè‡ªå­¸æ¨¡å¼ | æ··åˆæ¨¡å¼ï¼ˆç­ç´šä½œæ¥­ + è‡ªå­¸ï¼‰ | å…©æ¢å­¸ç¿’è·¯å¾‘ |
| **æ±ºç­– 2** | èª²ç¨‹æ›´æ–°æ©Ÿåˆ¶ | åƒç…§æ©Ÿåˆ¶ + å¯é¸åŒæ­¥ | ç‰ˆæœ¬è¿½è¹¤ç³»çµ± |
| **æ±ºç­– 3** | è€å¸«é–“åˆ†äº« | ç›´æ¥è¤‡è£½ï¼ˆç¨ç«‹ï¼‰ | åˆ†äº«åŠŸèƒ½ |
| **æ±ºç­– 4** | èª²ç¨‹ vs ä½œæ¥­ | ä½œæ¥­æ˜¯èª²ç¨‹å­é›† | æ¨¡çµ„é¸å–æ©Ÿåˆ¶ |
| **æ±ºç­– 5** | çŸ¥è­˜æ¨¹çµæ§‹ | Notion-like éšå±¤æ¨¹ | category + prerequisite |

---

## ğŸ¯ æ±ºç­– 1ï¼šå­¸ç”Ÿè‡ªå­¸æ¨¡å¼

### å•é¡Œæè¿°

å­¸ç”Ÿæƒ³è‡ªå­¸æ™‚ï¼Œç³»çµ±æ‡‰è©²å¦‚ä½•é‹ä½œï¼Ÿæ˜¯å¦éœ€è¦è€å¸«ï¼Ÿ

---

### é¸é …å°æ¯”

#### A. å®Œå…¨é–‹æ”¾è‡ªå­¸
- å­¸ç”Ÿå¯ä»¥ç›´æ¥ç€è¦½ã€Œå®˜æ–¹èª²ç¨‹ã€
- è¤‡è£½åˆ°è‡ªå·±çš„å­¸ç¿’æ¸…å–®
- AI è‡ªå‹•æ‰¹æ”¹
- ä¸éœ€è¦è€å¸«

**å„ªé»**ï¼šå®Œå…¨è‡ªä¸»å­¸ç¿’
**ç¼ºé»**ï¼šè€å¸«ç„¡æ³•æŒæ¡é€²åº¦

---

#### B. åƒ…é™ç­ç´šå…§å­¸ç¿’
- å­¸ç”Ÿåªèƒ½å­¸è‡ªå·±ç­ä¸Šè€å¸«æ´¾ç™¼çš„èª²ç¨‹
- å¿…é ˆæœ‰è€å¸«
- ä¸èƒ½è¶…å‰é€²åº¦

**å„ªé»**ï¼šè€å¸«å®Œå…¨æŒæ§
**ç¼ºé»**ï¼šé™åˆ¶å­¸ç”Ÿè‡ªä¸»æ€§

---

#### C. æ··åˆæ¨¡å¼ âœ…
- **ç­ç´šå…§**ï¼šè€å¸«æŒ‡æ´¾çš„ä½œæ¥­ï¼ˆå¿…åšï¼‰
- **è‡ªå­¸å€**ï¼šå­¸ç”Ÿå¯ä»¥ç€è¦½å®˜æ–¹èª²ç¨‹è‡ªå­¸ï¼ˆé¸åšï¼‰

**å„ªé»**ï¼šå…¼é¡§ç­ç´šç®¡ç†èˆ‡è‡ªä¸»å­¸ç¿’
**ç¼ºé»**ï¼šç³»çµ±éœ€æ”¯æ´å…©æ¢è·¯å¾‘

---

### âœ… æœ€çµ‚æ±ºç­–ï¼šæ··åˆæ¨¡å¼

**ç†ç”±**ï¼š
- âœ… å…¼é¡§ç­ç´šç®¡ç†èˆ‡è‡ªä¸»å­¸ç¿’
- âœ… è€å¸«å¯ä»¥æŒæ¡å¿…åšä½œæ¥­çš„é€²åº¦
- âœ… å­¸ç”Ÿæœ‰ç©ºé–“è‡ªä¸»æ¢ç´¢å­¸ç¿’å…§å®¹
- âœ… ç¬¦åˆæ•™è‚²è¶¨å‹¢ï¼ˆç¿»è½‰æ•™è‚²ã€è‡ªä¸»å­¸ç¿’ï¼‰

---

### å¯¦ä½œå½±éŸ¿

#### å…©å¥—å­¸ç¿’è·¯å¾‘

```sql
-- å­¸ç”Ÿæ´»å‹•è¡¨
student_activities:
  - activity_id
  - student_id
  - course_node_id
  - teacher_assigned BOOLEAN  â† é—œéµæ¬„ä½
  - assignment_id (nullable, è‹¥ä¾†è‡ªä½œæ¥­å‰‡å¡«å…¥)
  - completed
  - score
  - created_at
```

**è·¯å¾‘ 1ï¼šç­ç´šä½œæ¥­è·¯å¾‘**
```
è€å¸«æ´¾ç™¼ä½œæ¥­ (assignment_id = X, teacher_assigned = true)
    â†“
å­¸ç”Ÿå®Œæˆä½œæ¥­
    â†“
è€å¸«/AI æ‰¹æ”¹
    â†“
è¨ˆå…¥ç­ç´šæˆç¸¾
```

**è·¯å¾‘ 2ï¼šè‡ªå­¸è·¯å¾‘**
```
å­¸ç”Ÿç€è¦½å®˜æ–¹èª²ç¨‹ (teacher_assigned = false)
    â†“
å­¸ç”Ÿè‡ªå·±é¸æ“‡å­¸ç¿’
    â†“
AI è‡ªå‹•æ‰¹æ”¹
    â†“
è¨ˆå…¥å€‹äººå­¸ç¿’æ­·ç¨‹ï¼ˆä¸è¨ˆå…¥ç­ç´šæˆç¸¾ï¼‰
```

---

#### UI è¨­è¨ˆå½±éŸ¿

**å­¸ç”Ÿä»‹é¢éœ€è¦å€åˆ†**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆ‘çš„å­¸ç¿’                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“š ç­ç´šä½œæ¥­ (3 å€‹æœªå®Œæˆ) â”‚
â”‚    - ç¬¬ä¸€èª²æœ—è®€ç·´ç¿’       â”‚
â”‚    - ç”Ÿå­—ç­†é †ç·´ç¿’         â”‚
â”‚    - èª²æ–‡ç†è§£æ¸¬é©—         â”‚
â”‚                         â”‚
â”‚  ğŸ¯ æˆ‘çš„è‡ªå­¸ (é€²è¡Œä¸­)     â”‚
â”‚    - æˆèªæ•…äº‹é–±è®€         â”‚
â”‚    - é€²éšèªæ³•ç·´ç¿’         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### è€å¸«æª¢è¦–æ¬Šé™

```sql
-- è€å¸«æŸ¥çœ‹ç­ç´šä½œæ¥­é€²åº¦ï¼ˆå¯è¦‹ï¼‰
SELECT * FROM student_activities
WHERE assignment_id IN (
  SELECT assignment_id FROM assignments WHERE teacher_id = :teacher_id
)
AND teacher_assigned = true;

-- è€å¸«æŸ¥çœ‹å­¸ç”Ÿè‡ªå­¸æ´»å‹•ï¼ˆå¯è¦‹ï¼Œä½†ä¸å½±éŸ¿æˆç¸¾ï¼‰
SELECT * FROM student_activities
WHERE student_id IN (
  SELECT student_id FROM class_students WHERE classroom_id = :classroom_id
)
AND teacher_assigned = false;
```

---

## ğŸ”„ æ±ºç­– 2ï¼šèª²ç¨‹æ›´æ–°æ©Ÿåˆ¶

### å•é¡Œæè¿°

ç•¶å®˜æ–¹èª²ç¨‹æ›´æ–°æ™‚ï¼ˆä¾‹å¦‚ä¿®æ­£éŒ¯å­—ï¼‰ï¼Œæ ¡ç´šèª²ç¨‹æˆ–ç­ç´šèª²ç¨‹æ‡‰è©²å¦‚ä½•è™•ç†ï¼Ÿ

---

### é¸é …å°æ¯”

#### A. å®Œå…¨è¤‡è£½ï¼Œå„è‡ªç¨ç«‹
- æ ¡ç´š/ç­ç´šèª²ç¨‹è¤‡è£½å¾Œå®Œå…¨ç¨ç«‹
- å®˜æ–¹æ›´æ–°ä¸æœƒè‡ªå‹•å½±éŸ¿ä¸‹å±¤
- è€å¸«éœ€è¦æ‰‹å‹•é‡æ–°è¤‡è£½æ–°ç‰ˆæœ¬

**å„ªé»**ï¼šç©©å®šä¸è¢«å½±éŸ¿
**ç¼ºé»**ï¼šéŒ¯èª¤ä¸æœƒè‡ªå‹•ä¿®æ­£

---

#### B. åƒç…§æ©Ÿåˆ¶ï¼Œå¯é¸æ“‡åŒæ­¥ âœ…
- ç³»çµ±é¡¯ç¤ºæç¤ºã€Œå®˜æ–¹å·²æ›´æ–°è‡³ v1.1ï¼Œæ˜¯å¦åŒæ­¥ï¼Ÿã€
- è€å¸«å¯ä»¥é¸æ“‡è¦ä¸è¦æ›´æ–°
- ä¿ç•™ç‰ˆæœ¬è¿½è¹¤

**å„ªé»**ï¼šå¯è¿½è¹¤æ›´æ–°ã€ä¿ç•™è‡ªä¸»æ¬Š
**ç¼ºé»**ï¼šå¯¦ä½œè¼ƒè¤‡é›œ

---

### âœ… æœ€çµ‚æ±ºç­–ï¼šåƒç…§æ©Ÿåˆ¶ + å¯é¸åŒæ­¥

**ç†ç”±**ï¼š
- âœ… å®˜æ–¹èª²ç¨‹ä¿®æ­£éŒ¯èª¤æ™‚ï¼Œå­¸æ ¡å¯ä»¥é¸æ“‡åŒæ­¥
- âœ… ä¿ç•™è€å¸«çš„è‡ªä¸»æ¬Šï¼ˆå¯é¸æ“‡ä¸åŒæ­¥ï¼‰
- âœ… æä¾›ç‰ˆæœ¬è¿½è¹¤æ©Ÿåˆ¶
- âœ… é•·æœŸç¶­è­·è¼ƒå‹å–„ï¼ˆéŒ¯èª¤å¯ä»¥è¢«ä¿®æ­£ï¼‰

---

### å¯¦ä½œå½±éŸ¿

#### ç‰ˆæœ¬è¿½è¹¤æ¬„ä½

```sql
course_nodes:
  - node_id
  - source_template_id UUID  â† ä¾†æºèª²ç¨‹ ID
  - source_version INT       â† è¤‡è£½æ™‚çš„ç‰ˆæœ¬
  - current_version INT      â† ç•¶å‰ç‰ˆæœ¬
  - last_sync_at TIMESTAMP   â† æœ€å¾ŒåŒæ­¥æ™‚é–“
```

---

#### è¤‡è£½æµç¨‹

```
å®˜æ–¹èª²ç¨‹ (node_id = A, current_version = 2)
    â†“ è€å¸«è¤‡è£½
ç­ç´šèª²ç¨‹ (
  node_id = B,
  source_template_id = A,
  source_version = 2,  â† è¤‡è£½æ™‚ç‰ˆæœ¬
  current_version = 1   â† è‡ªå·±çš„ç‰ˆæœ¬
)
```

---

#### æ›´æ–°æª¢æ¸¬

```sql
-- æª¢æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
SELECT
  cn.node_id,
  cn.source_template_id,
  cn.source_version AS copied_version,
  source.current_version AS latest_version,
  (source.current_version > cn.source_version) AS has_update
FROM course_nodes cn
JOIN course_nodes source ON cn.source_template_id = source.node_id
WHERE cn.classroom_id = :classroom_id
  AND source.current_version > cn.source_version;
```

---

#### åŒæ­¥ UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  èª²ç¨‹æ›´æ–°é€šçŸ¥                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“¦ ç¬¬ä¸€èª²ï¼šæˆ‘çš„å®¶                  â”‚
â”‚     å®˜æ–¹å·²æ›´æ–°è‡³ v1.2               â”‚
â”‚     ä½ çš„ç‰ˆæœ¬ï¼šv1.0                  â”‚
â”‚                                    â”‚
â”‚  æ›´æ–°å…§å®¹ï¼š                         â”‚
â”‚  - ä¿®æ­£éŒ¯å­—ã€Œå­¸æ ¡ã€â†’ã€Œå­¸æ ¡ã€         â”‚
â”‚  - æ–°å¢æœ—è®€ç¤ºç¯„éŸ³æª”                 â”‚
â”‚                                    â”‚
â”‚  âš ï¸ æ³¨æ„ï¼šä½ å·²ç¶“ä¿®æ”¹éæ­¤èª²ç¨‹å…§å®¹     â”‚
â”‚           åŒæ­¥å°‡è¦†è“‹ä½ çš„ä¿®æ”¹         â”‚
â”‚                                    â”‚
â”‚  [æŸ¥çœ‹å·®ç•°] [åŒæ­¥æ›´æ–°] [ä¿æŒç¾ç‹€]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### åŒæ­¥é‚è¼¯

```sql
-- åŒæ­¥èª²ç¨‹æ›´æ–°ï¼ˆè¦†è“‹æ¨¡å¼ï¼‰
UPDATE course_nodes
SET
  metadata = source.metadata,
  source_version = source.current_version,
  last_sync_at = NOW(),
  updated_at = NOW()
FROM course_nodes source
WHERE course_nodes.source_template_id = source.node_id
  AND course_nodes.node_id = :target_node_id;
```

---

## ğŸ¤ æ±ºç­– 3ï¼šè€å¸«é–“åˆ†äº«

### å•é¡Œæè¿°

ç‹è€å¸«è¨­è¨ˆäº†ä¸€å€‹å¾ˆæ£’çš„ç­ç´šèª²ç¨‹ï¼Œæè€å¸«æƒ³ç”¨ï¼Œæ‡‰è©²å¦‚ä½•åˆ†äº«ï¼Ÿ

---

### é¸é …å°æ¯”

#### A. ç›´æ¥è¤‡è£½ âœ…
- ç‹è€å¸«ç­ç´šèª²ç¨‹ â†’ æè€å¸«è¤‡è£½ â†’ æè€å¸«ç­ç´šèª²ç¨‹
- å…©ä»½å¾ŒçºŒå®Œå…¨ç¨ç«‹
- ç­ç´šå°ç­ç´šç›´æ¥è¤‡è£½

**å„ªé»**ï¼šç°¡å–®ç›´æ¥ã€å½ˆæ€§é«˜
**ç¼ºé»**ï¼šç„¡å”ä½œåŠŸèƒ½

---

#### B. ç™¼å¸ƒåˆ°æ ¡ç´š
- ç‹è€å¸«å…ˆå°‡èª²ç¨‹ç™¼å¸ƒåˆ°ã€Œæ ¡ç´šèª²ç¨‹åº«ã€
- æè€å¸«å¾æ ¡ç´šèª²ç¨‹è¤‡è£½
- é€éæ ¡ç´šç•¶ä¸­ä»‹

**å„ªé»**ï¼šé›†ä¸­ç®¡ç†
**ç¼ºé»**ï¼šéœ€è¦å¯©æ ¸æµç¨‹

---

#### C. å”ä½œæ¨¡å¼
- ç‹è€å¸«ã€æè€å¸«å…±åŒç·¨è¼¯åŒä¸€ä»½èª²ç¨‹
- å…©å€‹ç­ç´šéƒ½ä½¿ç”¨åŒä¸€ä»½èª²ç¨‹

**å„ªé»**ï¼šåŒæ­¥æ›´æ–°
**ç¼ºé»**ï¼šå®¹æ˜“è¡çª

---

### âœ… æœ€çµ‚æ±ºç­–ï¼šç›´æ¥è¤‡è£½

**ç†ç”±**ï¼š
- âœ… æœ€ç°¡å–®ç›´æ¥çš„æ–¹å¼
- âœ… å…©ä½è€å¸«çš„ç­ç´šæƒ…æ³ä¸åŒï¼Œè¤‡è£½å¾Œå„è‡ªèª¿æ•´æ›´å½ˆæ€§
- âœ… é¿å…å”ä½œè¡çªï¼ˆä¸åŒè€å¸«æ•™å­¸é¢¨æ ¼ä¸åŒï¼‰
- âœ… æ¸›å°‘æ ¡ç´šèª²ç¨‹åº«çš„ç®¡ç†è² æ“”

---

### å¯¦ä½œå½±éŸ¿

#### åˆ†äº«åŠŸèƒ½

```sql
-- ç”¢ç”Ÿåˆ†äº«é€£çµ
INSERT INTO course_share_links (
  node_id,
  created_by,
  share_token,
  expires_at
) VALUES (
  :node_id,
  :teacher_id,
  gen_random_uuid(),
  NOW() + INTERVAL '7 days'
);
```

**åˆ†äº« UI**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ†äº«èª²ç¨‹                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  èª²ç¨‹ï¼šç¬¬ä¸€èª²å®Œæ•´æ•™æ¡ˆ               â”‚
â”‚                                    â”‚
â”‚  åˆ†äº«æ–¹å¼ï¼š                         â”‚
â”‚  â—‹ æ ¡å…§æ•™å¸«å¯è¦‹                     â”‚
â”‚  â—‹ ç”¢ç”Ÿåˆ†äº«é€£çµï¼ˆ7 å¤©æœ‰æ•ˆï¼‰          â”‚
â”‚                                    â”‚
â”‚  [ç”¢ç”Ÿé€£çµ]                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

#### è¤‡è£½é‚è¼¯

```sql
-- è¤‡è£½èª²ç¨‹ç¯€é»ï¼ˆéè¿´è¤‡è£½å­ç¯€é»ï¼‰
CREATE OR REPLACE FUNCTION copy_course_node(
  source_node_id UUID,
  target_org_id UUID,
  target_school_id UUID,
  target_classroom_id UUID,
  new_parent_id UUID DEFAULT NULL
)
RETURNS UUID AS $$
DECLARE
  new_node_id UUID;
  child_node RECORD;
BEGIN
  -- è¤‡è£½ç•¶å‰ç¯€é»
  INSERT INTO course_nodes (
    organization_id,
    school_id,
    classroom_id,
    parent_id,
    node_type,
    node_subtype,
    metadata,
    source_template_id,
    source_version
  )
  SELECT
    target_org_id,
    target_school_id,
    target_classroom_id,
    new_parent_id,
    node_type,
    node_subtype,
    metadata,
    node_id,  -- è¨˜éŒ„ä¾†æº
    current_version
  FROM course_nodes
  WHERE node_id = source_node_id
  RETURNING node_id INTO new_node_id;

  -- éè¿´è¤‡è£½å­ç¯€é»
  FOR child_node IN
    SELECT node_id FROM course_nodes WHERE parent_id = source_node_id
  LOOP
    PERFORM copy_course_node(
      child_node.node_id,
      target_org_id,
      target_school_id,
      target_classroom_id,
      new_node_id
    );
  END LOOP;

  RETURN new_node_id;
END;
$$ LANGUAGE plpgsql;
```

---

## ğŸ“š æ±ºç­– 4ï¼šèª²ç¨‹ vs ä½œæ¥­

### å•é¡Œæè¿°

ã€Œèª²ç¨‹ã€èˆ‡ã€Œä½œæ¥­ã€çš„é—œä¿‚æ˜¯ä»€éº¼ï¼Ÿ

---

### é¸é …å°æ¯”

#### A. ä½œæ¥­æ˜¯èª²ç¨‹çš„å­é›† âœ…
- èª²ç¨‹åŒ…å«ï¼šèª²æ–‡ã€ç”Ÿå­—ã€æœ—è®€ã€ç­†é †ã€é–±è®€ç†è§£ç­‰å¤šå€‹æ¨¡çµ„
- ä½œæ¥­ï¼šè€å¸«å¾èª²ç¨‹ä¸­é¸å–éƒ¨åˆ†æ¨¡çµ„æ´¾ç™¼
- ä¾‹å¦‚ï¼šä½œæ¥­ 1 åªæœ‰æœ—è®€ï¼Œä½œæ¥­ 2 åªæœ‰ç­†é †
- ä¸€å€‹èª²ç¨‹å¯ä»¥ç”¢ç”Ÿå¤šå€‹ä¸åŒçš„ä½œæ¥­

**å„ªé»**ï¼šå½ˆæ€§é«˜ã€æ”¯æ´åˆ†å±¤æ•™å­¸
**ç¼ºé»**ï¼šå¯¦ä½œè¼ƒè¤‡é›œ

---

#### B. èª²ç¨‹ = ä½œæ¥­
- èª²ç¨‹å°±æ˜¯ä½œæ¥­
- è€å¸«æ´¾ç™¼æ•´ä»½èª²ç¨‹çµ¦å­¸ç”Ÿ
- å­¸ç”Ÿè¦å®Œæˆæ‰€æœ‰æ¨¡çµ„

**å„ªé»**ï¼šç°¡å–®ç›´æ¥
**ç¼ºé»**ï¼šç¼ºä¹å½ˆæ€§

---

### âœ… æœ€çµ‚æ±ºç­–ï¼šä½œæ¥­æ˜¯èª²ç¨‹çš„å­é›†

**ç†ç”±**ï¼š
- âœ… æ›´éˆæ´»ï¼šè€å¸«å¯ä»¥æ ¹æ“šå­¸ç”Ÿç¨‹åº¦èª¿æ•´ä½œæ¥­å…§å®¹
- âœ… ç¬¦åˆçœŸå¯¦æ•™å­¸æƒ…å¢ƒï¼š
  - ä»Šå¤©åªç·´æœ—è®€
  - æ˜å¤©åªç·´ç”Ÿå­—
  - å¾Œå¤©åšé–±è®€ç†è§£
- âœ… æ”¯æ´åˆ†å±¤æ•™å­¸ï¼š
  - é€²åº¦å¿«çš„å­¸ç”Ÿåšå®Œæ•´ä½œæ¥­
  - é€²åº¦æ…¢çš„å­¸ç”Ÿåªåšéƒ¨åˆ†æ¨¡çµ„
- âœ… ä¸€å€‹èª²ç¨‹å¯ä»¥é‡è¤‡ä½¿ç”¨ï¼Œç”¢ç”Ÿä¸åŒä½œæ¥­

---

### å¯¦ä½œå½±éŸ¿

#### èª²ç¨‹çµæ§‹

```
èª²ç¨‹ï¼ˆCourseï¼‰
  â”œâ”€ æ¨¡çµ„ 1ï¼šæœ—è®€ç·´ç¿’ï¼ˆModuleï¼‰
  â”œâ”€ æ¨¡çµ„ 2ï¼šç”Ÿå­—å­¸ç¿’ï¼ˆModuleï¼‰
  â”œâ”€ æ¨¡çµ„ 3ï¼šç­†é †ç·´ç¿’ï¼ˆModuleï¼‰
  â”œâ”€ æ¨¡çµ„ 4ï¼šè©èªæ‡‰ç”¨ï¼ˆModuleï¼‰
  â””â”€ æ¨¡çµ„ 5ï¼šé–±è®€ç†è§£ï¼ˆModuleï¼‰
```

---

#### ä½œæ¥­çµæ§‹

```sql
-- ä½œæ¥­è¡¨
assignments:
  - assignment_id
  - teacher_id
  - classroom_id
  - course_node_id  â† é—œè¯åˆ°èª²ç¨‹
  - title
  - instructions
  - due_date
  - required_accuracy
  - created_at

-- ä½œæ¥­é¸å–çš„æ¨¡çµ„
assignment_modules:
  - assignment_id
  - module_node_id  â† é¸å–çš„æ¨¡çµ„
  - display_order
```

**ä½œæ¥­ 1**ï¼ˆåªæœ‰æœ—è®€ï¼‰ï¼š
```sql
INSERT INTO assignments (...) VALUES (...);
INSERT INTO assignment_modules (assignment_id, module_node_id)
VALUES (:assignment_id, :module_1_reading);
```

**ä½œæ¥­ 2**ï¼ˆæœ—è®€ + ç”Ÿå­—ï¼‰ï¼š
```sql
INSERT INTO assignments (...) VALUES (...);
INSERT INTO assignment_modules (assignment_id, module_node_id)
VALUES
  (:assignment_id, :module_1_reading),
  (:assignment_id, :module_2_vocabulary);
```

---

#### é€²åº¦è¨ˆç®—

```sql
-- è¨ˆç®—ä½œæ¥­å®Œæˆé€²åº¦
SELECT
  a.assignment_id,
  a.title,
  COUNT(am.module_node_id) AS total_modules,
  COUNT(sa.activity_id) AS completed_modules,
  ROUND(
    COUNT(sa.activity_id)::NUMERIC / COUNT(am.module_node_id) * 100,
    2
  ) AS completion_percentage
FROM assignments a
JOIN assignment_modules am ON a.assignment_id = am.assignment_id
LEFT JOIN student_activities sa ON
  sa.student_id = :student_id
  AND sa.assignment_id = a.assignment_id
  AND sa.course_node_id = am.module_node_id
  AND sa.completed = true
WHERE a.assignment_id = :assignment_id
GROUP BY a.assignment_id, a.title;
```

---

## ğŸŒ² æ±ºç­– 5ï¼šçŸ¥è­˜æ¨¹/èª²ç¨‹çµæ§‹è¨­è¨ˆ

### å•é¡Œæè¿°

èª²ç¨‹éœ€è¦æœ‰çŸ¥è­˜åœ–è­œ/çŸ¥è­˜æ¨¹å±•é–‹ï¼Œå±¤æ¬¡æ€éº¼è¨­è¨ˆï¼Ÿ

---

### å­å•é¡Œ Aï¼šç¯€é»é¡å‹

**é¸é … 1**ï¼šèª²ç¨‹æœ¬èº«å°±æ˜¯ç¯€é»
**é¸é … 2**ï¼šçŸ¥è­˜é»/èƒ½åŠ›æ˜¯ç¯€é»ï¼Œèª²ç¨‹æ›åœ¨ä¸‹é¢
**é¸é … 3**ï¼šèª²ç¨‹å…§å®¹ï¼ˆç”Ÿå­—ã€è©èªï¼‰æ˜¯ç¯€é»

**âœ… æ±ºç­–**ï¼šç« ç¯€é—œä¿‚ï¼ˆå¯è‡ªç”±ç·¨æ’ï¼‰- Notion-like

**ç‰¹é»**ï¼š
- ç¯€é»æ˜¯èª²ç¨‹çš„çµ„ç¹”çµæ§‹ï¼ˆé¡ä¼¼ Notion çš„ page hierarchyï¼‰
- å¯ä»¥è‡ªç”±æ‹–æ›³èª¿æ•´é †åºå’Œå±¤ç´š
- é¡ä¼¼ç›®éŒ„ã€ç« ç¯€çš„æ¦‚å¿µ

**ç¯„ä¾‹**ï¼š
```
åœ‹å°äºŒå¹´ç´šåœ‹èª
  â”œâ”€ å–®å…ƒä¸€ï¼šæˆ‘çš„å®¶äºº
  â”‚    â”œâ”€ ç¬¬ä¸€èª²ï¼šæˆ‘çš„å®¶
  â”‚    â”œâ”€ ç¬¬äºŒèª²ï¼šçˆ¸çˆ¸åª½åª½
  â”‚    â””â”€ å–®å…ƒæ¸¬é©—
  â”‚
  â”œâ”€ å–®å…ƒäºŒï¼šå­¸æ ¡ç”Ÿæ´»
  â”‚    â”œâ”€ ç¬¬ä¸‰èª²ï¼šä¸Šå­¸å»
  â”‚    â””â”€ ç¬¬å››èª²ï¼šæˆ‘çš„åŒå­¸
  â”‚
  â””â”€ æœŸæœ«ç¸½è¤‡ç¿’
```

---

### å­å•é¡Œ Bï¼šå±¤æ¬¡é—œä¿‚

**é¸é … 1**ï¼šå­¸ç¿’é †åºï¼ˆprerequisiteï¼‰
**é¸é … 2**ï¼šåˆ†é¡éšå±¤ï¼ˆcategoryï¼‰
**é¸é … 3**ï¼šæ··åˆæ¨¡å¼

**âœ… æ±ºç­–**ï¼šå­¸ç¿’é †åº + åˆ†é¡éšå±¤éƒ½æ”¯æ´

**ç‰¹é»**ï¼š
- æ¯å€‹ç¯€é»å¯ä»¥æ˜¯ã€Œå­¸ç¿’é †åºã€æˆ–ã€Œåˆ†é¡éšå±¤ã€
- ç”±ç·¨è¼¯è‡ªå·±æ±ºå®š
- è§£é–æ©Ÿåˆ¶ã€éŠæˆ²åŒ–å¦å¤–ç¨ç«‹åŠŸèƒ½ï¼ˆä¸ç¶åœ¨æ ¸å¿ƒ schemaï¼‰

---

### å¯¦ä½œå½±éŸ¿

#### node_subtype æ¬„ä½

```sql
course_nodes:
  - node_subtype VARCHAR(20)
    -- 'category': åˆ†é¡éšå±¤ï¼ˆè³‡æ–™å¤¾æ¦‚å¿µï¼‰
    -- 'prerequisite': å­¸ç¿’é †åºï¼ˆå¿…é ˆå…ˆå®Œæˆå‰ç½®ï¼‰
    -- NULL: ä¸€èˆ¬ç¯€é»
```

---

#### å­¸ç¿’é †åºç¯„ä¾‹

```
æ³¨éŸ³ç¬¦è™ŸåŸºç¤ (category)
  â”œâ”€ è²æ¯ç·´ç¿’ (prerequisite, prerequisites: [])
  â”‚     â†“ å¿…é ˆå…ˆå®Œæˆ
  â”œâ”€ éŸ»æ¯ç·´ç¿’ (prerequisite, prerequisites: [è²æ¯ç·´ç¿’])
  â”‚     â†“ å¿…é ˆå…ˆå®Œæˆ
  â””â”€ æ‹¼éŸ³ç·´ç¿’ (prerequisite, prerequisites: [éŸ»æ¯ç·´ç¿’])
```

**metadata ç¯„ä¾‹**ï¼š
```json
{
  "title": "éŸ»æ¯ç·´ç¿’",
  "node_subtype": "prerequisite",
  "prerequisites": ["node_abc_å£°æ¯ç»ƒç¿’"],
  "unlock_condition": "all_prerequisites_completed"
}
```

---

#### åˆ†é¡éšå±¤ç¯„ä¾‹

```
åœ‹å°äºŒå¹´ç´šåœ‹èª (category)
  â”œâ”€ å–®å…ƒä¸€ (category)
  â”‚    â”œâ”€ ç¬¬ä¸€èª² (node)
  â”‚    â””â”€ ç¬¬äºŒèª² (node)
  â”œâ”€ å–®å…ƒäºŒ (category)
  â”‚    â”œâ”€ ç¬¬ä¸‰èª² (node)
  â”‚    â””â”€ ç¬¬å››èª² (node)
  â””â”€ å–®å…ƒä¸‰ (category)
```

---

#### æ··åˆç¯„ä¾‹

```
åœ‹å°ä¸€å¹´ç´š (category)
  â””â”€ æ³¨éŸ³ç¬¦è™Ÿ (category)
       â”œâ”€ ã„… (prerequisite)
       â”‚   â†“ å®Œæˆå¾Œè§£é–
       â”œâ”€ ã„† (prerequisite, prerequisites: [ã„…])
       â”‚   â†“ å®Œæˆå¾Œè§£é–
       â””â”€ ã„‡ (prerequisite, prerequisites: [ã„†])
```

---

#### è§£é–é‚è¼¯

```sql
-- æª¢æŸ¥ç¯€é»æ˜¯å¦å·²è§£é–
CREATE OR REPLACE FUNCTION is_node_unlocked(
  p_student_id UUID,
  p_node_id UUID
)
RETURNS BOOLEAN AS $$
DECLARE
  node_prerequisites JSONB;
  prerequisite_id TEXT;
  all_completed BOOLEAN := true;
BEGIN
  -- å–å¾—å…ˆä¿®è¦æ±‚
  SELECT metadata->'prerequisites' INTO node_prerequisites
  FROM course_nodes
  WHERE node_id = p_node_id;

  -- å¦‚æœæ²’æœ‰å…ˆä¿®è¦æ±‚ï¼Œç›´æ¥è§£é–
  IF node_prerequisites IS NULL OR jsonb_array_length(node_prerequisites) = 0 THEN
    RETURN true;
  END IF;

  -- æª¢æŸ¥æ‰€æœ‰å…ˆä¿®èª²ç¨‹æ˜¯å¦å·²å®Œæˆ
  FOR prerequisite_id IN
    SELECT jsonb_array_elements_text(node_prerequisites)
  LOOP
    IF NOT EXISTS (
      SELECT 1 FROM student_activities
      WHERE student_id = p_student_id
        AND course_node_id = prerequisite_id::UUID
        AND completed = true
    ) THEN
      all_completed := false;
      EXIT;
    END IF;
  END LOOP;

  RETURN all_completed;
END;
$$ LANGUAGE plpgsql;
```

---

## ğŸ“Š å®Œæ•´èª²ç¨‹è¤‡è£½æµç¨‹ç¸½çµ

```
å®˜æ–¹èª²ç¨‹ï¼ˆPlatform, org_id = NULLï¼‰
    â†“ æ©Ÿæ§‹ç®¡ç†å“¡è¤‡è£½
    â†“ source_template_id = å®˜æ–¹èª²ç¨‹ ID
    â†“ source_version = ç•¶å‰ç‰ˆæœ¬
æ©Ÿæ§‹èª²ç¨‹åº«ï¼ˆOrganization, org_id = Aï¼‰
    â†“ å­¸æ ¡ç®¡ç†å“¡è¤‡è£½
    â†“ source_template_id = æ©Ÿæ§‹èª²ç¨‹ ID
æ ¡ç´šèª²ç¨‹åº«ï¼ˆSchool, org_id = A, school_id = Xï¼‰
    â†“ æ•™å¸«è¤‡è£½
    â†“ source_template_id = æ ¡ç´šèª²ç¨‹ ID
ç­ç´šèª²ç¨‹ï¼ˆClassroom, org_id = A, school_id = X, classroom_id = Yï¼‰
    â†“ é¸å–æ¨¡çµ„
    â†“ å»ºç«‹ assignment + assignment_modules
ä½œæ¥­ï¼ˆAssignmentï¼‰
    â†“ å­¸ç”Ÿå®Œæˆ
    â†“ student_activities (teacher_assigned = true)
å­¸ç”Ÿæ´»å‹•è¨˜éŒ„
```

---

## ğŸ“š ç›¸é—œæ–‡ä»¶

- [README.md](./README.md) - æ¶æ§‹ç¸½è¦½
- [01-å¹³å°å±¤ç´šè¨­è¨ˆ.md](./01-å¹³å°å±¤ç´šè¨­è¨ˆ.md) - å¤šç§Ÿæˆ¶æ¶æ§‹
- [02-Schemaè¨­è¨ˆå“²å­¸.md](./02-Schemaè¨­è¨ˆå“²å­¸.md) - Schema è¨­è¨ˆ
- [04-å¤šç§Ÿæˆ¶å¯¦ä½œ.md](./04-å¤šç§Ÿæˆ¶å¯¦ä½œ.md) - æŠ€è¡“å¯¦ä½œ

---

**æ–‡ä»¶ç”¨é€”**ï¼š
æ­¤æ–‡ä»¶å®šç¾©èª²ç¨‹çµæ§‹çš„æ ¸å¿ƒæ¥­å‹™é‚è¼¯ï¼ŒåŒ…å«èª²ç¨‹è¤‡è£½ã€ä½œæ¥­æ´¾ç™¼ã€å­¸ç¿’è·¯å¾‘ç­‰é—œéµæ±ºç­–ã€‚æ‰€æœ‰èª²ç¨‹ç›¸é—œåŠŸèƒ½éƒ½å¿…é ˆéµå¾ªé€™äº›æ¥­å‹™è¦å‰‡ã€‚
