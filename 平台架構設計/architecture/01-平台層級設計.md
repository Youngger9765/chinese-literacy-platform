# 平台層級設計（多租戶核心架構）

> 記錄日期：2026-02-13
> 來源：BUSINESS_LOGIC_DECISIONS.md 問題 0
> 關鍵性：⭐⭐⭐⭐⭐（規模化核心）

---

## 📋 核心決策

### 問題描述

平台要支援多個教育機構使用（如：不同縣市教育局、私立教育集團、安親班連鎖等），架構應該如何設計？

### 選項對比

| 選項 | 架構 | 優點 | 缺點 | 適用情境 |
|------|------|------|------|---------|
| **A. 僅校級架構** | 平台 → 學校 → 班級 → 師生 | 簡單直接 | 無法統一管理多校 | 單一學校平台 |
| **B. 機構 + 學校架構** ✅ | 平台 → 機構 → 學校 → 班級 → 師生 | 支援多租戶、彈性高 | 架構較複雜 | SaaS 多租戶平台 |
| **C. 扁平化架構** | 平台 → 班級 → 師生 | 極簡 | 缺乏組織管理 | 小型試驗專案 |

### ✅ 最終決策：B（機構 + 學校架構）

**理由**：
- 🎯 **多租戶支援**：不同機構完全獨立（資料隔離）
- 🎯 **彈性使用情境**：從單校到大型機構都適用
- 🎯 **分級管理**：機構管理員 > 學校管理員 > 教師
- 🎯 **商業模式彈性**：可依機構、學校或學生數計費

---

## 🏛️ 完整層級架構

### 架構圖

```
平台層（Platform）
    │
    ├─ 官方課程庫（Platform Courses）
    │   - 所有機構可見
    │   - 由平台管理員管理
    │
    └─ 機構層（Organizations）← 多租戶隔離點
           │
           ├─ 機構 A（台北市教育局）
           │      │
           │      ├─ 機構課程庫（Organization Courses）
           │      │   - 僅機構 A 旗下學校可見
           │      │
           │      ├─ 學校 A1（中正國小）
           │      │      ├─ 校級課程庫
           │      │      ├─ 班級 1A（導師：王老師）
           │      │      │      ├─ 班級課程
           │      │      │      └─ 學生（小明、小華...）
           │      │      │             └─ 作業 → 學習活動
           │      │      └─ 班級 1B（導師：李老師）
           │      │
           │      └─ 學校 A2（信義國小）
           │             ├─ 校級課程庫
           │             └─ 班級...
           │
           └─ 機構 B（康橋教育集團）
                  │
                  ├─ 機構課程庫
                  │
                  ├─ 學校 B1（康橋國際學校新竹校區）
                  │      └─ 班級...
                  │
                  └─ 學校 B2（康橋國際學校青山校區）
                         └─ 班級...
```

---

## 🎯 使用情境

### 情境 1：縣市教育局

**範例**：台北市教育局

```
機構：台北市教育局
  ├─ 學校：中正國小
  ├─ 學校：信義國小
  ├─ 學校：大安國小
  └─ ... (轄下 100+ 所學校)
```

**使用方式**：
- 機構管理員：教育局資訊組長
- 可統一管理轄下所有學校
- 可建立「教育局課程庫」供各校使用
- 可查看跨校統計報表

---

### 情境 2：私立教育集團

**範例**：康橋教育集團

```
機構：康橋教育集團
  ├─ 學校：康橋國際學校新竹校區
  ├─ 學校：康橋國際學校青山校區
  └─ 學校：康橋國際學校秀岡校區
```

**使用方式**：
- 機構管理員：集團教務主任
- 統一教材管理（集團自編教材）
- 跨校教師培訓與經驗分享
- 統一品質管理與評鑑

---

### 情境 3：連鎖安親班/補習班

**範例**：何嘉仁安親班

```
機構：何嘉仁安親班
  ├─ 學校：何嘉仁天母分校
  ├─ 學校：何嘉仁內湖分校
  └─ 學校：何嘉仁板橋分校
```

**使用方式**：
- 機構管理員：總部教學長
- 統一課程設計與教材
- 連鎖品牌品質一致性
- 各分校獨立營運數據

---

### 情境 4：單一學校

**範例**：某獨立國小

```
機構：某國小（機構 = 學校，一對一）
  └─ 學校：某國小
       ├─ 班級 1A
       ├─ 班級 1B
       └─ ...
```

**使用方式**：
- 機構管理員 = 學校管理員（同一人）
- 架構完全適用，無需特殊處理
- 未來若加入教育局可平滑過渡

---

## 👥 權限分級管理

### 角色定義與權限

#### 1️⃣ 超級管理員（Platform Admin）

**權限範圍**：整個平台

**可執行操作**：
- ✅ 管理所有機構（新增/停用/編輯）
- ✅ 管理官方課程庫
- ✅ 查看平台級統計數據
- ✅ 系統設定與維護

**典型使用者**：
- 平台營運團隊
- 技術支援人員

---

#### 2️⃣ 機構管理員（Organization Admin）

**權限範圍**：本機構旗下所有學校

**可執行操作**：
- ✅ 管理旗下所有學校（新增/編輯學校）
- ✅ 管理機構級課程庫
- ✅ 查看機構內所有統計報表
- ✅ 設定機構政策（如：是否開放排行榜）
- ✅ 管理學校管理員帳號
- ❌ 無法查看其他機構資料

**典型使用者**：
- 教育局資訊組長
- 教育集團教務主任
- 連鎖機構總部教學長

**權限示例**：
```
台北市教育局機構管理員可以：
  ✅ 查看中正國小的統計報表
  ✅ 查看信義國小的學生數據
  ✅ 比較轄下所有學校的表現
  ❌ 無法查看新北市教育局的任何資料
```

---

#### 3️⃣ 學校管理員（School Admin）

**權限範圍**：本校

**可執行操作**：
- ✅ 管理本校班級與教師
- ✅ 新增/編輯教師帳號
- ✅ 管理校級課程庫
- ✅ 查看本校統計報表
- ✅ 從機構課程庫複製課程到校級
- ❌ 無法查看其他學校資料
- ❌ 無法修改機構級設定

**典型使用者**：
- 學校教務主任
- 資訊組長

**權限示例**：
```
中正國小學校管理員可以：
  ✅ 管理中正國小的班級與教師
  ✅ 查看中正國小的學習報表
  ✅ 從台北市教育局課程庫複製課程
  ❌ 無法查看信義國小的資料
  ❌ 無法修改台北市教育局的設定
```

---

#### 4️⃣ 教師（Teacher）

**權限範圍**：本班

**可執行操作**：
- ✅ 管理本班學生
- ✅ 派發作業與批改
- ✅ 查看本班學習報表
- ✅ 從校級課程庫複製課程
- ✅ 與同校教師分享課程
- ❌ 無法查看其他班級資料
- ❌ 無法修改學校設定

**典型使用者**：
- 班級導師
- 科任老師

---

#### 5️⃣ 學生（Student）

**權限範圍**：個人

**可執行操作**：
- ✅ 完成老師派發的作業
- ✅ 查看個人學習進度
- ✅ 自學模式（從官方課程自學）
- ❌ 無法查看其他同學資料

---

#### 6️⃣ 家長（Parent）

**權限範圍**：子女

**可執行操作**：
- ✅ 查看子女學習報表
- ✅ 接收週報/月報
- ❌ 無法修改任何資料
- ❌ 無法查看其他學生資料

---

### 權限階層圖

```
Platform Admin（平台級）
    ↓ 管理所有機構
Org Admin（機構級）
    ↓ 管理旗下學校
School Admin（學校級）
    ↓ 管理本校班級
Teacher（班級級）
    ↓ 管理本班學生
Student（個人級）
```

---

## 🔒 資料隔離原則（Multi-tenancy）

### 核心原則

#### 1. 機構間完全隔離

```
機構 A 的資料 ✗ 無法存取 ✗ 機構 B 的資料
```

**實作方式**：
- 所有查詢必須帶 `organization_id` 過濾條件
- Row Level Security (RLS) 確保資料安全
- 應用層 + 資料庫層雙重防護

---

#### 2. 官方課程為平台級資源

```
官方課程（Platform Level）
    ↓ 所有機構可見（唯讀）
機構 A、機構 B、機構 C... 都可存取
```

**實作方式**：
- `organization_id = NULL` 表示平台級資源
- 所有機構可查詢但不可修改
- 複製到機構後變為機構專屬

---

#### 3. 查詢過濾範例

**錯誤寫法**（無隔離）：
```sql
-- ❌ 危險！會查到所有機構的課程
SELECT * FROM courses WHERE grade = 1;
```

**正確寫法**（有隔離）：
```sql
-- ✅ 安全！只查本機構的課程
SELECT * FROM courses
WHERE grade = 1
  AND (organization_id = :current_org_id OR organization_id IS NULL);
```

---

## 📊 實作影響

### 資料結構需求

#### 核心表格

```sql
-- 機構表
organizations:
  - org_id (PK)
  - org_name
  - org_type (education_bureau | private_group | chain | single_school)
  - contact_email
  - max_schools (限制旗下學校數)
  - max_students (限制學生總數)
  - created_at

-- 學校表
schools:
  - school_id (PK)
  - organization_id (FK) ← 租戶隔離關鍵
  - school_name
  - principal_name
  - created_at

-- 班級表
classrooms:  -- 注意：使用 classrooms 避免保留字
  - classroom_id (PK)
  - school_id (FK)
  - classroom_name
  - grade (1-6)
  - created_at
```

---

### 所有業務表都需要租戶標識

```sql
-- 課程表（範例）
courses:
  - course_id (PK)
  - organization_id (FK, nullable) ← 租戶隔離
  - school_id (FK, nullable)
  - classroom_id (FK, nullable)
  - title
  - content
  - created_at

-- 若 organization_id IS NULL → 官方課程（所有機構可見）
-- 若 organization_id = X → 機構 X 專屬課程
-- 若 school_id = Y → 學校 Y 專屬課程
-- 若 classroom_id = Z → 班級 Z 專屬課程
```

---

## 🎯 課程複製路徑（更新）

### 完整複製流程

```
官方課程（Platform, org_id = NULL）
    ↓ 機構管理員複製
機構課程庫（Organization, org_id = A, school_id = NULL）
    ↓ 學校管理員複製
校級課程庫（School, org_id = A, school_id = X, classroom_id = NULL）
    ↓ 教師複製
班級課程（Classroom, org_id = A, school_id = X, classroom_id = Y）
    ↓ 選取模組 + 派發
作業（Assignment）
    ↓ 學生完成
學生活動（Student Activities）
```

---

### 分享路徑（同機構內）

```
王老師班級課程 --複製--> 李老師班級課程
  ↓                        ↓
org_id = A              org_id = A
school_id = X           school_id = X
classroom_id = Y1       classroom_id = Y2

（兩者獨立，後續修改互不影響）
```

---

### 自學路徑

```
學生從官方課程自學：
官方課程 (org_id = NULL)
    ↓ 學生複製到個人學習清單
我的自學課程 (student_id = S, teacher_assigned = false)
    ↓ 自己完成
AI 批改
```

---

## 🚫 跨機構隔離範例

### 禁止的操作

```
機構 A（台北市教育局）
  ❌ 無法查詢機構 B（康橋教育集團）的學生資料
  ❌ 無法查詢機構 B 的課程
  ❌ 無法查詢機構 B 的統計報表
  ❌ 無法修改機構 B 的設定

唯一例外：
  ✅ 可查詢官方課程（organization_id IS NULL）
```

---

## 📈 商業模式彈性

### 計費模式選項

#### 模式 1：按學生數計費
```
每學生每年 $200
機構 A 有 5,000 名學生 → 年費 $1,000,000
```

#### 模式 2：按學校數計費
```
每校每年 $50,000
機構 A 有 20 所學校 → 年費 $1,000,000
```

#### 模式 3：混合計費
```
基本費：$100,000/年（含 1,000 名學生）
超額學生：每人 $150/年
機構 A 有 5,000 名學生 → 年費 $700,000
```

#### 模式 4：分層訂閱
```
試用版：1 校 / 100 學生 / 免費 30 天
基礎版：1 校 / 500 學生 / $30,000/年
專業版：5 校 / 2,000 學生 / $120,000/年
企業版：無限制 / 無限制 / 客製化報價
```

---

## ✅ 架構優勢總結

### 1. 規模化能力
- ✅ 從單校到 1,000+ 校無縫擴展
- ✅ 支援百萬級學生並發

### 2. 資料安全
- ✅ 機構間完全隔離
- ✅ RLS 資料庫層防護
- ✅ 符合 GDPR/個資法要求

### 3. 商業彈性
- ✅ 多種計費模式可選
- ✅ 支援試用 → 付費轉換
- ✅ 企業級客製化

### 4. 管理效率
- ✅ 分級管理清晰
- ✅ 權限控制精準
- ✅ 機構自主營運

---

## 🔄 變更記錄

| 日期 | 變更內容 | 變更者 |
|------|---------|--------|
| 2026-02-13 | 初版建立，從 BUSINESS_LOGIC_DECISIONS.md 整合 | Young Tsai |
| 2026-02-13 | 新增使用情境與權限詳細說明 | Young Tsai |

---

## 📚 相關文件

- [README.md](./README.md) - 架構總覽
- [02-Schema設計哲學.md](./02-Schema設計哲學.md) - 資料庫設計
- [04-多租戶實作.md](./04-多租戶實作.md) - 技術實作細節

---

**文件用途**：
此文件定義平台的核心層級架構，是多租戶 SaaS 設計的基礎。所有後續設計都必須遵循此架構原則，確保資料隔離與權限管理正確實作。
