# 完整系統設計 - 總覽

> **最終架構決策**: GitHub (課程) + Google Classroom (身份/通知) + 我們的系統 (核心價值)
>
> **開發時間**: 4-6 週 MVP

---

## 🎯 架構總覽

```
┌─────────────────────────────────────────────────────┐
│  外部系統 (工具層)                                    │
│  ┌─────────────────┬───────────────────────────────┐ │
│  │ GitHub          │ Google Classroom               │ │
│  │ - 課程 Markdown │ - OAuth 登入                   │ │
│  │ - Git 版本控制  │ - 班級/學生同步                │ │
│  │ - PR 審閱       │ - 作業通知                     │ │
│  └─────────────────┴───────────────────────────────┘ │
└─────────────────────────────────────────────────────┘
         ↓ Git Clone                    ↓ API
┌─────────────────────────────────────────────────────┐
│  我們的後端                                          │
│  ┌──────────────────────────────────────────────────┐│
│  │ 同步服務                                         ││
│  │ - Git Pull (每小時)                             ││
│  │ - Classroom API (每日)                          ││
│  │ - Webhook (即時)                                ││
│  └──────────────────────────────────────────────────┘│
│  ┌──────────────────────────────────────────────────┐│
│  │ 核心服務                                         ││
│  │ - AI 評分引擎 (STT + 發音分析)                   ││
│  │ - 學習記錄分析                                   ││
│  │ - 進度追蹤                                       ││
│  └──────────────────────────────────────────────────┘│
│  ┌──────────────────────────────────────────────────┐│
│  │ 資料層                                           ││
│  │ - PostgreSQL (結構化資料)                        ││
│  │ - Redis (快取/Session)                           ││
│  │ - S3 (音檔/檔案)                                 ││
│  └──────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────┘
         ↓ REST API
┌─────────────────────────────────────────────────────┐
│  我們的前端                                          │
│  ┌──────────────────────────────────────────────────┐│
│  │ 學生端                                           ││
│  │ - 課程瀏覽                                       ││
│  │ - 作業提交 (錄音/上傳)                           ││
│  │ - 進度查看                                       ││
│  └──────────────────────────────────────────────────┘│
│  ┌──────────────────────────────────────────────────┐│
│  │ 教師端                                           ││
│  │ - 班級管理                                       ││
│  │ - 作業批改                                       ││
│  │ - 學習分析報表                                   ││
│  └──────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────┘
```

---

## 📊 系統職責劃分

| 元件 | 負責什麼 | 為什麼 | 可替換性 |
|------|---------|--------|---------|
| **GitHub** | 課程內容存儲、版本控制、PR 審閱 | Git 原生支援,免費 | ✅ 可換成 GitLab |
| **Google Classroom** | OAuth 登入、班級同步、通知 | 學生已有帳號,免費 | ✅ 可換成 Microsoft Teams |
| **PostgreSQL** | 學習記錄、AI 評分、使用者資料 | 核心資料,必須掌控 | ❌ 必須自己存 |
| **S3** | 音檔、圖片存儲 | 便宜、穩定 | ✅ 可換成 GCS/Azure |
| **Redis** | Session、快取 | 高效能 | ✅ 可換成 Memcached |

---

## 🗂️ 核心問題自問自答

### Q1: 資料庫 Schema 怎麼設計?

**A**: 多租戶架構 + 學習記錄表

```sql
-- 核心表
organizations (機構)
schools (學校)
classrooms (班級)
users (所有使用者)
students (學生)
teachers (教師)

-- 課程表
courses (課程內容快取,從 GitHub 同步)
lessons (課程模組)

-- 作業表
assignments (作業實例)
submissions (學生提交)
ai_scores (AI 評分結果)

-- 學習記錄
learning_records (完整學習歷程)
progress_tracking (進度追蹤)
```

詳細 Schema 見: `資料庫Schema設計.md`

---

### Q2: GitHub 同步服務怎麼實作?

**A**: Git Clone + 定期 Pull + Webhook

```typescript
// 每小時 Git Pull
@Cron('0 * * * *')
async syncCourses() {
  const git = simpleGit('/var/repos/courses');
  await git.pull();
  await this.parseAndSaveToDB();
}

// Webhook 即時更新
@Post('/webhooks/github')
async handleWebhook(payload: any) {
  if (payload.ref === 'refs/heads/main') {
    await this.syncCourses();
  }
}
```

**API 用量**: 0 次 (用 Git,不用 REST API)

詳細實作見: `GitHub同步服務設計.md`

---

### Q3: Google Classroom 怎麼整合?

**A**: OAuth + 每日同步學生名單

```typescript
// OAuth 登入
async function loginWithGoogle(idToken: string) {
  const ticket = await googleAuth.verifyIdToken({ idToken });
  const googleUserId = ticket.sub;

  const user = await db.findByGoogleId(googleUserId);
  return { user, sessionToken: generateJWT(user) };
}

// 每日同步學生名單
@Cron('0 3 * * *')
async syncStudents() {
  const courses = await classroom.courses.list();
  for (const course of courses) {
    const students = await classroom.courses.students.list(course.id);
    await db.saveStudents(students);
  }
}
```

**API 用量**: ~50 次/天 (遠低於限制)

詳細整合見: `GoogleClassroom整合設計.md`

---

### Q4: AI 評分引擎怎麼做?

**A**: STT (Whisper) + 發音分析 (自訂模型)

```typescript
// 學生提交音檔
async function submitReading(audioFile: File) {
  // 1. 上傳到 S3
  const audioUrl = await s3.upload(audioFile);

  // 2. STT 轉文字
  const transcript = await whisper.transcribe(audioUrl);

  // 3. 發音分析
  const pronunciationScore = await analyzePronu nciation(audioUrl, transcript);

  // 4. 計算總分
  const score = calculateScore({
    accuracy: transcript.accuracy,
    fluency: pronunciationScore.fluency,
    tone: pronunciationScore.tone
  });

  // 5. 儲存結果
  await db.saveScore({
    submissionId,
    score,
    transcript,
    pronunciationScore
  });

  return { score, feedback };
}
```

詳細設計見: `AI評分引擎設計.md`

---

### Q5: 前端怎麼設計?

**A**: React + TailwindCSS,分學生端和教師端

```
前端架構:
/frontend
├── /student          # 學生端
│   ├── /courses      # 課程瀏覽
│   ├── /assignments  # 作業頁面 (錄音/上傳)
│   └── /progress     # 進度查看
│
├── /teacher          # 教師端
│   ├── /classrooms   # 班級管理
│   ├── /grading      # 批改作業
│   └── /analytics    # 學習分析報表
│
└── /shared           # 共用元件
    ├── /components
    ├── /hooks
    └── /utils
```

詳細設計見: `前端設計.md`

---

### Q6: 如何部署?

**A**: Docker + Kubernetes

```yaml
# docker-compose.yml (開發環境)
services:
  backend:
    image: app-backend
    environment:
      DATABASE_URL: postgresql://...
      REDIS_URL: redis://...
      AWS_S3_BUCKET: ...
      GITHUB_TOKEN: ...
      GOOGLE_CLIENT_ID: ...

  postgres:
    image: postgres:15
    volumes:
      - pgdata:/var/lib/postgresql/data

  redis:
    image: redis:7

  frontend:
    image: app-frontend
    ports:
      - "3000:3000"
```

詳細部署見: `部署架構設計.md`

---

### Q7: 如何監控?

**A**: Prometheus + Grafana + Sentry

```typescript
// 關鍵指標
- API 響應時間
- AI 評分耗時
- GitHub 同步狀態
- Classroom 同步狀態
- 錯誤率

// 告警規則
- API P95 > 1000ms
- GitHub 同步失敗
- AI 評分失敗率 > 5%
- 資料庫連線池耗盡
```

詳細監控見: `監控告警設計.md`

---

### Q8: 如何測試?

**A**: 單元測試 + 整合測試 + E2E

```typescript
// 單元測試 (Jest)
describe('AI Scoring Service', () => {
  it('should calculate score correctly', () => {
    const score = calculateScore({
      accuracy: 0.95,
      fluency: 0.90,
      tone: 0.85
    });
    expect(score).toBe(90);
  });
});

// 整合測試
describe('GitHub Sync Service', () => {
  it('should sync courses from GitHub', async () => {
    await gitSyncService.syncAll();
    const courses = await db.getCourses();
    expect(courses.length).toBeGreaterThan(0);
  });
});

// E2E 測試 (Playwright)
test('student can submit assignment', async ({ page }) => {
  await page.goto('/assignments/1');
  await page.click('#record-button');
  await page.waitForTimeout(5000);
  await page.click('#stop-button');
  await page.click('#submit-button');
  await expect(page.locator('#success-message')).toBeVisible();
});
```

詳細測試見: `測試策略.md`

---

## 📅 開發路線圖

### Phase 1: 基礎設施 (Week 1-2)

```
Week 1:
✅ 資料庫 Schema 設計與建立
✅ GitHub 同步服務開發
✅ 基本 REST API (課程/作業 CRUD)
✅ Google OAuth 整合

Week 2:
✅ Google Classroom 同步服務
✅ S3 檔案上傳服務
✅ Redis Session 管理
✅ 基本權限控制 (RBAC)
```

### Phase 2: 核心功能 (Week 3-4)

```
Week 3:
✅ AI 評分引擎 (STT + 發音分析)
✅ 學生端前端 (課程瀏覽 + 作業提交)
✅ 音檔錄製與上傳

Week 4:
✅ 教師端前端 (班級管理 + 批改介面)
✅ 學習記錄與進度追蹤
✅ 基本報表功能
```

### Phase 3: 優化與部署 (Week 5-6)

```
Week 5:
✅ 效能優化 (快取、查詢優化)
✅ 錯誤處理與日誌
✅ 單元測試與整合測試

Week 6:
✅ Docker 化
✅ CI/CD Pipeline
✅ 監控與告警設定
✅ 上線 Staging 環境
```

---

## 💰 成本估算

### 開發成本

| 項目 | 人力 | 時間 | 成本 (假設 $10k/月) |
|------|------|------|-------------------|
| 後端開發 | 1 人 | 6 週 | $15,000 |
| 前端開發 | 1 人 | 4 週 | $10,000 |
| DevOps | 0.5 人 | 2 週 | $2,500 |
| **總計** | | | **$27,500** |

### 月運營成本 (500 學生規模)

| 項目 | 成本 |
|------|------|
| AWS EC2 (2 instances) | $100 |
| RDS PostgreSQL | $50 |
| ElastiCache Redis | $30 |
| S3 (音檔存儲 100GB) | $3 |
| CloudFront (CDN) | $20 |
| GitHub | $0 (免費) |
| Google Classroom | $0 (免費) |
| Whisper API | $50 (假設) |
| **總計** | **$253/month** |

**每學生成本**: $0.5/month

---

## 🎯 技術選型總結

| 層級 | 技術 | 為什麼選它 |
|------|------|----------|
| **前端** | React + TailwindCSS | 生態系成熟、開發快 |
| **後端** | Node.js + TypeScript | 與前端同語言、async 友善 |
| **資料庫** | PostgreSQL | 穩定、功能完整、免費 |
| **快取** | Redis | 高效能、簡單 |
| **檔案** | AWS S3 | 便宜、穩定、整合容易 |
| **STT** | OpenAI Whisper | 準確度高、支援中文 |
| **部署** | Docker + K8s | 標準化、易擴展 |
| **監控** | Prometheus + Grafana | 開源、功能完整 |

---

## ✅ 關鍵決策總結

### 1. 外部系統選擇

```
✅ 採用: GitHub + Google Classroom
✅ 原因:
  - 降低開發時間 (4 週 vs 32 週)
  - 免費或低成本
  - 學生已有 Google 帳號
  - Git 版本控制原生支援

❌ 放棄: Notion
❌ 原因:
  - API 無版本歷史功能
  - 需額外成本 ($300/month)
  - 增加系統複雜度
```

### 2. 資料主權策略

```
✅ 核心資料在我們手上:
  - 學習記錄 (PostgreSQL)
  - AI 評分 (PostgreSQL)
  - 音檔 (S3)

✅ 外部系統定位:
  - GitHub: 課程內容"源頭" (定期同步到本地)
  - Classroom: 身份與通知"管道" (資料同步到本地)

✅ 降級策略:
  - GitHub 掛掉 → 用本地快取
  - Classroom 掛掉 → 用 Email 通知
```

### 3. API 用量控制

```
✅ Git Clone 而非 REST API:
  - 課程同步: 0 API calls (用 Git)
  - 課程讀取: 0 API calls (讀本地)

✅ 最小化 API 呼叫:
  - GitHub: < 10 requests/day
  - Classroom: < 100 requests/day

✅ 遠低於 Rate Limit:
  - GitHub: 5000/hour
  - Classroom: 無限制
```

---

## 🚀 下一步行動

### 立即開始

1. **建立 GitHub Organization**
   - 建立 `school-curriculum` org
   - 建立第一個課程 repo
   - 設定 Webhook

2. **申請 Google Cloud Console**
   - 建立專案
   - 啟用 Classroom API
   - 設定 OAuth Consent Screen

3. **建立資料庫**
   - 執行 Schema SQL
   - 建立測試資料

4. **開發 MVP**
   - 後端: GitHub 同步 + OAuth
   - 前端: 課程瀏覽 + 登入

### 完整文件清單

```
已完成文件:
✅ API可行性驗證報告.md
✅ GitHub-API-深度評估.md
✅ PR當作交作業可行性評估.md
✅ 方案-全部用GitHub.md
✅ 資料主權與降級策略.md

待建立文件:
📝 資料庫Schema設計.md
📝 GitHub同步服務設計.md
📝 GoogleClassroom整合設計.md
📝 AI評分引擎設計.md
📝 前端設計.md
📝 部署架構設計.md
📝 監控告警設計.md
📝 測試策略.md
```

---

**總結**: 架構清晰、技術可行、成本可控,可以開始開發了!

