# è³‡æ–™ä¸»æ¬Šèˆ‡é™ç´šç­–ç•¥

> **æ ¸å¿ƒåŸå‰‡**:å¤–éƒ¨ç³»çµ±åªæ˜¯ã€Œå¿«å–èˆ‡å·¥ä½œæµå·¥å…·ã€,æ ¸å¿ƒè³‡æ–™æ°¸é åœ¨æˆ‘å€‘æ‰‹ä¸Š
>
> **é™ç´šç­–ç•¥**:å¤–éƒ¨ç³»çµ±æ›æ‰æ™‚,ç³»çµ±ä»å¯ç¹¼çºŒé‹ä½œ(å”¯è®€æ¨¡å¼)

---

## ğŸ¯ é‡æ–°æ€è€ƒ:ä»€éº¼è³‡æ–™å¿…é ˆåœ¨æˆ‘å€‘æ‰‹ä¸Š?

### è³‡æ–™ä¸»æ¬ŠçŸ©é™£

| è³‡æ–™é¡å‹ | å¿…é ˆè‡ªå·±å­˜? | åŸå›  | å„²å­˜ä½ç½® | å¤–éƒ¨ç³»çµ±è§’è‰² |
|---------|-----------|------|---------|-------------|
| **å­¸ç”Ÿå­¸ç¿’è¨˜éŒ„** | âœ… çµ•å° | æ ¸å¿ƒæ¥­å‹™è³‡æ–™ | PostgreSQL | ç„¡ |
| **AI è©•åˆ†çµæœ** | âœ… çµ•å° | å•†æ¥­åƒ¹å€¼ã€éš±ç§æ•æ„Ÿ | PostgreSQL | ç„¡ |
| **å­¸ç”Ÿæª”æ¡ˆ** | âœ… çµ•å° | æ ¸å¿ƒè³‡æ–™ | PostgreSQL | Google Classroom(åŒæ­¥) |
| **éŠæˆ²åŒ–æ•¸æ“š** | âœ… çµ•å° | é«˜é »å¯«å…¥ã€å³æ™‚æŸ¥è©¢ | PostgreSQL | ç„¡ |
| **èª²ç¨‹å…§å®¹** | âœ… å¿…é ˆ | å¯è®€æ€§å‚™ä»½ | PostgreSQL + S3 | Notion(ç·¨è¼¯å·¥å…·) |
| **ä½œæ¥­æ¨¡æ¿** | âœ… å¿…é ˆ | çµæ§‹åŒ–å‚™ä»½ | PostgreSQL | GitHub(ç‰ˆæœ¬æ§åˆ¶) |
| **ç­ç´šè³‡è¨Š** | âœ… å¿…é ˆ | æ ¸å¿ƒè³‡æ–™ | PostgreSQL | Google Classroom(åŒæ­¥) |
| **ä½¿ç”¨è€… Session** | âœ… å¿…é ˆ | èªè­‰ç‹€æ…‹ | Redis | Google OAuth(é©—è­‰) |

---

## ğŸ—ï¸ é‡æ–°è¨­è¨ˆ:é›™å±¤æ¶æ§‹

### æ¶æ§‹åŸå‰‡

```
åŸå‰‡ 1: æ‰€æœ‰æ ¸å¿ƒè³‡æ–™éƒ½å­˜åœ¨æˆ‘å€‘çš„è³‡æ–™åº«
åŸå‰‡ 2: å¤–éƒ¨ç³»çµ±åªæ˜¯ã€Œç·¨è¼¯å·¥å…·ã€æˆ–ã€Œé€šçŸ¥ç®¡é“ã€
åŸå‰‡ 3: å®šæœŸå¾å¤–éƒ¨ç³»çµ±åŒæ­¥åˆ°æœ¬åœ°
åŸå‰‡ 4: å¤–éƒ¨ç³»çµ±æ›æ‰æ™‚,ç³»çµ±é™ç´šä½†ä¸åœæ“º
```

### æ–°æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¤–éƒ¨ç³»çµ±å±¤ (å·¥å…·å±¤ - å¯é¸)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Notion   â”‚ GitHub   â”‚ Google Classroom         â”‚ â”‚
â”‚  â”‚ ç·¨è¼¯å·¥å…·  â”‚ ç‰ˆæœ¬æ§åˆ¶  â”‚ OAuth + é€šçŸ¥              â”‚ â”‚
â”‚  â”‚ (å¯æ›¿æ›)  â”‚ (å¯æ›¿æ›)  â”‚ (å¯æ›¿æ›)                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ å–®å‘åŒæ­¥ (æ¯å°æ™‚)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åŒæ­¥å±¤ (Sync Layer)                                 â”‚
â”‚  - å®šæœŸå¾å¤–éƒ¨ç³»çµ±æ‹‰å–è³‡æ–™                             â”‚
â”‚  - è½‰æ›ç‚ºæ¨™æº–æ ¼å¼                                    â”‚
â”‚  - å„²å­˜åˆ°æœ¬åœ°è³‡æ–™åº«                                  â”‚
â”‚  - å¤±æ•—æ™‚è‡ªå‹•é‡è©¦                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ å¯«å…¥æœ¬åœ°
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆ‘å€‘çš„è³‡æ–™åº« (Source of Truth)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ PostgreSQL (ä¸»è³‡æ–™åº«)                            â”‚â”‚
â”‚  â”‚ â”œâ”€ å­¸ç”Ÿå­¸ç¿’è¨˜éŒ„                                  â”‚â”‚
â”‚  â”‚ â”œâ”€ AI è©•åˆ†çµæœ                                   â”‚â”‚
â”‚  â”‚ â”œâ”€ èª²ç¨‹å…§å®¹å¿«å– (å¾ Notion åŒæ­¥)                 â”‚â”‚
â”‚  â”‚ â”œâ”€ ä½œæ¥­æ¨¡æ¿å¿«å– (å¾ GitHub åŒæ­¥)                 â”‚â”‚
â”‚  â”‚ â”œâ”€ å­¸ç”Ÿæª”æ¡ˆ (å¾ Classroom åŒæ­¥)                  â”‚â”‚
â”‚  â”‚ â””â”€ ç­ç´šè³‡è¨Š (å¾ Classroom åŒæ­¥)                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ S3 / Object Storage                              â”‚â”‚
â”‚  â”‚ â”œâ”€ èª²ç¨‹å…§å®¹å®Œæ•´å‚™ä»½ (Markdown)                   â”‚â”‚
â”‚  â”‚ â”œâ”€ ä½œæ¥­æ¨¡æ¿å‚™ä»½ (JSON)                           â”‚â”‚
â”‚  â”‚ â”œâ”€ å­¸ç”ŸéŸ³æª”                                      â”‚â”‚
â”‚  â”‚ â””â”€ æ¯æ—¥å¿«ç…§                                      â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ API æŸ¥è©¢
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æˆ‘å€‘çš„å¾Œç«¯ (æ¥­å‹™é‚è¼¯)                               â”‚
â”‚  - 100% å¾æœ¬åœ°è³‡æ–™åº«è®€å–                             â”‚
â”‚  - AI è©•åˆ†å¯«å…¥æœ¬åœ°                                   â”‚
â”‚  - å­¸ç¿’è¨˜éŒ„å¯«å…¥æœ¬åœ°                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¾ è³‡æ–™åº«è¨­è¨ˆ:å®Œæ•´ Schema

### æ ¸å¿ƒè³‡æ–™è¡¨

```sql
-- ========== çµ„ç¹”æ¶æ§‹ ==========
CREATE TABLE organizations (
  organization_id UUID PRIMARY KEY,
  organization_name VARCHAR(255),
  google_workspace_domain VARCHAR(255), -- å¯é¸,ç”¨æ–¼ Google Classroom
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE schools (
  school_id UUID PRIMARY KEY,
  organization_id UUID REFERENCES organizations(organization_id),
  school_name VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE classrooms (
  classroom_id UUID PRIMARY KEY,
  school_id UUID REFERENCES schools(school_id),
  classroom_name VARCHAR(255),

  -- å¤–éƒ¨ç³»çµ± ID (å¯é¸)
  google_classroom_id VARCHAR(255) UNIQUE,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ========== ä½¿ç”¨è€… ==========
CREATE TABLE users (
  user_id UUID PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(255),
  avatar_url TEXT,
  role VARCHAR(50), -- student, teacher, admin

  -- å¤–éƒ¨ç³»çµ± ID (å¯é¸)
  google_user_id VARCHAR(255) UNIQUE,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE students (
  student_id UUID PRIMARY KEY REFERENCES users(user_id),
  student_number VARCHAR(50),
  grade VARCHAR(50),

  -- å¤–éƒ¨ç³»çµ±é—œè¯ (å¯é¸)
  google_user_id VARCHAR(255) UNIQUE,

  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE teachers (
  teacher_id UUID PRIMARY KEY REFERENCES users(user_id),

  -- å¤–éƒ¨ç³»çµ±é—œè¯ (å¯é¸)
  google_user_id VARCHAR(255) UNIQUE,

  created_at TIMESTAMP DEFAULT NOW()
);

-- ========== èª²ç¨‹å…§å®¹ (æœ¬åœ°å­˜å„²) ==========
CREATE TABLE courses (
  course_id UUID PRIMARY KEY,
  organization_id UUID REFERENCES organizations(organization_id),
  course_name VARCHAR(255),
  grade VARCHAR(50),
  status VARCHAR(50), -- draft, published, archived

  -- èª²ç¨‹å…§å®¹ (å¾ Notion åŒæ­¥)
  content JSONB, -- çµæ§‹åŒ–èª²ç¨‹å…§å®¹

  -- å¤–éƒ¨ç³»çµ± ID (å¯é¸)
  notion_page_id VARCHAR(255),

  -- ç‰ˆæœ¬æ§åˆ¶
  version INT DEFAULT 1,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  synced_at TIMESTAMP -- æœ€å¾ŒåŒæ­¥æ™‚é–“
);

-- èª²ç¨‹ç‰ˆæœ¬æ­·å² (æˆ‘å€‘è‡ªå·±è¨˜éŒ„)
CREATE TABLE course_versions (
  version_id UUID PRIMARY KEY,
  course_id UUID REFERENCES courses(course_id),
  version_number INT,
  content JSONB,
  changed_by UUID REFERENCES users(user_id),
  change_description TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- ========== ä½œæ¥­æ¨¡æ¿ (æœ¬åœ°å­˜å„²) ==========
CREATE TABLE assignment_templates (
  template_id UUID PRIMARY KEY,
  course_id UUID REFERENCES courses(course_id),
  template_name VARCHAR(255),
  template_type VARCHAR(50), -- reading, vocabulary, comprehension
  description TEXT,
  content JSONB, -- ä½œæ¥­å…§å®¹

  -- å¤–éƒ¨ç³»çµ± ID (å¯é¸)
  github_issue_number INT,
  github_issue_url TEXT,

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  synced_at TIMESTAMP
);

-- ========== ä½œæ¥­å¯¦ä¾‹ (å­¸ç”Ÿçš„ä½œæ¥­) ==========
CREATE TABLE assignments (
  assignment_id UUID PRIMARY KEY,
  classroom_id UUID REFERENCES classrooms(classroom_id),
  template_id UUID REFERENCES assignment_templates(template_id),
  teacher_id UUID REFERENCES teachers(teacher_id),

  title VARCHAR(255),
  description TEXT,
  due_date TIMESTAMP,
  max_points INT DEFAULT 100,
  status VARCHAR(50), -- active, closed

  -- å¤–éƒ¨ç³»çµ± ID (å¯é¸,ç”¨æ–¼é€šçŸ¥)
  google_coursework_id VARCHAR(255),

  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- ========== å­¸ç¿’è¨˜éŒ„ (æ ¸å¿ƒè³‡æ–™) ==========
CREATE TABLE learning_records (
  record_id UUID PRIMARY KEY,
  student_id UUID REFERENCES students(student_id),
  assignment_id UUID REFERENCES assignments(assignment_id),

  -- å­¸ç”Ÿæäº¤å…§å®¹
  submission_type VARCHAR(50), -- audio, text, multiple_choice
  submission_data JSONB,
  audio_url TEXT,

  -- AI è©•åˆ†çµæœ
  score DECIMAL(5,2),
  ai_feedback JSONB, -- è©³ç´°åé¥‹

  -- èƒ½åŠ›è©•ä¼°
  pronunciation_score DECIMAL(5,2),
  fluency_score DECIMAL(5,2),
  tone_score DECIMAL(5,2),

  submitted_at TIMESTAMP DEFAULT NOW(),
  graded_at TIMESTAMP
);

-- ========== éŠæˆ²åŒ–æ•¸æ“š ==========
CREATE TABLE student_points (
  student_id UUID REFERENCES students(student_id),
  points INT DEFAULT 0,
  level INT DEFAULT 1,
  experience INT DEFAULT 0,
  streak_days INT DEFAULT 0, -- é€£çºŒç™»å…¥å¤©æ•¸
  last_login_date DATE,

  updated_at TIMESTAMP DEFAULT NOW(),

  PRIMARY KEY (student_id)
);

CREATE TABLE student_badges (
  badge_id UUID PRIMARY KEY,
  student_id UUID REFERENCES students(student_id),
  badge_type VARCHAR(50),
  badge_name VARCHAR(255),
  earned_at TIMESTAMP DEFAULT NOW()
);

-- ========== å¤–éƒ¨ç³»çµ±åŒæ­¥è¨˜éŒ„ ==========
CREATE TABLE sync_logs (
  log_id UUID PRIMARY KEY,
  sync_type VARCHAR(50), -- notion, github, classroom
  sync_status VARCHAR(50), -- success, failed
  records_synced INT,
  error_message TEXT,
  started_at TIMESTAMP,
  completed_at TIMESTAMP
);
```

---

## ğŸ”„ åŒæ­¥ç­–ç•¥:å¤–éƒ¨ç³»çµ± â†’ æœ¬åœ°è³‡æ–™åº«

### åŒæ­¥åŸå‰‡

```
åŸå‰‡ 1: å¤–éƒ¨ç³»çµ±æ˜¯ã€Œç·¨è¼¯ä»‹é¢ã€,æœ¬åœ°æ˜¯ã€Œè³‡æ–™å€‰åº«ã€
åŸå‰‡ 2: å–®å‘åŒæ­¥:å¤–éƒ¨ â†’ æœ¬åœ° (ä¸å›å¯«)
åŸå‰‡ 3: å®šæœŸåŒæ­¥ + Webhook å³æ™‚åŒæ­¥
åŸå‰‡ 4: å¤±æ•—è‡ªå‹•é‡è©¦,è¨˜éŒ„éŒ¯èª¤æ—¥èªŒ
```

### 1. Notion èª²ç¨‹å…§å®¹åŒæ­¥

```typescript
// /backend/src/sync/notion-sync.service.ts

export class NotionSyncService {
  // ========== åŒæ­¥å–®ä¸€èª²ç¨‹ ==========
  async syncCourse(notionPageId: string) {
    try {
      // 1. å¾ Notion å–å¾—æœ€æ–°å…§å®¹
      const notionPage = await this.notionAdapter.getCourse(notionPageId);

      // 2. è½‰æ›ç‚ºæ¨™æº–æ ¼å¼
      const courseData = {
        courseName: notionPage.title,
        grade: notionPage.grade,
        status: notionPage.status,
        content: this.transformNotionContent(notionPage.blocks),
      };

      // 3. å¯«å…¥æœ¬åœ°è³‡æ–™åº«
      const result = await this.db.query(
        `INSERT INTO courses (
          course_id,
          organization_id,
          course_name,
          grade,
          status,
          content,
          notion_page_id,
          synced_at
        ) VALUES (uuid_generate_v4(), $1, $2, $3, $4, $5, $6, NOW())
        ON CONFLICT (notion_page_id) DO UPDATE SET
          course_name = EXCLUDED.course_name,
          content = EXCLUDED.content,
          status = EXCLUDED.status,
          updated_at = NOW(),
          synced_at = NOW()
        RETURNING course_id, version`,
        [
          organizationId,
          courseData.courseName,
          courseData.grade,
          courseData.status,
          JSON.stringify(courseData.content),
          notionPageId,
        ]
      );

      // 4. è¨˜éŒ„ç‰ˆæœ¬æ­·å²
      await this.createVersionSnapshot(result.rows[0].course_id, courseData.content);

      // 5. å‚™ä»½åˆ° S3 (Markdown æ ¼å¼)
      await this.backupToS3(notionPageId, courseData);

      console.log(`[Sync] Synced course ${notionPageId}`);
      return { success: true };
    } catch (error) {
      console.error(`[Sync] Failed to sync course ${notionPageId}:`, error);
      await this.logSyncError('notion', notionPageId, error.message);
      throw error;
    }
  }

  // ========== å®šæœŸåŒæ­¥æ‰€æœ‰èª²ç¨‹ ==========
  @Cron('0 * * * *') // æ¯å°æ™‚
  async syncAllCourses() {
    const startTime = Date.now();
    let successCount = 0;
    let failCount = 0;

    console.log('[NotionSync] Starting hourly sync...');

    try {
      // 1. å¾ Notion å–å¾—æ‰€æœ‰å·²ç™¼å¸ƒèª²ç¨‹
      const courses = await this.notionAdapter.queryCourses({
        filter: { property: 'ç‹€æ…‹', select: { equals: 'å·²ç™¼å¸ƒ' } },
      });

      // 2. é€ä¸€åŒæ­¥
      for (const course of courses) {
        try {
          await this.syncCourse(course.id);
          successCount++;
        } catch (error) {
          failCount++;
        }
      }

      // 3. è¨˜éŒ„åŒæ­¥æ—¥èªŒ
      await this.db.query(
        `INSERT INTO sync_logs (
          log_id, sync_type, sync_status, records_synced,
          started_at, completed_at
        ) VALUES (uuid_generate_v4(), 'notion', 'success', $1, $2, NOW())`,
        [successCount, new Date(startTime)]
      );

      console.log(`[NotionSync] Completed: ${successCount} success, ${failCount} failed`);
    } catch (error) {
      console.error('[NotionSync] Hourly sync failed:', error);
    }
  }

  // ========== è½‰æ› Notion å…§å®¹ç‚ºæ¨™æº–æ ¼å¼ ==========
  private transformNotionContent(blocks: any[]) {
    return blocks.map(block => {
      switch (block.type) {
        case 'paragraph':
          return {
            type: 'text',
            content: block.paragraph.rich_text[0]?.plain_text || '',
          };
        case 'heading_2':
          return {
            type: 'heading',
            level: 2,
            content: block.heading_2.rich_text[0]?.plain_text || '',
          };
        case 'table':
          return {
            type: 'table',
            headers: block.table.headers,
            rows: block.table.rows,
          };
        case 'audio':
          return {
            type: 'audio',
            url: block.audio.file?.url || block.audio.external?.url,
          };
        default:
          return { type: 'unknown', content: '' };
      }
    });
  }

  // ========== å‚™ä»½åˆ° S3 (Markdown æ ¼å¼) ==========
  private async backupToS3(notionPageId: string, courseData: any) {
    // è½‰æ›ç‚º Markdown
    const markdown = this.convertToMarkdown(courseData);

    // ä¸Šå‚³åˆ° S3
    await s3Client.putObject({
      Bucket: process.env.S3_BACKUP_BUCKET,
      Key: `courses/${notionPageId}/${Date.now()}.md`,
      Body: markdown,
      ContentType: 'text/markdown',
    });
  }

  // ========== è¨˜éŒ„ç‰ˆæœ¬æ­·å² ==========
  private async createVersionSnapshot(courseId: string, content: any) {
    await this.db.query(
      `INSERT INTO course_versions (
        version_id, course_id, version_number, content, created_at
      ) VALUES (
        uuid_generate_v4(),
        $1,
        (SELECT COALESCE(MAX(version_number), 0) + 1 FROM course_versions WHERE course_id = $1),
        $2,
        NOW()
      )`,
      [courseId, JSON.stringify(content)]
    );
  }
}
```

### 2. GitHub ä½œæ¥­æ¨¡æ¿åŒæ­¥

```typescript
// /backend/src/sync/github-sync.service.ts

export class GitHubSyncService {
  // ========== åŒæ­¥ä½œæ¥­æ¨¡æ¿ ==========
  @Cron('0 */6 * * *') // æ¯ 6 å°æ™‚
  async syncAssignmentTemplates() {
    console.log('[GitHubSync] Starting assignment sync...');

    try {
      // 1. å¾ GitHub å–å¾—æ‰€æœ‰ä½œæ¥­æ¨¡æ¿ Issues
      const issues = await this.githubAdapter.listIssues({
        labels: 'ä½œæ¥­æ¨¡æ¿',
        state: 'open',
      });

      // 2. åŒæ­¥åˆ°æœ¬åœ°è³‡æ–™åº«
      for (const issue of issues) {
        await this.db.query(
          `INSERT INTO assignment_templates (
            template_id,
            template_name,
            template_type,
            description,
            content,
            github_issue_number,
            github_issue_url,
            synced_at
          ) VALUES (
            uuid_generate_v4(),
            $1, $2, $3, $4, $5, $6, NOW()
          )
          ON CONFLICT (github_issue_number) DO UPDATE SET
            template_name = EXCLUDED.template_name,
            description = EXCLUDED.description,
            content = EXCLUDED.content,
            updated_at = NOW(),
            synced_at = NOW()`,
          [
            issue.title,
            this.extractType(issue.labels),
            issue.body,
            JSON.stringify(this.parseIssueContent(issue.body)),
            issue.number,
            issue.html_url,
          ]
        );
      }

      // 3. å‚™ä»½åˆ° S3 (JSON æ ¼å¼)
      await this.backupTemplatesToS3(issues);

      console.log(`[GitHubSync] Synced ${issues.length} templates`);
    } catch (error) {
      console.error('[GitHubSync] Sync failed:', error);
    }
  }

  // ========== å‚™ä»½åˆ° S3 ==========
  private async backupTemplatesToS3(issues: any[]) {
    const backup = {
      timestamp: new Date().toISOString(),
      templates: issues.map(issue => ({
        number: issue.number,
        title: issue.title,
        body: issue.body,
        labels: issue.labels.map(l => l.name),
        created_at: issue.created_at,
      })),
    };

    await s3Client.putObject({
      Bucket: process.env.S3_BACKUP_BUCKET,
      Key: `github-templates/${Date.now()}.json`,
      Body: JSON.stringify(backup, null, 2),
      ContentType: 'application/json',
    });
  }
}
```

### 3. Google Classroom å­¸ç”Ÿåå–®åŒæ­¥

```typescript
// /backend/src/sync/classroom-sync.service.ts

export class ClassroomSyncService {
  // ========== åŒæ­¥å­¸ç”Ÿåå–® ==========
  @Cron('0 3 * * *') // æ¯å¤©å‡Œæ™¨ 3 é»
  async syncStudents() {
    console.log('[ClassroomSync] Starting student sync...');

    try {
      // 1. å–å¾—æ‰€æœ‰æ•™å¸«çš„ Access Token
      const teachers = await this.db.query(
        'SELECT teacher_id, google_access_token FROM teachers WHERE google_access_token IS NOT NULL'
      );

      for (const teacher of teachers.rows) {
        const adapter = new ClassroomAdapter(teacher.google_access_token);

        // 2. å–å¾—æ•™å¸«çš„æ‰€æœ‰ç­ç´š
        const courses = await adapter.listCourses();

        for (const course of courses) {
          // 3. åŒæ­¥ç­ç´šè³‡è¨Š
          await this.db.query(
            `INSERT INTO classrooms (
              classroom_id, school_id, classroom_name, google_classroom_id
            ) VALUES (
              uuid_generate_v4(), $1, $2, $3
            )
            ON CONFLICT (google_classroom_id) DO UPDATE SET
              classroom_name = EXCLUDED.classroom_name,
              updated_at = NOW()`,
            [teacherSchoolId, course.name, course.id]
          );

          // 4. å–å¾—å­¸ç”Ÿåå–®
          const students = await adapter.listStudents(course.id);

          for (const student of students) {
            // 5. åŒæ­¥å­¸ç”Ÿè³‡æ–™åˆ°æœ¬åœ°
            await this.db.query(
              `INSERT INTO users (
                user_id, email, name, avatar_url, role, google_user_id
              ) VALUES (
                uuid_generate_v4(), $1, $2, $3, 'student', $4
              )
              ON CONFLICT (google_user_id) DO UPDATE SET
                name = EXCLUDED.name,
                avatar_url = EXCLUDED.avatar_url,
                updated_at = NOW()
              RETURNING user_id`,
              [student.email, student.name, student.photoUrl, student.userId]
            );
          }
        }
      }

      console.log('[ClassroomSync] Student sync completed');
    } catch (error) {
      console.error('[ClassroomSync] Sync failed:', error);
    }
  }
}
```

---

## ğŸ”¥ é™ç´šç­–ç•¥:å¤–éƒ¨ç³»çµ±æ›æ‰æ€éº¼è¾¦?

### é™ç´šæ¨¡å¼

```
Level 0: æ­£å¸¸æ¨¡å¼
  - å¤–éƒ¨ç³»çµ±æ­£å¸¸é‹ä½œ
  - å®šæœŸåŒæ­¥è³‡æ–™
  - æ‰€æœ‰åŠŸèƒ½å¯ç”¨

Level 1: å”¯è®€æ¨¡å¼ (Notion/GitHub æ›æ‰)
  - èª²ç¨‹å…§å®¹å¾æœ¬åœ°è³‡æ–™åº«è®€å–
  - ä½œæ¥­æ¨¡æ¿å¾æœ¬åœ°è³‡æ–™åº«è®€å–
  - ç„¡æ³•ç·¨è¼¯èª²ç¨‹(å…§éƒ¨åœ˜éšŠå—å½±éŸ¿)
  - å­¸ç”Ÿç«¯å®Œå…¨ä¸å—å½±éŸ¿

Level 2: é€šçŸ¥é™ç´š (Google Classroom æ›æ‰)
  - OAuth ç™»å…¥æ”¹ç”¨æœ¬åœ°å¸³è™Ÿç³»çµ±
  - é€šçŸ¥æ”¹ç”¨ Email/SMS
  - æ ¸å¿ƒå­¸ç¿’åŠŸèƒ½ä¸å—å½±éŸ¿

Level 3: å®Œå…¨é›¢ç·š (æ‰€æœ‰å¤–éƒ¨ç³»çµ±æ›æ‰)
  - ä½¿ç”¨æœ¬åœ°å¸³è™Ÿç³»çµ±
  - ä½¿ç”¨æœ¬åœ°è³‡æ–™
  - æ ¸å¿ƒå­¸ç¿’åŠŸèƒ½æ­£å¸¸
  - ç„¡æ³•åŒæ­¥æ–°èª²ç¨‹
```

### é™ç´šå¯¦ä½œ

```typescript
// /backend/src/services/degradation.service.ts

export class DegradationService {
  private notionStatus: 'healthy' | 'degraded' = 'healthy';
  private githubStatus: 'healthy' | 'degraded' = 'healthy';
  private classroomStatus: 'healthy' | 'degraded' = 'healthy';

  // ========== å¥åº·æª¢æŸ¥ ==========
  @Cron('*/5 * * * *') // æ¯ 5 åˆ†é˜
  async healthCheck() {
    // 1. æª¢æŸ¥ Notion
    try {
      await this.notionAdapter.healthCheck();
      this.notionStatus = 'healthy';
    } catch (error) {
      this.notionStatus = 'degraded';
      console.warn('[Health] Notion is down');
    }

    // 2. æª¢æŸ¥ GitHub
    try {
      await this.githubAdapter.healthCheck();
      this.githubStatus = 'healthy';
    } catch (error) {
      this.githubStatus = 'degraded';
      console.warn('[Health] GitHub is down');
    }

    // 3. æª¢æŸ¥ Google Classroom
    try {
      await this.classroomAdapter.healthCheck();
      this.classroomStatus = 'healthy';
    } catch (error) {
      this.classroomStatus = 'degraded';
      console.warn('[Health] Classroom is down');
    }

    // 4. æ›´æ–°ç³»çµ±ç‹€æ…‹
    await this.updateSystemStatus();
  }

  // ========== å–å¾—èª²ç¨‹(æ”¯æ´é™ç´š) ==========
  async getCourse(courseId: string): Promise<Course> {
    if (this.notionStatus === 'healthy') {
      try {
        // å˜—è©¦å¾ Notion å–å¾—æœ€æ–°è³‡æ–™
        return await this.notionAdapter.getCourse(courseId);
      } catch (error) {
        console.warn('[Degradation] Notion failed, using local cache');
      }
    }

    // é™ç´š:å¾æœ¬åœ°è³‡æ–™åº«è®€å–
    const result = await this.db.query(
      'SELECT * FROM courses WHERE course_id = $1',
      [courseId]
    );

    if (!result.rows[0]) {
      throw new Error('Course not found in local cache');
    }

    return result.rows[0];
  }

  // ========== å­¸ç”Ÿç™»å…¥(æ”¯æ´é™ç´š) ==========
  async studentLogin(credentials: any): Promise<LoginResult> {
    if (this.classroomStatus === 'healthy') {
      try {
        // å„ªå…ˆä½¿ç”¨ Google OAuth
        return await this.googleAuthService.login(credentials);
      } catch (error) {
        console.warn('[Degradation] Google OAuth failed, using local auth');
      }
    }

    // é™ç´š:ä½¿ç”¨æœ¬åœ°å¸³è™Ÿç³»çµ±
    return await this.localAuthService.login(credentials);
  }

  // ========== ç™¼é€ä½œæ¥­é€šçŸ¥(æ”¯æ´é™ç´š) ==========
  async sendAssignmentNotification(assignmentId: string) {
    if (this.classroomStatus === 'healthy') {
      try {
        // å„ªå…ˆä½¿ç”¨ Google Classroom é€šçŸ¥
        return await this.classroomAdapter.createCourseWork(assignmentId);
      } catch (error) {
        console.warn('[Degradation] Classroom failed, using email');
      }
    }

    // é™ç´š:ä½¿ç”¨ Email é€šçŸ¥
    return await this.emailService.sendAssignmentEmail(assignmentId);
  }
}
```

---

## ğŸ“Š è³‡æ–™å‚™ä»½ç­–ç•¥

### å‚™ä»½å±¤ç´š

```
Level 1: å³æ™‚å‚™ä»½ (PostgreSQL)
  - æ‰€æœ‰æ ¸å¿ƒè³‡æ–™
  - æ¯æ¬¡å¯«å…¥ç«‹å³æŒä¹…åŒ–
  - WAL æ—¥èªŒå‚™ä»½

Level 2: æ¯æ—¥å¿«ç…§ (S3)
  - èª²ç¨‹å…§å®¹ (Markdown)
  - ä½œæ¥­æ¨¡æ¿ (JSON)
  - å­¸ç”Ÿåå–® (CSV)
  - ä¿ç•™ 30 å¤©

Level 3: æ¯é€±å®Œæ•´å‚™ä»½ (S3 Glacier)
  - å®Œæ•´è³‡æ–™åº« Dump
  - ä¿ç•™ 1 å¹´

Level 4: å¤–éƒ¨ç³»çµ±å‚™ä»½
  - æ¯æ—¥å¾ Notion åŒ¯å‡º (Markdown)
  - æ¯æ—¥å¾ GitHub åŒ¯å‡º (JSON)
  - ç”¨æ–¼ç½é›£æ¢å¾©
```

### å‚™ä»½å¯¦ä½œ

```typescript
// /backend/src/backup/backup.service.ts

export class BackupService {
  // ========== æ¯æ—¥å‚™ä»½ ==========
  @Cron('0 2 * * *') // æ¯å¤©å‡Œæ™¨ 2 é»
  async dailyBackup() {
    console.log('[Backup] Starting daily backup...');

    try {
      // 1. å‚™ä»½èª²ç¨‹å…§å®¹
      await this.backupCourses();

      // 2. å‚™ä»½ä½œæ¥­æ¨¡æ¿
      await this.backupAssignments();

      // 3. å‚™ä»½å­¸ç”Ÿè³‡æ–™
      await this.backupStudents();

      // 4. å‚™ä»½å­¸ç¿’è¨˜éŒ„
      await this.backupLearningRecords();

      console.log('[Backup] Daily backup completed');
    } catch (error) {
      console.error('[Backup] Backup failed:', error);
      await this.sendAlert('Backup failed', error.message);
    }
  }

  // ========== å‚™ä»½èª²ç¨‹å…§å®¹ ==========
  private async backupCourses() {
    const courses = await this.db.query('SELECT * FROM courses');

    for (const course of courses.rows) {
      // è½‰æ›ç‚º Markdown
      const markdown = this.convertCourseToMarkdown(course);

      // ä¸Šå‚³åˆ° S3
      await s3Client.putObject({
        Bucket: process.env.S3_BACKUP_BUCKET,
        Key: `daily/${today}/courses/${course.course_id}.md`,
        Body: markdown,
      });
    }
  }

  // ========== æ¯é€±å®Œæ•´å‚™ä»½ ==========
  @Cron('0 3 * * 0') // æ¯é€±æ—¥å‡Œæ™¨ 3 é»
  async weeklyFullBackup() {
    console.log('[Backup] Starting weekly full backup...');

    // 1. PostgreSQL Dump
    await exec('pg_dump -Fc chinese_literacy > /tmp/backup.dump');

    // 2. ä¸Šå‚³åˆ° S3 Glacier
    await s3Client.putObject({
      Bucket: process.env.S3_BACKUP_BUCKET,
      Key: `weekly/${weekNumber}/database.dump`,
      Body: fs.createReadStream('/tmp/backup.dump'),
      StorageClass: 'GLACIER',
    });

    console.log('[Backup] Weekly backup completed');
  }
}
```

---

## âœ… ç¸½çµ:è³‡æ–™ä¸»æ¬Šä¿éšœ

### æ ¸å¿ƒåŸå‰‡

| åŸå‰‡ | èªªæ˜ | å¯¦ä½œ |
|------|------|------|
| **è³‡æ–™åœ¨æˆ‘å€‘æ‰‹ä¸Š** | æ‰€æœ‰æ ¸å¿ƒè³‡æ–™å­˜æœ¬åœ°è³‡æ–™åº« | PostgreSQL + S3 |
| **å¤–éƒ¨ç³»çµ±å¯æ›¿æ›** | é€é Adapter æŠ½è±¡å±¤ | æ˜“æ–¼åˆ‡æ› Provider |
| **é™ç´šä¸åœæ“º** | å¤–éƒ¨ç³»çµ±æ›æ‰ä»å¯é‹ä½œ | å”¯è®€æ¨¡å¼ |
| **æ¯æ—¥å‚™ä»½** | å®šæœŸå‚™ä»½åˆ° S3 | ä¿ç•™ 30 å¤© |

### è³‡æ–™æµå‘

```
ç·¨è¼¯ â†’ å¤–éƒ¨ç³»çµ± (Notion/GitHub)
         â†“ åŒæ­¥ (æ¯å°æ™‚)
      æœ¬åœ°è³‡æ–™åº« (PostgreSQL)
         â†“ å‚™ä»½ (æ¯æ—¥)
      S3 å­˜å„² (Markdown/JSON)
```

### é™ç´šä¿éšœ

```
Notion æ›æ‰ â†’ èª²ç¨‹å…§å®¹å¾æœ¬åœ°è®€å– âœ…
GitHub æ›æ‰ â†’ ä½œæ¥­æ¨¡æ¿å¾æœ¬åœ°è®€å– âœ…
Classroom æ›æ‰ â†’ æ”¹ç”¨æœ¬åœ°ç™»å…¥ + Email é€šçŸ¥ âœ…
å…¨éƒ¨æ›æ‰ â†’ æ ¸å¿ƒå­¸ç¿’åŠŸèƒ½ä»å¯é‹ä½œ âœ…
```

**çµè«–**:å¤–éƒ¨ç³»çµ±åªæ˜¯ã€Œå·¥å…·ã€,æ ¸å¿ƒè³‡æ–™èˆ‡æ§åˆ¶æ¬Šæ°¸é åœ¨æˆ‘å€‘æ‰‹ä¸Šã€‚

