# ç›£æ§å‘Šè­¦è¨­è¨ˆ

> **ç›®æ¨™**: å»ºç«‹å®Œæ•´çš„ç›£æ§ç³»çµ±,åŠæ™‚ç™¼ç¾å’Œè™•ç†å•é¡Œ
>
> **æŠ€è¡“æ£§**: Prometheus + Grafana + Loki + Sentry + Custom Health Checks
>
> **å‘Šè­¦æ™‚é–“**: P1 (åš´é‡) < 1 åˆ†é˜,P2 (ä¸€èˆ¬) < 5 åˆ†é˜

---

## ğŸ¯ ç›£æ§æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‡‰ç”¨å±¤ (Metrics Exporters)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Prometheus   â”‚ Loki         â”‚ Sentry Agent             â”‚ â”‚
â”‚  â”‚ Client Lib   â”‚ Promtail     â”‚ (Error Tracking)         â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ Pull (æ¯ 15 ç§’)        â†“ Push             â†“ Push
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ”¶é›†å±¤ (Time Series DB + Log Aggregation)                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Prometheus   â”‚ Loki         â”‚ Sentry                   â”‚ â”‚
â”‚  â”‚ (æŒ‡æ¨™)       â”‚ (æ—¥èªŒ)       â”‚ (éŒ¯èª¤è¿½è¹¤)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                â†“                      â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åˆ†æå±¤ (Alerting Engine)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ Prometheus Alertmanager                                 â”‚â”‚
â”‚  â”‚ - å‘Šè­¦è¦å‰‡è©•ä¼° (æ¯ 15 ç§’)                               â”‚â”‚
â”‚  â”‚ - å‘Šè­¦èšåˆèˆ‡å»é‡                                        â”‚â”‚
â”‚  â”‚ - å¤šæ¸ é“é€šçŸ¥ (Email, Slack, PagerDuty)                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¯è¦–åŒ–å±¤ (Dashboards)                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Grafana      â”‚ Grafana      â”‚ Sentry Dashboard         â”‚ â”‚
â”‚  â”‚ (ç³»çµ±ç¸½è¦½)   â”‚ (æœå‹™è©³æƒ…)   â”‚ (éŒ¯èª¤åˆ†æ)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š é—œéµæŒ‡æ¨™ (Metrics)

### 1. API æ•ˆèƒ½æŒ‡æ¨™

| æŒ‡æ¨™ | é¡å‹ | æè¿° | å‘Šè­¦é–¾å€¼ |
|------|------|------|---------|
| `api_request_duration_seconds` | Histogram | API è«‹æ±‚å»¶é² (ms) | P95 > 1000ms, P99 > 2000ms |
| `api_requests_total` | Counter | ç¸½è«‹æ±‚æ•¸ (æŒ‰ç«¯é»åˆ†é¡) | - |
| `api_errors_total` | Counter | éŒ¯èª¤è«‹æ±‚æ•¸ (æŒ‰ç‹€æ…‹ç¢¼) | 5xx éŒ¯èª¤ç‡ > 1% |
| `api_request_size_bytes` | Histogram | è«‹æ±‚å¤§å°åˆ†å¸ƒ | - |
| `api_response_size_bytes` | Histogram | å›æ‡‰å¤§å°åˆ†å¸ƒ | - |

### 2. AI è©•åˆ†æœå‹™æŒ‡æ¨™

| æŒ‡æ¨™ | é¡å‹ | æè¿° | å‘Šè­¦é–¾å€¼ |
|------|------|------|---------|
| `scoring_duration_seconds` | Histogram | è©•åˆ†è€—æ™‚ (ç§’) | P95 > 60s |
| `scoring_success_total` | Counter | æˆåŠŸè©•åˆ†æ•¸ | - |
| `scoring_failure_total` | Counter | å¤±æ•—è©•åˆ†æ•¸ | å¤±æ•—ç‡ > 5% |
| `queue_length` | Gauge | è©•åˆ†éšŠåˆ—é•·åº¦ | > 100 ä»»å‹™ |
| `whisper_api_calls` | Counter | Whisper API å‘¼å«æ•¸ | - |
| `whisper_response_time_seconds` | Histogram | Whisper API å»¶é² | > 30s |

### 3. è³‡æ–™åº«æŒ‡æ¨™

| æŒ‡æ¨™ | é¡å‹ | æè¿° | å‘Šè­¦é–¾å€¼ |
|------|------|------|---------|
| `db_connections_active` | Gauge | æ´»èºé€£ç·šæ•¸ | > 80% é€£ç·šæ±  |
| `db_connections_waiting` | Gauge | ç­‰å¾…é€£ç·šæ•¸ | > 10 |
| `db_query_duration_seconds` | Histogram | æŸ¥è©¢å»¶é² | P95 > 500ms |
| `db_slow_queries_total` | Counter | æ…¢æŸ¥è©¢æ¬¡æ•¸ (> 1000ms) | > 5 æ¬¡/åˆ†é˜ |
| `db_transaction_duration_seconds` | Histogram | äº‹å‹™æ™‚é–“ | P95 > 2s |

### 4. å¿«å–æŒ‡æ¨™ (Redis)

| æŒ‡æ¨™ | é¡å‹ | æè¿° | å‘Šè­¦é–¾å€¼ |
|------|------|------|---------|
| `redis_connected_clients` | Gauge | é€£ç·šå®¢æˆ¶ç«¯æ•¸ | > 80% é™åˆ¶ |
| `redis_memory_used_bytes` | Gauge | å·²ç”¨è¨˜æ†¶é«” | > 80% æœ€å¤§è¨˜æ†¶é«” |
| `redis_hit_rate` | Gauge | å¿«å–å‘½ä¸­ç‡ | < 70% |
| `redis_evictions_total` | Counter | é©…é€æ•¸ | > 0 (è¡¨ç¤ºè¨˜æ†¶é«”ä¸è¶³) |
| `redis_command_duration_seconds` | Histogram | å‘½ä»¤å»¶é² | P95 > 100ms |

### 5. æª”æ¡ˆä¸Šå‚³æŒ‡æ¨™ (S3)

| æŒ‡æ¨™ | é¡å‹ | æè¿° | å‘Šè­¦é–¾å€¼ |
|------|------|------|---------|
| `s3_upload_duration_seconds` | Histogram | ä¸Šå‚³è€—æ™‚ (ç§’) | P95 > 30s |
| `s3_upload_size_bytes` | Histogram | ä¸Šå‚³å¤§å°åˆ†å¸ƒ | - |
| `s3_upload_errors_total` | Counter | ä¸Šå‚³å¤±æ•—æ•¸ | > 5% |
| `s3_api_calls` | Counter | S3 API å‘¼å«æ•¸ | - |

### 6. GitHub åŒæ­¥æŒ‡æ¨™

| æŒ‡æ¨™ | é¡å‹ | æè¿° | å‘Šè­¦é–¾å€¼ |
|------|------|------|---------|
| `github_sync_duration_seconds` | Histogram | åŒæ­¥è€—æ™‚ (ç§’) | > 600s (10 åˆ†é˜) |
| `github_sync_success_total` | Counter | æˆåŠŸåŒæ­¥æ¬¡æ•¸ | - |
| `github_sync_failure_total` | Counter | å¤±æ•—åŒæ­¥æ¬¡æ•¸ | é€£çºŒå¤±æ•— > 3 æ¬¡ |
| `github_api_rate_limit` | Gauge | å‰©é¤˜ API é™é¡ | < 100 requests |

### 7. Google Classroom åŒæ­¥æŒ‡æ¨™

| æŒ‡æ¨™ | é¡å‹ | æè¿° | å‘Šè­¦é–¾å€¼ |
|------|------|------|---------|
| `classroom_sync_duration_seconds` | Histogram | åŒæ­¥è€—æ™‚ (ç§’) | > 300s (5 åˆ†é˜) |
| `classroom_sync_success_total` | Counter | æˆåŠŸåŒæ­¥æ¬¡æ•¸ | - |
| `classroom_sync_failure_total` | Counter | å¤±æ•—åŒæ­¥æ¬¡æ•¸ | > 3 æ¬¡/å¤© |
| `classroom_api_rate_limit` | Gauge | å‰©é¤˜ API é™é¡ | - |

### 8. ç³»çµ±è³‡æºæŒ‡æ¨™

| æŒ‡æ¨™ | é¡å‹ | æè¿° | å‘Šè­¦é–¾å€¼ |
|------|------|------|---------|
| `process_cpu_seconds_total` | Counter | CPU æ™‚é–“ | - |
| `process_resident_memory_bytes` | Gauge | è¨˜æ†¶é«”ä½¿ç”¨ | > 80% |
| `process_open_fds` | Gauge | é–‹æ”¾çš„æª”æ¡ˆæè¿°ç¬¦ | > 80% é™åˆ¶ |
| `go_goroutines` | Gauge | Goroutine æ•¸é‡ | > 10000 |

### 9. HTTP ä¼ºæœå™¨æŒ‡æ¨™

| æŒ‡æ¨™ | é¡å‹ | æè¿° | å‘Šè­¦é–¾å€¼ |
|------|------|------|---------|
| `http_requests_total` | Counter | ç¸½ HTTP è«‹æ±‚æ•¸ | - |
| `http_request_duration_seconds` | Histogram | HTTP è«‹æ±‚å»¶é² | P95 > 1000ms |
| `http_requests_in_progress` | Gauge | é€²è¡Œä¸­çš„è«‹æ±‚æ•¸ | > 100 |

---

## ğŸ“ˆ Prometheus è¨­å®š

### 1. å®‰è£èˆ‡é…ç½®

```yaml
# docker-compose.yml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - ./alert-rules.yml:/etc/prometheus/alert-rules.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - "9090:9090"
    networks:
      - monitoring

  alertmanager:
    image: prom/alertmanager:latest
    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml
      - alertmanager-data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    ports:
      - "9093:9093"
    networks:
      - monitoring

volumes:
  prometheus-data:
  alertmanager-data:

networks:
  monitoring:
```

### 2. prometheus.yml é…ç½®

```yaml
# prometheus.yml
global:
  scrape_interval: 15s          # æŠ“å–é–“éš”
  evaluation_interval: 15s      # å‘Šè­¦è©•ä¼°é–“éš”
  external_labels:
    cluster: 'literacy-platform'
    environment: 'production'

# å‘Šè­¦è¦å‰‡æª”æ¡ˆ
rule_files:
  - '/etc/prometheus/alert-rules.yml'

# å‘Šè­¦é€šçŸ¥
alerting:
  alertmanagers:
    - static_configs:
        - targets: ['localhost:9093']

# æŠ“å–ç›®æ¨™
scrape_configs:
  # å¾Œç«¯ API æœå‹™
  - job_name: 'backend-api'
    static_configs:
      - targets: ['localhost:3000']
        labels:
          service: 'api'
    metrics_path: '/metrics'
    scrape_interval: 15s

  # AI è©•åˆ†æœå‹™
  - job_name: 'scoring-service'
    static_configs:
      - targets: ['localhost:3001']
        labels:
          service: 'scoring'
    metrics_path: '/metrics'

  # åŒæ­¥æœå‹™
  - job_name: 'sync-service'
    static_configs:
      - targets: ['localhost:3002']
        labels:
          service: 'sync'
    metrics_path: '/metrics'

  # Kubernetes Nodes (å¦‚æœä½¿ç”¨ K8s)
  - job_name: 'kubernetes-nodes'
    kubernetes_sd_configs:
      - role: node
    relabel_configs:
      - action: labelmap
        regex: __meta_kubernetes_node_label_(.+)

  # Kubernetes Pods
  - job_name: 'kubernetes-pods'
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
        action: keep
        regex: true
```

### 3. Node.js/NestJS æ•´åˆ

```typescript
// src/metrics/setup.ts
import { register, collectDefaultMetrics, Counter, Histogram, Gauge } from 'prom-client';
import * as express from 'express';

// æ”¶é›†é è¨­æŒ‡æ¨™ (CPU, è¨˜æ†¶é«”, Goroutines ç­‰)
collectDefaultMetrics();

// ============ API æŒ‡æ¨™ ============
export const apiRequestDuration = new Histogram({
  name: 'api_request_duration_seconds',
  help: 'API request duration in seconds',
  labelNames: ['method', 'path', 'status'],
  buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5, 10],
});

export const apiRequestsTotal = new Counter({
  name: 'api_requests_total',
  help: 'Total API requests',
  labelNames: ['method', 'path', 'status'],
});

export const apiErrors = new Counter({
  name: 'api_errors_total',
  help: 'Total API errors',
  labelNames: ['method', 'path', 'error_type'],
});

// ============ è©•åˆ†æœå‹™æŒ‡æ¨™ ============
export const scoringDuration = new Histogram({
  name: 'scoring_duration_seconds',
  help: 'Scoring duration in seconds',
  buckets: [5, 10, 30, 60, 120],
  labelNames: ['submission_type'],
});

export const scoringSuccess = new Counter({
  name: 'scoring_success_total',
  help: 'Total successful scorings',
  labelNames: ['submission_type'],
});

export const scoringFailure = new Counter({
  name: 'scoring_failure_total',
  help: 'Total failed scorings',
  labelNames: ['error_type'],
});

export const queueLength = new Gauge({
  name: 'queue_length',
  help: 'Current queue length',
  labelNames: ['queue_name'],
});

// ============ è³‡æ–™åº«æŒ‡æ¨™ ============
export const dbConnectionsActive = new Gauge({
  name: 'db_connections_active',
  help: 'Active database connections',
});

export const dbConnectionsWaiting = new Gauge({
  name: 'db_connections_waiting',
  help: 'Waiting database connections',
});

export const dbQueryDuration = new Histogram({
  name: 'db_query_duration_seconds',
  help: 'Database query duration',
  labelNames: ['query_type'],
  buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5],
});

export const dbSlowQueries = new Counter({
  name: 'db_slow_queries_total',
  help: 'Total slow queries (> 1000ms)',
  labelNames: ['query_type'],
});

// ============ Redis å¿«å–æŒ‡æ¨™ ============
export const redisMemoryUsed = new Gauge({
  name: 'redis_memory_used_bytes',
  help: 'Redis memory used in bytes',
});

export const redisHitRate = new Gauge({
  name: 'redis_hit_rate',
  help: 'Redis cache hit rate',
});

export const redisEvictions = new Counter({
  name: 'redis_evictions_total',
  help: 'Total Redis evictions',
});

// ============ Express ä¸­ä»‹è»Ÿé«” ============
export function metricsMiddleware(req: express.Request, res: express.Response, next: express.NextFunction) {
  const startTime = Date.now();

  // æ””æˆª res.send/json
  const originalSend = res.send;
  res.send = function (data) {
    const duration = (Date.now() - startTime) / 1000;

    // è¨˜éŒ„æŒ‡æ¨™
    apiRequestDuration
      .labels(req.method, req.path, res.statusCode)
      .observe(duration);

    apiRequestsTotal
      .labels(req.method, req.path, res.statusCode)
      .inc();

    // åµæ¸¬éŒ¯èª¤
    if (res.statusCode >= 400) {
      apiErrors
        .labels(req.method, req.path, `http_${res.statusCode}`)
        .inc();
    }

    return originalSend.call(this, data);
  };

  next();
}

// ============ æš´éœ² /metrics ç«¯é» ============
export function setupMetricsEndpoint(app: express.Application) {
  app.get('/metrics', (req, res) => {
    res.set('Content-Type', register.contentType);
    res.end(register.metrics());
  });
}
```

### 4. ä¸»æ‡‰ç”¨ç¨‹å¼æ•´åˆ

```typescript
// src/main.ts
import { NestFactory } from '@nestjs/core';
import { AppModule } from './app.module';
import { setupMetricsEndpoint, metricsMiddleware } from './metrics/setup';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  // è¨­å®š Prometheus
  setupMetricsEndpoint(app);
  app.use(metricsMiddleware);

  await app.listen(3000);
}

bootstrap();
```

---

## ğŸš¨ å‘Šè­¦è¦å‰‡ (Alert Rules)

### 1. alert-rules.yml é…ç½®

```yaml
# alert-rules.yml
groups:
  - name: api_alerts
    interval: 15s
    rules:
      # P1: API å®Œå…¨ä¸å¯ç”¨
      - alert: APIServerDown
        expr: up{job="backend-api"} == 0
        for: 1m
        labels:
          severity: critical
          service: api
        annotations:
          summary: "API ä¼ºæœå™¨å®•æ©Ÿ"
          description: "{{ $labels.instance }} API ä¼ºæœå™¨å·²é›¢ç·š"

      # P1: API é«˜å»¶é²
      - alert: APIHighLatency
        expr: histogram_quantile(0.95, rate(api_request_duration_seconds_bucket[5m])) > 1
        for: 3m
        labels:
          severity: critical
        annotations:
          summary: "API P95 å»¶é²è¶…é 1 ç§’"
          description: "{{ $value | humanizeDuration }} (é–¾å€¼: 1s)"

      # P2: API éŒ¯èª¤ç‡éé«˜
      - alert: APIHighErrorRate
        expr: |
          (
            sum(rate(api_requests_total{status=~"5.."}[5m]))
            /
            sum(rate(api_requests_total[5m]))
          ) > 0.01
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API 5xx éŒ¯èª¤ç‡è¶…é 1%"
          description: "éŒ¯èª¤ç‡: {{ $value | humanizePercentage }}"

  - name: scoring_alerts
    interval: 15s
    rules:
      # P1: è©•åˆ†éšŠåˆ—ç©å£“
      - alert: ScoringQueueBacklog
        expr: queue_length{queue_name="scoring"} > 100
        for: 5m
        labels:
          severity: critical
          service: scoring
        annotations:
          summary: "è©•åˆ†éšŠåˆ—ç©å£“"
          description: "éšŠåˆ—é•·åº¦: {{ $value }} ä»»å‹™"

      # P1: è©•åˆ†å¤±æ•—ç‡éé«˜
      - alert: ScoringHighFailureRate
        expr: |
          (
            sum(rate(scoring_failure_total[5m]))
            /
            (sum(rate(scoring_success_total[5m])) + sum(rate(scoring_failure_total[5m])))
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          service: scoring
        annotations:
          summary: "è©•åˆ†å¤±æ•—ç‡è¶…é 5%"
          description: "å¤±æ•—ç‡: {{ $value | humanizePercentage }}"

      # P2: è©•åˆ†è€—æ™‚éé•·
      - alert: ScoringHighLatency
        expr: histogram_quantile(0.95, rate(scoring_duration_seconds_bucket[5m])) > 60
        for: 5m
        labels:
          severity: warning
          service: scoring
        annotations:
          summary: "è©•åˆ† P95 è€—æ™‚è¶…é 60 ç§’"
          description: "è€—æ™‚: {{ $value | humanizeDuration }}"

  - name: database_alerts
    interval: 15s
    rules:
      # P1: è³‡æ–™åº«é€£ç·šè€—ç›¡
      - alert: DatabaseConnectionPoolExhausted
        expr: db_connections_active / 20 > 0.9  # å‡è¨­é€£ç·šæ± å¤§å° 20
        for: 2m
        labels:
          severity: critical
          service: database
        annotations:
          summary: "è³‡æ–™åº«é€£ç·šæ± å³å°‡è€—ç›¡"
          description: "æ´»èºé€£ç·š: {{ $value }} / 20"

      # P2: è³‡æ–™åº«æœ‰ç­‰å¾…é€£ç·š
      - alert: DatabaseConnectionsWaiting
        expr: db_connections_waiting > 5
        for: 2m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "æœ‰ {{ $value }} å€‹é€£ç·šç­‰å¾…ç²å–è³‡æ–™åº«é€£ç·š"
          description: "ç­‰å¾…é€£ç·šæ•¸: {{ $value }}"

      # P1: æ…¢æŸ¥è©¢é »ç¹å‡ºç¾
      - alert: DatabaseSlowQueries
        expr: rate(db_slow_queries_total[5m]) > 0.083  # > 5 æ¬¡/åˆ†é˜
        for: 5m
        labels:
          severity: critical
          service: database
        annotations:
          summary: "è³‡æ–™åº«æ…¢æŸ¥è©¢é »ç¹å‡ºç¾"
          description: "é »ç‡: {{ $value }} æ¬¡/ç§’ (> 5 æ¬¡/åˆ†é˜)"

      # P2: è³‡æ–™åº«æŸ¥è©¢å»¶é²
      - alert: DatabaseQueryHighLatency
        expr: histogram_quantile(0.95, rate(db_query_duration_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
          service: database
        annotations:
          summary: "è³‡æ–™åº«æŸ¥è©¢ P95 å»¶é²è¶…é 500ms"
          description: "å»¶é²: {{ $value | humanizeDuration }}"

  - name: redis_alerts
    interval: 15s
    rules:
      # P1: Redis è¨˜æ†¶é«”ç”¨ç›¡
      - alert: RedisMemoryAlmostFull
        expr: redis_memory_used_bytes / (512 * 1024 * 1024) > 0.9  # å‡è¨­ 512MB
        for: 2m
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "Redis è¨˜æ†¶é«”å³å°‡ç”¨ç›¡"
          description: "å·²ç”¨: {{ humanize $value }} / 512MB"

      # P2: Redis å‘½ä¸­ç‡ä½
      - alert: RedisCacheHitRateLow
        expr: redis_hit_rate < 0.7
        for: 10m
        labels:
          severity: warning
          service: redis
        annotations:
          summary: "Redis å¿«å–å‘½ä¸­ç‡ä½æ–¼ 70%"
          description: "å‘½ä¸­ç‡: {{ $value | humanizePercentage }}"

      # P1: Redis ç™¼ç”Ÿé©…é€
      - alert: RedisEvictions
        expr: rate(redis_evictions_total[5m]) > 0
        for: 1m
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "Redis è¨˜æ†¶é«”ä¸è¶³,é–‹å§‹é©…é€ key"
          description: "é©…é€ç‡: {{ $value }} æ¬¡/ç§’"

  - name: github_alerts
    interval: 15s
    rules:
      # P1: GitHub åŒæ­¥é€£çºŒå¤±æ•—
      - alert: GitHubSyncFailed
        expr: increase(github_sync_failure_total[1h]) >= 3
        labels:
          severity: critical
          service: sync
        annotations:
          summary: "GitHub åŒæ­¥é€£çºŒå¤±æ•—"
          description: "éå» 1 å°æ™‚å¤±æ•— {{ $value }} æ¬¡"

      # P2: GitHub API é…é¡å¿«ç”¨å®Œ
      - alert: GitHubAPIRateLimitLow
        expr: github_api_rate_limit < 100
        for: 5m
        labels:
          severity: warning
          service: sync
        annotations:
          summary: "GitHub API é…é¡å³å°‡ç”¨ç›¡"
          description: "å‰©é¤˜é…é¡: {{ $value }} requests"

  - name: classroom_alerts
    interval: 15s
    rules:
      # P1: Classroom åŒæ­¥å¤±æ•—
      - alert: ClassroomSyncFailed
        expr: increase(classroom_sync_failure_total[1d]) > 3
        labels:
          severity: warning
          service: sync
        annotations:
          summary: "Classroom åŒæ­¥å¤±æ•—"
          description: "éå» 24 å°æ™‚å¤±æ•— {{ $value }} æ¬¡"

  - name: system_alerts
    interval: 15s
    rules:
      # P1: è¨˜æ†¶é«”ä¸è¶³
      - alert: ProcessMemoryHigh
        expr: process_resident_memory_bytes / (1024 * 1024) > 800  # > 800MB
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "æ‡‰ç”¨ç¨‹å¼è¨˜æ†¶é«”ä½¿ç”¨éé«˜"
          description: "ä½¿ç”¨: {{ humanize $value }}MB"

      # P2: é–‹æ”¾æª”æ¡ˆæè¿°ç¬¦éå¤š
      - alert: ProcessOpenFileDescriptorsHigh
        expr: process_open_fds > 8000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "é–‹æ”¾æª”æ¡ˆæè¿°ç¬¦éå¤š"
          description: "æ•¸é‡: {{ $value }}"

      # P1: Goroutine æ´©æ¼
      - alert: GogoroutineLeaking
        expr: go_goroutines > 10000
        for: 10m
        labels:
          severity: critical
        annotations:
          summary: "å¯èƒ½ç™¼ç”Ÿ Goroutine æ´©æ¼"
          description: "Goroutine æ•¸: {{ $value }}"
```

---

## ğŸ”” å‘Šè­¦é€šçŸ¥ (Alertmanager)

### 1. alertmanager.yml é…ç½®

```yaml
# alertmanager.yml
global:
  resolve_timeout: 5m
  slack_api_url: 'YOUR_SLACK_WEBHOOK_URL'
  pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'

# å‘Šè­¦æ¨¡æ¿
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# è·¯ç”±è¦å‰‡
route:
  # é è¨­æ¥æ”¶å™¨
  receiver: 'null'

  # å‘Šè­¦åˆ†çµ„é…ç½®
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s       # ç­‰å¾… 10 ç§’å¾Œå†ç™¼é€ (èšåˆå‘Šè­¦)
  group_interval: 10s   # åŒçµ„å‘Šè­¦æœ€å¤šæ¯ 10 ç§’ç™¼é€ä¸€æ¬¡
  repeat_interval: 12h  # é‡è¤‡æœªè§£æ±ºçš„å‘Šè­¦ (æ¯ 12 å°æ™‚)

  # P1 å‘Šè­¦ (åš´é‡): ç«‹å³é€šçŸ¥ (Slack + Email + PagerDuty)
  routes:
    - match:
        severity: critical
      receiver: 'critical'
      group_wait: 0s    # ç«‹å³ç™¼é€
      repeat_interval: 1h

    # P2 å‘Šè­¦ (ä¸€èˆ¬): Slack é€šçŸ¥
    - match:
        severity: warning
      receiver: 'warning'
      group_wait: 5m
      repeat_interval: 4h

# æ¥æ”¶å™¨å®šç¾©
receivers:
  # ç©ºæ¥æ”¶å™¨ (å¿½ç•¥éé‡è¦å‘Šè­¦)
  - name: 'null'

  # P1 å‘Šè­¦æ¥æ”¶å™¨
  - name: 'critical'
    email_configs:
      - to: 'oncall@company.com'
        from: 'alerts@company.com'
        smarthost: 'smtp.gmail.com:587'
        auth_username: 'alerts@company.com'
        auth_password: 'YOUR_APP_PASSWORD'
        headers:
          Subject: '[CRITICAL] {{ .GroupLabels.alertname }} - {{ .GroupLabels.service }}'
        html: |
          <h2>{{ .GroupLabels.alertname }}</h2>
          <p>Service: {{ .GroupLabels.service }}</p>
          {{ range .Alerts }}
            <hr>
            <h3>{{ .Labels.alertname }}</h3>
            <p>{{ .Annotations.description }}</p>
            <pre>{{ .Annotations.summary }}</pre>
          {{ end }}

    slack_configs:
      - channel: '#alerts-critical'
        title: 'Critical Alert: {{ .GroupLabels.alertname }}'
        text: |
          Service: {{ .GroupLabels.service }}
          {{ range .Alerts }}
            â€¢ {{ .Annotations.summary }}
            {{ .Annotations.description }}
          {{ end }}
        color: 'danger'

    pagerduty_configs:
      - service_key: 'YOUR_PAGERDUTY_SERVICE_KEY'
        description: '{{ .GroupLabels.alertname }} on {{ .GroupLabels.service }}'

  # P2 å‘Šè­¦æ¥æ”¶å™¨
  - name: 'warning'
    slack_configs:
      - channel: '#alerts-warning'
        title: 'Warning: {{ .GroupLabels.alertname }}'
        text: |
          Service: {{ .GroupLabels.service }}
          {{ range .Alerts }}
            â€¢ {{ .Annotations.summary }}
          {{ end }}
        color: 'warning'

    email_configs:
      - to: 'dev-team@company.com'
        from: 'alerts@company.com'
        smarthost: 'smtp.gmail.com:587'
        auth_username: 'alerts@company.com'
        auth_password: 'YOUR_APP_PASSWORD'
        headers:
          Subject: '[WARNING] {{ .GroupLabels.alertname }}'

# å‘Šè­¦æŠ‘åˆ¶è¦å‰‡ (é˜²æ­¢å‘Šè­¦é¢¨æš´)
inhibit_rules:
  # å¦‚æœ DB å®•æ©Ÿ,æŠ‘åˆ¶å¾ŒçºŒçš„ DB æŸ¥è©¢å»¶é²å‘Šè­¦
  - source_match:
      severity: critical
      service: database
    target_match:
      severity: warning
      service: database
    equal: ['cluster']

  # API ä¼ºæœå™¨å®•æ©Ÿæ™‚,æŠ‘åˆ¶å¾ŒçºŒçš„éŒ¯èª¤ç‡å‘Šè­¦
  - source_match:
      severity: critical
      alertname: 'APIServerDown'
    target_match:
      severity: warning
      alertname: 'APIHighErrorRate'
    equal: ['cluster']
```

### 2. è‡ªè¨‚é€šçŸ¥æ¨¡æ¿

```
# /etc/alertmanager/templates/email.tmpl
{{ define "email.html" }}
<!DOCTYPE html>
<html>
<head>
  <style>
    body { font-family: Arial, sans-serif; }
    .critical { color: #d32f2f; }
    .warning { color: #f57c00; }
    .alert-box { border-left: 4px solid #d32f2f; padding: 10px; margin: 10px 0; background: #fff3e0; }
  </style>
</head>
<body>
  <h1 class="{{ .GroupLabels.severity }}">{{ .GroupLabels.alertname }}</h1>

  <p><strong>æ™‚é–“:</strong> {{ .GroupLabels.alertname }}</p>
  <p><strong>æœå‹™:</strong> {{ .GroupLabels.service }}</p>

  {{ range .Alerts }}
  <div class="alert-box">
    <h3>{{ .Labels.alertname }}</h3>
    <p><strong>æ‘˜è¦:</strong> {{ .Annotations.summary }}</p>
    <p><strong>æè¿°:</strong> {{ .Annotations.description }}</p>
    <p><strong>ç‹€æ…‹:</strong> {{ .Status }}</p>
  </div>
  {{ end }}

  <hr>
  <p><a href="http://prometheus.example.com">æŸ¥çœ‹ Prometheus å„€è¡¨æ¿</a></p>
</body>
</html>
{{ end }}
```

---

## ğŸ“Š Grafana å„€è¡¨æ¿è¨­è¨ˆ

### 1. ç³»çµ±ç¸½è¦½ Dashboard

```json
{
  "dashboard": {
    "title": "ç³»çµ±ç¸½è¦½",
    "panels": [
      {
        "title": "API ç‹€æ…‹",
        "targets": [
          {
            "expr": "up{job='backend-api'}"
          }
        ],
        "type": "stat",
        "thresholds": {
          "mode": "absolute",
          "steps": [
            { "value": null, "color": "green" },
            { "value": 0, "color": "red" }
          ]
        }
      },
      {
        "title": "API è«‹æ±‚é€Ÿç‡ (req/s)",
        "targets": [
          {
            "expr": "sum(rate(api_requests_total[1m]))"
          }
        ],
        "type": "graph"
      },
      {
        "title": "API P95 å»¶é² (ms)",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(api_request_duration_seconds_bucket[5m])) * 1000"
          }
        ],
        "type": "gauge",
        "thresholds": {
          "mode": "absolute",
          "steps": [
            { "value": null, "color": "green" },
            { "value": 500, "color": "yellow" },
            { "value": 1000, "color": "red" }
          ]
        }
      },
      {
        "title": "éŒ¯èª¤ç‡",
        "targets": [
          {
            "expr": "(sum(rate(api_requests_total{status=~'5..'}[5m])) / sum(rate(api_requests_total[5m]))) * 100"
          }
        ],
        "type": "gauge",
        "thresholds": {
          "steps": [
            { "value": null, "color": "green" },
            { "value": 0.5, "color": "yellow" },
            { "value": 1, "color": "red" }
          ]
        }
      },
      {
        "title": "è©•åˆ†éšŠåˆ—é•·åº¦",
        "targets": [
          {
            "expr": "queue_length{queue_name='scoring'}"
          }
        ],
        "type": "gauge",
        "thresholds": {
          "steps": [
            { "value": null, "color": "green" },
            { "value": 50, "color": "yellow" },
            { "value": 100, "color": "red" }
          ]
        }
      },
      {
        "title": "è©•åˆ†å¤±æ•—ç‡",
        "targets": [
          {
            "expr": "(sum(rate(scoring_failure_total[5m])) / (sum(rate(scoring_success_total[5m])) + sum(rate(scoring_failure_total[5m])))) * 100"
          }
        ],
        "type": "gauge"
      },
      {
        "title": "è³‡æ–™åº«é€£ç·šä½¿ç”¨ç‡",
        "targets": [
          {
            "expr": "db_connections_active / 20 * 100"
          }
        ],
        "type": "gauge",
        "thresholds": {
          "steps": [
            { "value": null, "color": "green" },
            { "value": 70, "color": "yellow" },
            { "value": 90, "color": "red" }
          ]
        }
      },
      {
        "title": "Redis è¨˜æ†¶é«”ä½¿ç”¨ç‡",
        "targets": [
          {
            "expr": "redis_memory_used_bytes / (512 * 1024 * 1024) * 100"
          }
        ],
        "type": "gauge"
      }
    ]
  }
}
```

### 2. æœå‹™è©³æƒ… Dashboard (API æœå‹™)

```json
{
  "dashboard": {
    "title": "API æœå‹™è©³æƒ…",
    "panels": [
      {
        "title": "è«‹æ±‚åˆ†å¸ƒ (æŒ‰ç«¯é»)",
        "targets": [
          {
            "expr": "sum by (path) (rate(api_requests_total[5m]))"
          }
        ],
        "type": "piechart"
      },
      {
        "title": "å»¶é²åˆ†å¸ƒ (åˆ†ä½æ•¸)",
        "targets": [
          {
            "expr": "histogram_quantile(0.5, rate(api_request_duration_seconds_bucket[5m])) * 1000",
            "legendFormat": "P50"
          },
          {
            "expr": "histogram_quantile(0.95, rate(api_request_duration_seconds_bucket[5m])) * 1000",
            "legendFormat": "P95"
          },
          {
            "expr": "histogram_quantile(0.99, rate(api_request_duration_seconds_bucket[5m])) * 1000",
            "legendFormat": "P99"
          }
        ],
        "type": "graph"
      },
      {
        "title": "ç‹€æ…‹ç¢¼åˆ†å¸ƒ",
        "targets": [
          {
            "expr": "sum by (status) (rate(api_requests_total[5m]))"
          }
        ],
        "type": "graph"
      },
      {
        "title": "éŒ¯èª¤é¡å‹",
        "targets": [
          {
            "expr": "sum by (error_type) (rate(api_errors_total[5m]))"
          }
        ],
        "type": "table"
      }
    ]
  }
}
```

### 3. è©•åˆ†æœå‹™ Dashboard

```json
{
  "dashboard": {
    "title": "AI è©•åˆ†æœå‹™",
    "panels": [
      {
        "title": "è©•åˆ†ååé‡ (æ¬¡/ç§’)",
        "targets": [
          {
            "expr": "sum(rate(scoring_success_total[1m]))",
            "legendFormat": "æˆåŠŸ"
          },
          {
            "expr": "sum(rate(scoring_failure_total[1m]))",
            "legendFormat": "å¤±æ•—"
          }
        ],
        "type": "graph"
      },
      {
        "title": "è©•åˆ†è€—æ™‚åˆ†å¸ƒ",
        "targets": [
          {
            "expr": "histogram_quantile(0.5, rate(scoring_duration_seconds_bucket[5m]))",
            "legendFormat": "P50"
          },
          {
            "expr": "histogram_quantile(0.95, rate(scoring_duration_seconds_bucket[5m]))",
            "legendFormat": "P95"
          }
        ],
        "type": "graph"
      },
      {
        "title": "éšŠåˆ—é•·åº¦è¶¨å‹¢",
        "targets": [
          {
            "expr": "queue_length{queue_name='scoring'}"
          }
        ],
        "type": "graph"
      },
      {
        "title": "Whisper API èª¿ç”¨",
        "targets": [
          {
            "expr": "sum(rate(whisper_api_calls[1m]))"
          }
        ],
        "type": "graph"
      }
    ]
  }
}
```

---

## ğŸ“ æ—¥èªŒèšåˆ (Loki)

### 1. docker-compose.yml é…ç½®

```yaml
  loki:
    image: grafana/loki:latest
    volumes:
      - ./loki-config.yml:/etc/loki/local-config.yml
      - loki-data:/loki
    command: -config.file=/etc/loki/local-config.yml
    ports:
      - "3100:3100"
    networks:
      - monitoring

  promtail:
    image: grafana/promtail:latest
    volumes:
      - ./promtail-config.yml:/etc/promtail/config.yml
      - /var/log:/var/log
      - /var/lib/docker/containers:/var/lib/docker/containers
    command: -config.file=/etc/promtail/config.yml
    networks:
      - monitoring
```

### 2. loki-config.yml é…ç½®

```yaml
auth_enabled: false

ingester:
  chunk_idle_period: 3m
  chunk_retain_period: 1m
  max_chunk_age: 1h
  chunk_size_target: 1048576

schema_config:
  configs:
    - from: 2020-10-24
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

storage_config:
  boltdb_shipper:
    active_index_directory: /loki/boltdb-shipper-active
    cache_location: /loki/boltdb-shipper-cache
  filesystem:
    directory: /loki/chunks

limits_config:
  enforce_metric_name: false
  reject_old_samples: true
  reject_old_samples_max_age: 168h

chunk_store_config:
  max_look_back_period: 0s

table_manager:
  retention_deletes_enabled: false
  retention_period: 0s

server:
  http_listen_port: 3100
```

### 3. promtail-config.yml é…ç½®

```yaml
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # æ‡‰ç”¨ç¨‹å¼æ—¥èªŒ
  - job_name: application
    static_configs:
      - targets:
          - localhost
        labels:
          job: application
          __path__: /var/log/app/*.log

  # Docker æ—¥èªŒ
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: container_name
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: stream

  # Kubernetes Pod æ—¥èªŒ
  - job_name: kubernetes
    kubernetes_sd_configs:
      - role: pod
    relabel_configs:
      - source_labels: [__meta_kubernetes_pod_name]
        target_label: pod
      - source_labels: [__meta_kubernetes_namespace]
        target_label: namespace
```

### 4. æ‡‰ç”¨ç¨‹å¼ä¸­ä½¿ç”¨ Loki

```typescript
// src/logger/loki.logger.ts
import * as winston from 'winston';
import LokiTransport from 'winston-loki';

export const logger = winston.createLogger({
  level: 'info',
  format: winston.format.json(),
  defaultMeta: { service: 'literacy-platform' },
  transports: [
    // åŒæ™‚å¯«åˆ° Console å’Œ Loki
    new winston.transports.Console({
      format: winston.format.simple(),
    }),
    new LokiTransport({
      host: process.env.LOKI_HOST || 'http://localhost:3100',
      labels: { app: 'literacy-platform', env: process.env.NODE_ENV },
      json: true,
      interval: 5,
    }),
  ],
});

// ä½¿ç”¨ç¯„ä¾‹
logger.info('API request started', {
  method: 'GET',
  path: '/api/courses',
  userId: 123,
});

logger.error('Scoring failed', {
  submissionId: 'sub-123',
  error: 'Whisper API timeout',
});
```

### 5. Grafana ä¸­æŸ¥è©¢æ—¥èªŒ

```
# æŸ¥è©¢æ‰€æœ‰ "ERROR" ç´šåˆ¥çš„æ—¥èªŒ
{job="application"} | "ERROR"

# æŸ¥è©¢ç‰¹å®šæœå‹™çš„æ—¥èªŒ
{service="scoring"} |= "failure"

# æŸ¥è©¢è©•åˆ†ç›¸é—œçš„æ—¥èªŒ,ä¸¦çµ±è¨ˆéŒ¯èª¤æ•¸
{service="scoring"} | json | __error__=""
| stats count() by error_type

# æŸ¥è©¢ API æ—¥èªŒ,éæ¿¾æ…¢è«‹æ±‚ (>1000ms)
{job="api"} | json | duration > 1000
| stats avg(duration) by path
```

---

## ğŸ” APM - Application Performance Monitoring (Sentry)

### 1. Sentry è¨­å®š

```typescript
// src/main.ts
import * as Sentry from "@sentry/node";

// åˆå§‹åŒ– Sentry
Sentry.init({
  dsn: process.env.SENTRY_DSN || 'https://YOUR_KEY@sentry.io/YOUR_PROJECT',
  environment: process.env.NODE_ENV || 'development',
  tracesSampleRate: 0.1,  // 10% çš„è«‹æ±‚é€²è¡Œè¿½è¹¤
  profilesSampleRate: 0.1, // 10% é€²è¡Œ Profiling
  integrations: [
    new Sentry.Integrations.Http({ tracing: true }),
    new Sentry.Integrations.Express({ app: true, request: true }),
    new Sentry.Integrations.OnUncaughtException(),
    new Sentry.Integrations.OnUnhandledRejection(),
  ],
});

const app = express();

// Sentry è«‹æ±‚è™•ç†
app.use(Sentry.Handlers.requestHandler());
app.use(Sentry.Handlers.tracingHandler());

// æ‡‰ç”¨è·¯ç”±...

// Sentry éŒ¯èª¤è™•ç†
app.use(Sentry.Handlers.errorHandler());
```

### 2. æ‰‹å‹•äº‹ä»¶è¨˜éŒ„

```typescript
// src/services/ScoringEngine.ts
import * as Sentry from "@sentry/node";

export class ScoringEngine {
  async scoreSubmission(submissionId: string) {
    const transaction = Sentry.startTransaction({
      name: "scoreSubmission",
      op: "http.request",
    });

    try {
      // STT
      const child = transaction.startChild({
        op: "whisper.transcribe",
        description: "Transcribe audio to text",
      });
      const transcript = await whisper.transcribe(audioUrl);
      child.end();

      // æ–‡å­—æ¯”å°
      const child2 = transaction.startChild({
        op: "text.compare",
        description: "Compare recognized vs expected text",
      });
      const accuracy = this.compareText(expected, transcript);
      child2.end();

      transaction.setData("submissionId", submissionId);
      transaction.setData("finalScore", finalScore);
      transaction.finish();

      return { score: finalScore };
    } catch (error) {
      // æ•ç²éŒ¯èª¤
      Sentry.captureException(error, {
        contexts: {
          submission: {
            id: submissionId,
            status: "failed",
          },
        },
        level: "error",
      });

      transaction.setStatus("internal_error");
      transaction.finish();
      throw error;
    }
  }
}
```

### 3. Sentry Release è¿½è¹¤

```typescript
// src/main.ts
import * as Sentry from "@sentry/node";

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  // è¨­å®š Release ç‰ˆæœ¬
  release: process.env.APP_VERSION || '1.0.0',
  environment: process.env.NODE_ENV,
});

// æ¨™è¨˜é‡è¦äº‹ä»¶
Sentry.captureMessage("Application started", "info");
```

### 4. Sentry Dashboard æŒ‡æ¨™

- éŒ¯èª¤è¶¨å‹¢ (Error Trends)
- å´©æ½°ç‡ (Crash Rate)
- æ•ˆèƒ½æŒ‡æ¨™ (Web Vitals)
- ç”¨æˆ¶å—å½±éŸ¿äººæ•¸ (Affected Users)
- ç™¼ä½ˆç‰ˆæœ¬è¿½è¹¤ (Release Tracking)

---

## â¤ï¸ å¥åº·æª¢æŸ¥ç«¯é»

### 1. å¥åº·æª¢æŸ¥å¯¦ä½œ

```typescript
// src/health/health.controller.ts
import { Controller, Get } from '@nestjs/common';
import { HealthCheck, HealthCheckService, DatabaseHealthIndicator, MemoryHealthIndicator } from '@nestjs/terminus';
import { HttpHealthIndicator } from '@nestjs/terminus';

@Controller('health')
export class HealthController {
  constructor(
    private health: HealthCheckService,
    private db: DatabaseHealthIndicator,
    private memory: MemoryHealthIndicator,
    private http: HttpHealthIndicator,
  ) {}

  /**
   * ç°¡å–®å¥åº·æª¢æŸ¥ (ç”¨æ–¼ K8s Probe)
   */
  @Get()
  @HealthCheck()
  check() {
    return this.health.check([
      // æª¢æŸ¥è³‡æ–™åº«é€£ç·š
      () => this.db.pingCheck('database', { timeout: 1000 }),

      // æª¢æŸ¥è¨˜æ†¶é«”ä½¿ç”¨
      () => this.memory.checkHeap('memory_heap', 300 * 1024 * 1024), // 300MB
      () => this.memory.checkRSS('memory_rss', 500 * 1024 * 1024),   // 500MB

      // æª¢æŸ¥å¤–éƒ¨æœå‹™
      () => this.http.pingCheck('whisper_api', 'http://whisper:8000/health'),
      () => this.http.pingCheck('redis', 'http://redis:6379'),
    ]);
  }

  /**
   * è©³ç´°å¥åº·æª¢æŸ¥
   */
  @Get('detailed')
  async getDetailedHealth() {
    return {
      status: 'ok',
      timestamp: new Date().toISOString(),
      services: {
        api: { status: 'up' },
        database: await this.checkDatabase(),
        redis: await this.checkRedis(),
        s3: await this.checkS3(),
        whisper: await this.checkWhisper(),
        github: await this.checkGitHub(),
        classroom: await this.checkClassroom(),
      },
    };
  }

  private async checkDatabase() {
    try {
      const startTime = Date.now();
      await this.db.pingCheck('database', { timeout: 1000 });
      return {
        status: 'up',
        latency_ms: Date.now() - startTime,
      };
    } catch (error) {
      return { status: 'down', error: error.message };
    }
  }

  private async checkRedis() {
    try {
      // é€£ç·šåˆ° Redis ä¸¦åŸ·è¡Œ PING
      const result = await redisClient.ping();
      return { status: result === 'PONG' ? 'up' : 'down' };
    } catch (error) {
      return { status: 'down', error: error.message };
    }
  }

  private async checkS3() {
    try {
      // åŸ·è¡Œ ListBuckets
      await s3.listBuckets().promise();
      return { status: 'up' };
    } catch (error) {
      return { status: 'down', error: error.message };
    }
  }

  private async checkWhisper() {
    try {
      const response = await fetch('http://whisper:8000/health');
      return { status: response.ok ? 'up' : 'down' };
    } catch (error) {
      return { status: 'down', error: error.message };
    }
  }

  private async checkGitHub() {
    try {
      const response = await fetch('https://api.github.com/octocat');
      return { status: response.ok ? 'up' : 'down' };
    } catch (error) {
      return { status: 'down', error: error.message };
    }
  }

  private async checkClassroom() {
    try {
      // æª¢æŸ¥ OAuth token æ˜¯å¦æœ‰æ•ˆ
      const response = await classroom.courses.list();
      return { status: 'up' };
    } catch (error) {
      return { status: 'down', error: error.message };
    }
  }
}
```

### 2. Kubernetes Probe é…ç½®

```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: literacy-platform-backend
spec:
  replicas: 3
  template:
    spec:
      containers:
      - name: backend
        image: literacy-platform:latest

        # å­˜æ´»æ€§æ¢é‡ (Liveness Probe)
        # ç”¨æ–¼åˆ¤æ–·å®¹å™¨æ˜¯å¦é‚„æ´»è‘—,è‹¥å¤±æ•—å‰‡é‡å•Ÿå®¹å™¨
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        # å°±ç·’æ€§æ¢é‡ (Readiness Probe)
        # ç”¨æ–¼åˆ¤æ–·å®¹å™¨æ˜¯å¦å·²æº–å‚™å¥½æ¥æ”¶æµé‡
        readinessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 2

        # å•Ÿå‹•æ€§æ¢é‡ (Startup Probe)
        # ç”¨æ–¼åˆ¤æ–·æ‡‰ç”¨ç¨‹å¼æ˜¯å¦å·²å•Ÿå‹• (æ–°å¢æ–¼ K8s 1.16+)
        startupProbe:
          httpGet:
            path: /health
            port: 3000
          failureThreshold: 30
          periodSeconds: 2
```

### 3. Docker å¥åº·æª¢æŸ¥

```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --production

COPY . .

# å¥åº·æª¢æŸ¥
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3000/health', (r) => {if (r.statusCode !== 200) throw new Error(r.statusCode)})"

EXPOSE 3000

CMD ["node", "dist/main.js"]
```

---

## ğŸ“ˆ ç›£æ§å„€è¡¨æ¿æª¢æŸ¥æ¸…å–®

### æ—¥å¸¸å·¡æª¢ (Daily Checklist)

```
æ¯æ—¥ä¸Šç­æª¢æŸ¥ (9 AM):
â–¡ API ç‹€æ…‹ (Grafana ç³»çµ±ç¸½è¦½)
â–¡ è©•åˆ†éšŠåˆ—é•·åº¦ (< 50)
â–¡ éŒ¯èª¤ç‡ (< 0.5%)
â–¡ è³‡æ–™åº«é€£ç·š (< 50%)
â–¡ Redis å‘½ä¸­ç‡ (> 70%)

æ¯é€±æª¢æŸ¥ (é€±ä¸€):
â–¡ æŸ¥çœ‹å‘Šè­¦æ­·å² (æ˜¯å¦æœ‰é‡è¤‡å‘Šè­¦)
â–¡ æª¢æŸ¥åŒæ­¥æœå‹™æ—¥èªŒ (GitHub / Classroom)
â–¡ é©—è­‰å‚™ä»½å®Œæ•´æ€§
â–¡ æª¢æŸ¥ç£ç¢Ÿä½¿ç”¨ç‡

æ¯æœˆæª¢æŸ¥:
â–¡ Sentry éŒ¯èª¤åˆ†æ (Top 10 errors)
â–¡ æ€§èƒ½å„ªåŒ– (P95 å»¶é²è¶¨å‹¢)
â–¡ æˆæœ¬åˆ†æ (API èª¿ç”¨é‡ vs é ç®—)
â–¡ æ›´æ–°ä¾è³´åŒ…
```

---

## ğŸ”§ æ•…éšœæ’æŸ¥æŒ‡å—

### å¸¸è¦‹å•é¡Œ

```markdown
## 1. API å»¶é²çªç„¶å¢åŠ 
æ­¥é©Ÿ:
1. æŸ¥çœ‹ Grafana "API æœå‹™è©³æƒ…" â†’ æª¢æŸ¥å„ç«¯é»å»¶é²
2. æŸ¥çœ‹ "è³‡æ–™åº«" Dashboard â†’ æª¢æŸ¥æ…¢æŸ¥è©¢
3. æŸ¥çœ‹ "Redis" Dashboard â†’ æª¢æŸ¥å‘½ä¸­ç‡
4. æŸ¥çœ‹ Loki æ—¥èªŒ â†’ æœå°‹ "duration > 1000"

## 2. è©•åˆ†å¤±æ•—ç‡å¢åŠ 
æ­¥é©Ÿ:
1. æŸ¥çœ‹ Sentry â†’ æŸ¥çœ‹ "scoring_failure_total" éŒ¯èª¤é¡å‹
2. æŸ¥çœ‹ Loki â†’ æœå°‹ "service=scoring" + "error"
3. æª¢æŸ¥ Whisper API ç‹€æ…‹ (health check)
4. æª¢æŸ¥è©•åˆ†éšŠåˆ—é•·åº¦

## 3. è³‡æ–™åº«é€£ç·šè€—ç›¡
æ­¥é©Ÿ:
1. æŸ¥çœ‹ "db_connections_active" å’Œ "db_connections_waiting"
2. æŸ¥çœ‹ Loki "database" æ—¥èªŒ
3. æª¢æŸ¥æ˜¯å¦æœ‰é•·é€£ç·šæœªé—œé–‰
4. è‡¨æ™‚å¢åŠ é€£ç·šæ± å¤§å° (quick fix)
5. æ‰¾å‡ºå°è‡´é€£ç·šæ³„æ¼çš„æŸ¥è©¢

## 4. GitHub åŒæ­¥å¤±æ•—
æ­¥é©Ÿ:
1. æª¢æŸ¥ GitHub API é…é¡ (Grafana "github_api_rate_limit")
2. æŸ¥çœ‹åŒæ­¥æœå‹™æ—¥èªŒ (Loki)
3. é©—è­‰ GitHub token æ˜¯å¦éæœŸ
4. æ‰‹å‹•è§¸ç™¼åŒæ­¥æ¸¬è©¦
```

---

## ğŸ“ å‘Šè­¦éŸ¿æ‡‰æµç¨‹

```
å‘Šè­¦ç™¼ç”Ÿ (AlertManager)
    â†“
ç™¼é€é€šçŸ¥ (Slack + Email + PagerDuty)
    â†“
On-Call å·¥ç¨‹å¸«ç¢ºèª
    â†“
è©•ä¼°åš´é‡ç¨‹åº¦
    â”œâ†’ P1 (åš´é‡): ç«‹å³é–‹å§‹ä¿®å¾© (< 1 åˆ†é˜å…§æ‡‰å°)
    â”œâ†’ P2 (ä¸€èˆ¬): 1 å°æ™‚å…§æ‡‰å°
    â””â†’ P3 (ä½): å·¥ä½œæ™‚é–“å…§è™•ç†
    â†“
å¯¦æ–½è‡¨æ™‚ä¿®å¾© (å¦‚æœéœ€è¦)
    â†“
æ ¹æœ¬åŸå› åˆ†æ (RCA)
    â†“
å¯¦æ–½æ°¸ä¹…ä¿®å¾©
    â†“
åœ¨æ•…éšœæª¢è¨æœƒä¸Šç¸½çµ (äº‹å¾Œæª¢è¨)
```

---

## ğŸ’° ç›£æ§æˆæœ¬ä¼°ç®—

| æœå‹™ | æˆæœ¬ (æœˆ) | å‚™è¨» |
|------|----------|------|
| Prometheus | è‡ªå»º | å…è²» (è‡ªè¨—ç®¡) |
| Grafana Cloud | $79-200 | æ¨è–¦ç”¨æ–¼ç”Ÿç”¢ç’°å¢ƒ |
| Loki | è‡ªå»º | å…è²» (è‡ªè¨—ç®¡) |
| Sentry | $29-99 | æŒ‰æœˆä»˜è²» (æŒ‰äº‹ä»¶æ•¸) |
| PagerDuty | æŒ‰ç”¨æˆ¶è¨ˆè²» | å¯é¸,ç”¨æ–¼åš´é‡å‘Šè­¦ |
| **ç¸½è¨ˆ** | **$100-300/æœˆ** | ä¾ä½¿ç”¨é‡ |

---

## ğŸ¯ ç¸½çµ

### ç›£æ§æŒ‡æ¨™å„ªå…ˆç´š

| å„ªå…ˆç´š | æŒ‡æ¨™ | å‘Šè­¦æ–¹å¼ |
|--------|------|---------|
| **P1** | API å®•æ©Ÿ,è©•åˆ†å¤±æ•—ç‡,è³‡æ–™åº«é€£ç·šè€—ç›¡ | Slack + Email + PagerDuty |
| **P2** | é«˜å»¶é²,åŒæ­¥å¤±æ•—,è¨˜æ†¶é«”ä¸è¶³ | Slack + Email |
| **P3** | å‘½ä¸­ç‡ä½,é…é¡ä½ | Slack é€šçŸ¥ |

### é—œéµ SLA

| æŒ‡æ¨™ | ç›®æ¨™ | å‘Šè­¦é–¾å€¼ |
|------|------|---------|
| å¯ç”¨æ€§ | 99.9% (å¹´åœæ©Ÿ 8.6 å°æ™‚) | é€£çºŒåœæ©Ÿ > 1 åˆ†é˜ |
| API P95 å»¶é² | < 1000ms | > 1000ms (3 åˆ†é˜) |
| è©•åˆ†å¤±æ•—ç‡ | < 1% | > 5% (5 åˆ†é˜) |

---

## ğŸ“ å¾ŒçºŒæ–‡ä»¶

âœ… **å®Œæˆ**: ç›£æ§å‘Šè­¦è¨­è¨ˆ.md
â­ï¸ **ä¸‹ä¸€æ­¥**:
- æ¸¬è©¦ç­–ç•¥.md (å–®å…ƒæ¸¬è©¦ + æ•´åˆæ¸¬è©¦ + E2E)
- éƒ¨ç½²æ¶æ§‹è¨­è¨ˆ.md (Docker + Kubernetes)
- ç½é›£æ¢å¾©è¨ˆåŠƒ.md (Backup & Recovery)
