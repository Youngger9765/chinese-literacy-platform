# 系統設計文件總覽

> **專案**: 中文識字教育平台 - 醫護子女國語教學系統
>
> **設計完成日期**: 2026-02-13

---

## 📋 設計文件清單

### ✅ 核心技術設計 (本次完成 - 8 份)

| 文件 | 大小 | 重點內容 | 開發時程 |
|------|------|---------|---------|
| [**資料庫Schema設計.md**](./資料庫Schema設計.md) | 24 KB | PostgreSQL 完整 Schema<br>多租戶架構 (Platform → Org → School → Classroom)<br>ltree 課程階層結構<br>Row Level Security | - |
| [**GitHub同步服務設計.md**](./GitHub同步服務設計.md) | 22 KB | **Git Clone 同步** (避免 API Rate Limit)<br>Markdown 解析 (課文 + 生字 + 作業)<br>Webhook 即時更新<br>API 呼叫: 25/day (降低 98.6%) | 9 天 |
| [**GoogleClassroom整合設計.md**](./GoogleClassroom整合設計.md) | 21 KB | OAuth 2.0 登入流程<br>學生/教師名單同步<br>Refresh Token 加密儲存<br>100 requests/day (< 0.01% Quota) | 7 天 |
| [**AI評分引擎設計.md**](./AI評分引擎設計.md) | 23 KB | Whisper STT (Azure Speech API)<br>發音準確度 (音素比對)<br>流暢度 (語速 + 停頓)<br>準確性 (Levenshtein Distance)<br>綜合評分 (40% + 30% + 30%) | 14 天 |
| [**前端設計.md**](./前端設計.md) | 26 KB | React + TypeScript + TailwindCSS<br>學生端 (Dashboard + 作業提交 + 錄音)<br>教師端 (批改介面 + 數據分析)<br>AudioRecorder 組件<br>React Query 狀態管理 | 19 天 |
| [**部署架構設計.md**](./部署架構設計.md) | 45 KB | Docker + Kubernetes<br>CI/CD (GitHub Actions)<br>HPA 自動擴展<br>備份與災難恢復<br>成本: $437/月 (500 學生) | - |
| [**監控告警設計.md**](./監控告警設計.md) | 46 KB | Prometheus + Grafana + Loki + Sentry<br>9 組告警規則 (P1/P2 分級)<br>Alertmanager 多渠道通知<br>健康檢查端點 | - |
| [**測試策略.md**](./測試策略.md) | 63 KB | 測試金字塔 (80% Unit / 15% Integration / 5% E2E)<br>Playwright E2E 測試<br>Mock 策略<br>CI 整合<br>覆蓋率目標: >80% | - |

**小計**: 270 KB / 49 天開發時程

---

### 📊 前期研究文件 (6 份)

| 文件 | 大小 | 關鍵結論 |
|------|------|---------|
| [**API可行性驗證報告.md**](./API可行性驗證報告.md) | 22 KB | ❌ **Notion API 沒有版本歷史** (致命缺陷)<br>三平台整合: 5 週 → 32 週 (540% 增長)<br>**不推薦三平台整合** |
| [**GitHub-API-深度評估.md**](./GitHub-API-深度評估.md) | 18 KB | ✅ **用 Git Clone 取代 REST API**<br>API 呼叫: 355/day → 25/day (降低 98.6%)<br>完全避免 Secondary Rate Limit |
| [**PR當作交作業可行性評估.md**](./PR當作交作業可行性評估.md) | 9.5 KB | ❌ **不推薦用 PR 交作業**<br>5 大問題: 學生不會 Git, 隱私困難, 音檔不適合, 教師效率低, 高峰期風險 |
| [**方案-全部用GitHub.md**](./方案-全部用GitHub.md) | 20 KB | ✅ **GitHub-only 方案可行**<br>Markdown 課程 + Webhook<br>開發時程: 4 週 |
| [**資料主權與降級策略.md**](./資料主權與降級策略.md) | 27 KB | ✅ **核心資料必須在本地 PostgreSQL**<br>外部系統是「工具」不是「資料庫」<br>4 級降級策略 (Level 0-3) |
| [**完整系統設計-總覽.md**](./完整系統設計-總覽.md) | 15 KB | ✅ 系統架構圖 + 責任矩陣<br>8 個自問自答<br>成本: $253/月 (500 學生) |

**小計**: 111.5 KB

---

## 🎯 核心架構決策

### 最終技術棧

```
課程內容: GitHub (Markdown)
    ↓ Git Clone 同步 (每小時)
資料儲存: PostgreSQL + Redis
    ↓
後端 API: NestJS + TypeScript
    ├─ OAuth: Google Classroom
    ├─ STT: Azure Speech API (Whisper)
    └─ 檔案: AWS S3
    ↓
前端: React + TypeScript + TailwindCSS
    ├─ 學生端: Dashboard + 錄音提交
    └─ 教師端: 批改 + 數據分析
```

---

## ✅ 使用的外部系統

| 系統 | 功能 | API 呼叫量 | 成本 |
|------|------|-----------|------|
| **GitHub** | 課程內容 (Markdown) | 25/day | $0 |
| **Google Classroom** | OAuth 登入 + 學生名單 | 100/day | $0 |
| **Azure Speech API** | Whisper STT | 25,000 次/月 | $150/月 |
| **AWS S3** | 音檔儲存 | - | $2/月 |

---

## ❌ 不使用的系統 (與原因)

| 系統 | 不使用原因 |
|------|-----------|
| **Notion** | ❌ API 完全沒有版本歷史功能 (致命缺陷) |
| **GitHub REST API** | ❌ 會觸發 Secondary Rate Limit,改用 Git Clone |
| **GitHub PR** | ❌ 學生不會 Git、音檔不適合、教師效率低 |
| **Self-Hosted Whisper** | ❌ 成本高於 Azure ($330 vs $150/月) |

---

## 💰 成本分析 (500 學生)

### 月運營成本

| 項目 | 規格 | 月成本 |
|------|------|--------|
| AWS EC2 | t3.medium × 3 | $75 |
| AWS RDS | PostgreSQL db.t3.small | $40 |
| AWS S3 | 100 GB | $2 |
| Azure Speech API | 25,000 次 STT | $150 |
| Redis Cloud | 1 GB | $10 |
| CloudFront CDN | 1 TB | $85 |
| Kubernetes | EKS | $75 |
| **總計** | - | **$437/月** |

**人均成本**: $0.87/學生/月

### 開發成本

| 階段 | 時程 | 人力 |
|------|------|------|
| 後端開發 | 9 + 7 + 14 = 30 天 | 1 後端工程師 |
| 前端開發 | 19 天 | 1 前端工程師 |
| DevOps | 5 天 | 1 DevOps 工程師 |
| 測試 QA | 5 天 | 1 QA 工程師 |
| **總計** | **6 週 (並行)** | 4 人團隊 |

**預估總開發成本**: $27,500 (以 $110/hour 計算)

---

## 📅 開發里程碑 (6 週)

| 週次 | 後端 | 前端 | DevOps |
|------|------|------|--------|
| **W1** | PostgreSQL Schema + GitHub 同步 | React 基礎架構 | Docker Compose |
| **W2** | Google OAuth + Classroom 同步 | 學生端 Dashboard | CI/CD Pipeline |
| **W3** | AI 評分引擎 (Whisper + 分析) | 作業提交頁面 + 錄音 | Kubernetes 設置 |
| **W4** | Queue Worker + S3 整合 | 教師批改頁面 + 分析 | Monitoring 設置 |
| **W5** | API 完善 + 錯誤處理 | UI 優化 + 測試 | 壓力測試 |
| **W6** | 整合測試 | E2E 測試 | 上線部署 |

---

## 🎯 系統能力指標

### 功能覆蓋

| 功能類別 | 學生端 | 教師端 | 完成度 |
|---------|--------|--------|--------|
| **登入認證** | ✅ Google OAuth | ✅ Google OAuth | 設計完成 |
| **課程瀏覽** | ✅ Markdown 課文 + 生字 | ✅ GitHub 管理 | 設計完成 |
| **作業提交** | ✅ 錄音 + S3 上傳 | ❌ | 設計完成 |
| **AI 評分** | ✅ 即時評分 (< 2 分鐘) | ✅ 檢視詳情 | 設計完成 |
| **手動批改** | ❌ | ✅ 調整分數 + 回饋 | 設計完成 |
| **學習追蹤** | ✅ 進度條 + 成就 | ✅ 班級數據 | 設計完成 |

### 技術指標

| 指標 | 目標 | 預估達成 |
|------|------|---------|
| **API 響應時間** | < 200ms | ✅ 150ms (P95) |
| **評分速度** | < 2 分鐘 | ✅ 45 秒平均 |
| **同步延遲** | < 5 分鐘 | ✅ Webhook 即時 |
| **系統可用性** | > 99.5% | ✅ 3 副本 + HPA |
| **測試覆蓋率** | > 80% | ✅ 85% 目標 |

---

## 📊 文件統計

### 總覽

- **文件總數**: 14 份 (8 核心 + 6 研究)
- **總大小**: ~380 KB
- **完成日期**: 2026-02-13
- **設計時程**: 持續迭代 (從外部系統評估 → API 驗證 → 最終設計)

### 設計演進過程

```
Step 1: 外部系統評估 (Notion + GitHub + Classroom)
    ↓ 發現 Notion API 沒版本歷史
Step 2: API 可行性驗證
    ↓ 確認三平台整合成本太高 (32 週)
Step 3: 簡化方案 (GitHub + Classroom)
    ↓ 評估 PR 交作業 → 不可行
Step 4: GitHub API 深度研究
    ↓ 決定用 Git Clone (避免 Rate Limit)
Step 5: 資料主權設計
    ↓ 確立「外部系統是工具」原則
Step 6: 完整系統設計 (本次)
    ✅ 8 份核心技術文件完成
```

---

## 🚀 下一步行動

### 立即可開始的工作

1. **資料庫初始化** - 執行 `資料庫Schema設計.md` 中的 SQL 腳本
2. **Docker 開發環境** - 使用 `部署架構設計.md` 中的 docker-compose.yml
3. **GitHub Repo 準備** - 建立課程內容 Markdown Repo
4. **Google Cloud 設置** - 申請 OAuth Client ID (參考 `GoogleClassroom整合設計.md`)

### 需要確認的事項

- [ ] Azure Speech API Key 申請
- [ ] AWS 帳號與 S3 Bucket 建立
- [ ] Kubernetes Cluster 選擇 (EKS / GKE / AKS)
- [ ] GitHub Organization 建立
- [ ] Google Workspace 管理員授權

---

## 📞 文件維護

### 更新記錄

| 日期 | 更新內容 | 負責人 |
|------|---------|--------|
| 2026-02-13 | 完成 8 份核心技術設計文件 | Claude + Happy |
| 2026-02-13 | 創建系統設計文件總覽 | Claude + Happy |

### 文件規範

- **格式**: Markdown
- **版本控制**: Git
- **審核**: 技術負責人 Review
- **更新頻率**: 實作時同步更新

---

## 🎓 設計理念總結

### 三大核心原則

1. **資料主權** - 所有核心資料存在自己的資料庫,外部系統只是工具
2. **成本優化** - 用 Git Clone 避免 API Rate Limit,人均成本 < $1/月
3. **簡化架構** - 只用 2 個外部系統 (GitHub + Classroom),開發時程 6 週

### 關鍵技術決策

| 決策 | 選擇 | 替代方案 | 原因 |
|------|------|---------|------|
| 課程管理 | GitHub (Git Clone) | Notion | Notion API 無版本歷史 |
| 作業提交 | 資料庫 + S3 | GitHub PR | PR 不適合學生使用 |
| STT 引擎 | Azure Speech API | Self-Hosted Whisper | 成本更低 ($150 vs $330) |
| 登入方式 | Google OAuth | 自建帳號 | 整合 Classroom 名單 |

---

**Generated with [Claude Code](https://claude.ai/code) via [Happy](https://happy.engineering)**

Co-Authored-By: Claude <noreply@anthropic.com>
Co-Authored-By: Happy <yesreply@happy.engineering>
