# æ¸¬è©¦ç­–ç•¥

> **ç›®æ¨™**: å»ºç«‹å®Œæ•´çš„æ¸¬è©¦é‡‘å­—å¡”æ¶æ§‹,ç¢ºä¿ç³»çµ±ç©©å®šæ€§èˆ‡å¯é æ€§
>
> **åŸå‰‡**: å–®å…ƒæ¸¬è©¦ > æ•´åˆæ¸¬è©¦ > E2E æ¸¬è©¦,è‡ªå‹•åŒ–ç‚ºä¸»,æ‰‹å‹•æ¸¬è©¦è£œå……
>
> **è¦†è“‹ç‡ç›®æ¨™**: > 80% (é—œéµè·¯å¾‘ > 90%)

---

## ğŸ“Š æ¸¬è©¦é‡‘å­—å¡”æ¶æ§‹

```
                        â–²
                       /â”‚\
                      / â”‚ \
                     /  â”‚  \
                    /   â”‚   \
                   / E2E â”‚ 5% \
                  /â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€\
                 /       â”‚      \
                /  æ•´åˆæ¸¬è©¦  15% \
               /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€\
              /          â”‚         \
             / å–®å…ƒæ¸¬è©¦   80%  \
            /â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\
           â–¼

æ™‚é–“æˆæœ¬: â–²                  å“è³ªè¦†è“‹: â–º
å¿«é€ŸåŸ·è¡Œ    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>   é«˜åº¦è¦†è“‹
è‡ªå‹•åŒ–å¼·åº¦: é«˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> ä½
åŸ·è¡Œé »ç‡: æ¥µé »ç¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> æ¯æ—¥/é€±æ¬¡

æœ€ä½³å¯¦è¸:
- æ¯å€‹ commit å‰åŸ·è¡Œæ‰€æœ‰å–®å…ƒæ¸¬è©¦ (< 30s)
- æ¯å€‹ PR åŸ·è¡Œæ•´åˆæ¸¬è©¦ (< 2 min)
- æ¯å¤©å¤œé–“åŸ·è¡Œ E2E æ¸¬è©¦ (< 10 min)
- æ¯é€±åŸ·è¡Œæ•ˆèƒ½æ¸¬è©¦ (< 1 hour)
```

---

## 1ï¸âƒ£ å–®å…ƒæ¸¬è©¦ (80%)

### 1.1 æ¸¬è©¦æ¡†æ¶èˆ‡å·¥å…·

```typescript
// å¾Œç«¯: Jest + ts-jest
{
  "jest": {
    "preset": "ts-jest",
    "testEnvironment": "node",
    "testMatch": ["**/__tests__/**/*.test.ts", "**/*.spec.ts"],
    "collectCoverageFrom": [
      "src/**/*.ts",
      "!src/**/*.d.ts",
      "!src/main.ts"
    ],
    "coverageThreshold": {
      "global": {
        "branches": 80,
        "functions": 80,
        "lines": 80,
        "statements": 80
      }
    }
  }
}

// å‰ç«¯: Vitest + Testing Library
{
  "vitest": {
    "globals": true,
    "environment": "jsdom",
    "setupFiles": ["./src/test/setup.ts"],
    "coverage": {
      "provider": "v8",
      "reporter": ["text", "json", "html"],
      "include": ["src/**/*.{ts,tsx}"],
      "exclude": ["src/**/*.d.ts", "src/main.tsx"]
    }
  }
}
```

---

### 1.2 å¾Œç«¯å–®å…ƒæ¸¬è©¦ (Jest)

#### 1.2.1 æœå‹™å±¤æ¸¬è©¦ (Services)

```typescript
// src/services/__tests__/ai-scoring.service.test.ts

import { AIScoreService } from '../ai-scoring.service';
import { WhisperService } from '../../integrations/whisper.service';
import { PronunciationAnalyzer } from '../../ml/pronunciation-analyzer';

describe('AIScoreService', () => {
  let service: AIScoreService;
  let whisperService: jest.Mocked<WhisperService>;
  let pronunciationAnalyzer: jest.Mocked<PronunciationAnalyzer>;

  beforeEach(() => {
    whisperService = createMockWhisperService();
    pronunciationAnalyzer = createMockPronunciationAnalyzer();
    service = new AIScoreService(whisperService, pronunciationAnalyzer);
  });

  describe('calculateScore', () => {
    it('should calculate score correctly with perfect input', () => {
      const result = service.calculateScore({
        accuracy: 0.98,
        fluency: 0.95,
        tone: 0.92
      });
      expect(result).toBe(95);
    });

    it('should handle zero scores', () => {
      const result = service.calculateScore({
        accuracy: 0,
        fluency: 0,
        tone: 0
      });
      expect(result).toBe(0);
    });

    it('should round scores correctly', () => {
      const result = service.calculateScore({
        accuracy: 0.876,
        fluency: 0.885,
        tone: 0.891
      });
      expect(result).toBe(88);
    });

    it('should apply weighting factors', () => {
      const result1 = service.calculateScore({
        accuracy: 1.0,
        fluency: 0.5,
        tone: 0.5
      });
      const result2 = service.calculateScore({
        accuracy: 0.5,
        fluency: 1.0,
        tone: 0.5
      });
      // accuracy æ¬Šé‡æ›´é«˜
      expect(result1).toBeGreaterThan(result2);
    });
  });

  describe('transcribeAudio', () => {
    it('should transcribe audio file correctly', async () => {
      const audioUrl = 'https://s3.../audio.wav';
      whisperService.transcribe.mockResolvedValue({
        text: 'æˆ‘å«å°æ˜',
        confidence: 0.98,
        duration: 3.2
      });

      const result = await service.transcribeAudio(audioUrl);
      expect(result.text).toBe('æˆ‘å«å°æ˜');
      expect(whisperService.transcribe).toHaveBeenCalledWith(audioUrl);
    });

    it('should handle transcription errors gracefully', async () => {
      whisperService.transcribe.mockRejectedValue(
        new Error('Whisper API timeout')
      );

      await expect(service.transcribeAudio('invalid-url'))
        .rejects
        .toThrow('Whisper API timeout');
    });

    it('should handle empty audio', async () => {
      whisperService.transcribe.mockResolvedValue({
        text: '',
        confidence: 0,
        duration: 0
      });

      const result = await service.transcribeAudio('empty-audio.wav');
      expect(result.text).toBe('');
    });
  });

  describe('analyzePronunciation', () => {
    it('should analyze pronunciation correctly', async () => {
      pronunciationAnalyzer.analyze.mockResolvedValue({
        fluency: 0.92,
        tone: 0.88,
        clarity: 0.95
      });

      const result = await service.analyzePronunciation(
        'https://s3.../audio.wav',
        'æˆ‘å«å°æ˜'
      );
      expect(result.fluency).toBe(0.92);
      expect(pronunciationAnalyzer.analyze).toHaveBeenCalledWith(
        'https://s3.../audio.wav',
        'æˆ‘å«å°æ˜'
      );
    });

    it('should detect tone errors', async () => {
      pronunciationAnalyzer.analyze.mockResolvedValue({
        fluency: 0.85,
        tone: 0.45, // è²èª¿æœ‰å•é¡Œ
        clarity: 0.90
      });

      const result = await service.analyzePronunciation(
        'wrong-tone.wav',
        'åª½åª½'
      );
      expect(result.tone).toBeLessThan(0.5);
    });
  });

  describe('submitReading', () => {
    it('should complete full submission workflow', async () => {
      // æ¨¡æ“¬å®Œæ•´çš„æäº¤æµç¨‹
      whisperService.transcribe.mockResolvedValue({
        text: 'æˆ‘å«å°æ˜',
        confidence: 0.98,
        duration: 3.2
      });

      pronunciationAnalyzer.analyze.mockResolvedValue({
        fluency: 0.92,
        tone: 0.88,
        clarity: 0.95
      });

      const result = await service.submitReading({
        submissionId: 'sub-123',
        audioUrl: 'https://s3.../audio.wav',
        expectedText: 'æˆ‘å«å°æ˜'
      });

      expect(result.score).toBeGreaterThan(0);
      expect(result.transcript).toBe('æˆ‘å«å°æ˜');
      expect(result.feedback).toBeDefined();
    });

    it('should handle mismatched transcription', async () => {
      whisperService.transcribe.mockResolvedValue({
        text: 'æˆ‘å«å°ç‹', // ä¸åŒ¹é…é æœŸ
        confidence: 0.98,
        duration: 3.2
      });

      const result = await service.submitReading({
        submissionId: 'sub-123',
        audioUrl: 'https://s3.../audio.wav',
        expectedText: 'æˆ‘å«å°æ˜'
      });

      expect(result.accuracyMismatch).toBe(true);
      expect(result.feedback).toContain('ä¸åŒ¹é…');
    });
  });
});

// Mock å·¥å» å‡½æ•¸
function createMockWhisperService(): jest.Mocked<WhisperService> {
  return {
    transcribe: jest.fn(),
    uploadAudio: jest.fn()
  };
}

function createMockPronunciationAnalyzer(): jest.Mocked<PronunciationAnalyzer> {
  return {
    analyze: jest.fn(),
    detectToneErrors: jest.fn()
  };
}
```

#### 1.2.2 æ§åˆ¶å™¨å±¤æ¸¬è©¦ (Controllers)

```typescript
// src/controllers/__tests__/assignment.controller.test.ts

import { AssignmentController } from '../assignment.controller';
import { AssignmentService } from '../../services/assignment.service';

describe('AssignmentController', () => {
  let controller: AssignmentController;
  let service: jest.Mocked<AssignmentService>;

  beforeEach(() => {
    service = createMockAssignmentService();
    controller = new AssignmentController(service);
  });

  describe('getAssignments', () => {
    it('should return assignments for a classroom', async () => {
      const classroomId = 'classroom-123';
      service.getAssignments.mockResolvedValue([
        {
          id: 'assign-1',
          title: 'èª²æ–‡æœ—è®€',
          description: 'æœ—è®€ç¬¬ä¸€èª²',
          dueDate: new Date('2024-02-20')
        }
      ]);

      const result = await controller.getAssignments(classroomId);
      expect(result).toHaveLength(1);
      expect(result[0].title).toBe('èª²æ–‡æœ—è®€');
      expect(service.getAssignments).toHaveBeenCalledWith(classroomId);
    });

    it('should handle empty assignments', async () => {
      service.getAssignments.mockResolvedValue([]);
      const result = await controller.getAssignments('empty-classroom');
      expect(result).toEqual([]);
    });

    it('should handle service errors', async () => {
      service.getAssignments.mockRejectedValue(
        new Error('Database error')
      );

      await expect(controller.getAssignments('invalid-id'))
        .rejects
        .toThrow('Database error');
    });
  });

  describe('submitAssignment', () => {
    it('should accept valid submission', async () => {
      const submission = {
        assignmentId: 'assign-1',
        studentId: 'student-123',
        audioUrl: 'https://s3.../audio.wav',
        timestamp: new Date()
      };

      service.submitAssignment.mockResolvedValue({
        submissionId: 'sub-123',
        status: 'pending_review'
      });

      const result = await controller.submitAssignment(submission);
      expect(result.status).toBe('pending_review');
      expect(service.submitAssignment).toHaveBeenCalledWith(submission);
    });

    it('should reject late submission', async () => {
      service.submitAssignment.mockRejectedValue(
        new Error('Assignment deadline passed')
      );

      await expect(
        controller.submitAssignment({
          assignmentId: 'assign-1',
          studentId: 'student-123',
          audioUrl: 'https://s3.../audio.wav',
          timestamp: new Date('2024-02-25') // é€¾æœŸ
        })
      ).rejects.toThrow('deadline passed');
    });

    it('should validate required fields', async () => {
      const invalidSubmission = {
        assignmentId: '', // ç¼ºå°‘
        studentId: 'student-123',
        audioUrl: 'https://s3.../audio.wav',
        timestamp: new Date()
      };

      await expect(
        controller.submitAssignment(invalidSubmission)
      ).rejects.toThrow('validation');
    });
  });
});
```

#### 1.2.3 å·¥å…·å‡½æ•¸æ¸¬è©¦

```typescript
// src/utils/__tests__/score-calculator.test.ts

import { calculateScore, formatFeedback } from '../score-calculator';

describe('calculateScore', () => {
  it('should calculate score from accuracy, fluency, tone', () => {
    const score = calculateScore({
      accuracy: 0.95,
      fluency: 0.90,
      tone: 0.85
    });
    expect(score).toBeCloseTo(90, 0);
  });

  it('should apply correct weights', () => {
    // accuracy: 50%, fluency: 30%, tone: 20%
    const score = calculateScore({
      accuracy: 1.0,  // 50
      fluency: 0.0,   // 0
      tone: 0.0       // 0
    });
    expect(score).toBe(50);
  });
});

describe('formatFeedback', () => {
  it('should generate encouraging feedback for high scores', () => {
    const feedback = formatFeedback({ score: 95 });
    expect(feedback).toContain('å„ªç§€');
    expect(feedback).not.toContain('éœ€è¦æ”¹é€²');
  });

  it('should generate constructive feedback for low scores', () => {
    const feedback = formatFeedback({ score: 50 });
    expect(feedback).toContain('éœ€è¦åŠ å¼·');
  });
});
```

---

### 1.3 å‰ç«¯å–®å…ƒæ¸¬è©¦ (Vitest + Testing Library)

#### 1.3.1 å…ƒä»¶æ¸¬è©¦

```typescript
// src/components/__tests__/AudioRecorder.test.tsx

import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { AudioRecorder } from '../AudioRecorder';

describe('AudioRecorder', () => {
  beforeEach(() => {
    // Mock MediaRecorder API
    global.MediaRecorder = jest.fn(() => ({
      start: jest.fn(),
      stop: jest.fn(),
      ondataavailable: jest.fn(),
      onerror: jest.fn()
    }));
  });

  it('should render recording button', () => {
    render(<AudioRecorder onSubmit={jest.fn()} />);
    expect(screen.getByRole('button', { name: /é–‹å§‹éŒ„éŸ³/i }))
      .toBeInTheDocument();
  });

  it('should start recording when button clicked', async () => {
    const { rerender } = render(<AudioRecorder onSubmit={jest.fn()} />);

    const startButton = screen.getByRole('button', { name: /é–‹å§‹éŒ„éŸ³/i });
    fireEvent.click(startButton);

    await waitFor(() => {
      expect(screen.getByText(/éŒ„éŸ³ä¸­.../i)).toBeInTheDocument();
    });
  });

  it('should show stop button during recording', async () => {
    render(<AudioRecorder onSubmit={jest.fn()} />);

    fireEvent.click(screen.getByRole('button', { name: /é–‹å§‹éŒ„éŸ³/i }));

    await waitFor(() => {
      expect(screen.getByRole('button', { name: /åœæ­¢éŒ„éŸ³/i }))
        .toBeInTheDocument();
    });
  });

  it('should call onSubmit with audio blob', async () => {
    const onSubmit = jest.fn();
    render(<AudioRecorder onSubmit={onSubmit} />);

    // é–‹å§‹éŒ„éŸ³
    fireEvent.click(screen.getByRole('button', { name: /é–‹å§‹éŒ„éŸ³/i }));

    await waitFor(() => {
      fireEvent.click(screen.getByRole('button', { name: /åœæ­¢éŒ„éŸ³/i }));
    });

    await waitFor(() => {
      expect(onSubmit).toHaveBeenCalledWith(expect.any(Blob));
    });
  });

  it('should disable submit button during upload', async () => {
    const onSubmit = jest.fn().mockImplementation(
      () => new Promise(resolve => setTimeout(resolve, 1000))
    );
    render(<AudioRecorder onSubmit={onSubmit} />);

    // éŒ„éŸ³...
    fireEvent.click(screen.getByRole('button', { name: /é–‹å§‹éŒ„éŸ³/i }));
    await waitFor(() => {
      fireEvent.click(screen.getByRole('button', { name: /åœæ­¢éŒ„éŸ³/i }));
    });

    // æäº¤...
    const submitButton = screen.getByRole('button', { name: /æäº¤/i });
    fireEvent.click(submitButton);

    expect(submitButton).toBeDisabled();
  });

  it('should display error message on failure', async () => {
    const error = new Error('Microphone not available');
    render(<AudioRecorder onError={jest.fn()} />);

    // æ¨¡æ“¬éŒ„éŸ³å¤±æ•—
    const startButton = screen.getByRole('button', { name: /é–‹å§‹éŒ„éŸ³/i });
    fireEvent.click(startButton);

    // è§¸ç™¼éŒ¯èª¤
    global.MediaRecorder.mockImplementation(() => {
      throw error;
    });

    await waitFor(() => {
      expect(screen.getByText(/éº¥å…‹é¢¨ä¸å¯ç”¨/i)).toBeInTheDocument();
    });
  });
});
```

#### 1.3.2 Hook æ¸¬è©¦

```typescript
// src/hooks/__tests__/useAssignments.test.ts

import { renderHook, waitFor } from '@testing-library/react';
import { useAssignments } from '../useAssignments';

describe('useAssignments', () => {
  it('should fetch assignments on mount', async () => {
    const { result } = renderHook(() => useAssignments('classroom-123'));

    expect(result.current.loading).toBe(true);

    await waitFor(() => {
      expect(result.current.loading).toBe(false);
      expect(result.current.assignments).toHaveLength(3);
    });
  });

  it('should handle fetch errors', async () => {
    const { result } = renderHook(() => useAssignments('invalid-id'));

    await waitFor(() => {
      expect(result.current.error).toBeDefined();
      expect(result.current.assignments).toEqual([]);
    });
  });

  it('should refetch on classroomId change', async () => {
    const { result, rerender } = renderHook(
      ({ classroomId }) => useAssignments(classroomId),
      { initialProps: { classroomId: 'classroom-1' } }
    );

    await waitFor(() => {
      expect(result.current.assignments).toHaveLength(2);
    });

    rerender({ classroomId: 'classroom-2' });

    await waitFor(() => {
      expect(result.current.assignments).toHaveLength(3);
    });
  });
});
```

#### 1.3.3 é é¢æ¸¬è©¦

```typescript
// src/pages/__tests__/StudentAssignmentPage.test.tsx

import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { StudentAssignmentPage } from '../StudentAssignmentPage';
import * as router from 'react-router-dom';

vi.mock('react-router-dom', () => ({
  ...vi.importActual('react-router-dom'),
  useParams: vi.fn()
}));

describe('StudentAssignmentPage', () => {
  beforeEach(() => {
    vi.mocked(router.useParams).mockReturnValue({
      assignmentId: 'assign-123'
    } as any);
  });

  it('should render assignment title', async () => {
    render(<StudentAssignmentPage />);

    await waitFor(() => {
      expect(screen.getByText('èª²æ–‡æœ—è®€')).toBeInTheDocument();
    });
  });

  it('should display audio recorder', async () => {
    render(<StudentAssignmentPage />);

    await waitFor(() => {
      expect(screen.getByRole('button', { name: /é–‹å§‹éŒ„éŸ³/i }))
        .toBeInTheDocument();
    });
  });

  it('should submit assignment successfully', async () => {
    render(<StudentAssignmentPage />);

    await waitFor(() => {
      fireEvent.click(screen.getByRole('button', { name: /é–‹å§‹éŒ„éŸ³/i }));
    });

    // æ¨¡æ“¬éŒ„éŸ³...
    await waitFor(() => {
      fireEvent.click(screen.getByRole('button', { name: /åœæ­¢éŒ„éŸ³/i }));
    });

    // æäº¤...
    fireEvent.click(screen.getByRole('button', { name: /æäº¤/i }));

    await waitFor(() => {
      expect(screen.getByText(/æäº¤æˆåŠŸ/i)).toBeInTheDocument();
    });
  });

  it('should show loading state during submission', async () => {
    render(<StudentAssignmentPage />);

    await waitFor(() => {
      fireEvent.click(screen.getByRole('button', { name: /æäº¤/i }));
    });

    expect(screen.getByRole('progressbar')).toBeInTheDocument();
  });
});
```

---

## 2ï¸âƒ£ æ•´åˆæ¸¬è©¦ (15%)

### 2.1 API æ•´åˆæ¸¬è©¦

```typescript
// src/api/__tests__/assignment.integration.test.ts

import request from 'supertest';
import { app } from '../../app';
import { database } from '../../database';

describe('Assignment API Integration', () => {
  let authToken: string;
  let classroomId: string;

  beforeAll(async () => {
    // æ¸…ç†æ¸¬è©¦è³‡æ–™
    await database.query('TRUNCATE classrooms, assignments, users');

    // å»ºç«‹æ¸¬è©¦ä½¿ç”¨è€…
    const userRes = await database.query(
      `INSERT INTO users (email, password, role)
       VALUES ($1, $2, $3)
       RETURNING id`,
      ['teacher@test.com', 'hashed-password', 'teacher']
    );

    // ç™»å…¥ç²å– token
    const loginRes = await request(app)
      .post('/api/auth/login')
      .send({
        email: 'teacher@test.com',
        password: 'password123'
      });

    authToken = loginRes.body.token;

    // å»ºç«‹æ¸¬è©¦ç­ç´š
    const classRes = await request(app)
      .post('/api/classrooms')
      .set('Authorization', `Bearer ${authToken}`)
      .send({
        name: 'äºŒå¹´ç´šç”²ç­',
        grade: 2,
        section: 'A'
      });

    classroomId = classRes.body.id;
  });

  afterAll(async () => {
    await database.end();
  });

  describe('POST /api/assignments', () => {
    it('should create assignment', async () => {
      const res = await request(app)
        .post('/api/assignments')
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          classroomId,
          title: 'èª²æ–‡æœ—è®€',
          description: 'æœ—è®€ç¬¬ä¸€èª²',
          dueDate: '2024-02-20',
          audioScript: 'æˆ‘å«å°æ˜'
        });

      expect(res.status).toBe(201);
      expect(res.body).toHaveProperty('id');
      expect(res.body.title).toBe('èª²æ–‡æœ—è®€');
    });

    it('should validate required fields', async () => {
      const res = await request(app)
        .post('/api/assignments')
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          classroomId,
          title: 'èª²æ–‡æœ—è®€'
          // ç¼ºå°‘å…¶ä»–å¿…éœ€å­—æ®µ
        });

      expect(res.status).toBe(400);
      expect(res.body.error).toContain('validation');
    });

    it('should require authentication', async () => {
      const res = await request(app)
        .post('/api/assignments')
        .send({
          classroomId,
          title: 'èª²æ–‡æœ—è®€'
        });

      expect(res.status).toBe(401);
    });
  });

  describe('GET /api/assignments/:id', () => {
    let assignmentId: string;

    beforeEach(async () => {
      const res = await request(app)
        .post('/api/assignments')
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          classroomId,
          title: 'èª²æ–‡æœ—è®€',
          description: 'æœ—è®€ç¬¬ä¸€èª²',
          dueDate: '2024-02-20',
          audioScript: 'æˆ‘å«å°æ˜'
        });

      assignmentId = res.body.id;
    });

    it('should retrieve assignment details', async () => {
      const res = await request(app)
        .get(`/api/assignments/${assignmentId}`)
        .set('Authorization', `Bearer ${authToken}`);

      expect(res.status).toBe(200);
      expect(res.body.id).toBe(assignmentId);
      expect(res.body.title).toBe('èª²æ–‡æœ—è®€');
    });

    it('should return 404 for non-existent assignment', async () => {
      const res = await request(app)
        .get('/api/assignments/non-existent-id')
        .set('Authorization', `Bearer ${authToken}`);

      expect(res.status).toBe(404);
    });
  });

  describe('POST /api/assignments/:id/submissions', () => {
    let assignmentId: string;
    let studentToken: string;
    let studentId: string;

    beforeAll(async () => {
      // å»ºç«‹å­¸ç”Ÿå¸³è™Ÿ
      const studentRes = await database.query(
        `INSERT INTO users (email, password, role)
         VALUES ($1, $2, $3)
         RETURNING id`,
        ['student@test.com', 'hashed-password', 'student']
      );
      studentId = studentRes.rows[0].id;

      // å­¸ç”Ÿç™»å…¥
      const loginRes = await request(app)
        .post('/api/auth/login')
        .send({
          email: 'student@test.com',
          password: 'password123'
        });
      studentToken = loginRes.body.token;

      // å»ºç«‹ä½œæ¥­
      const assignRes = await request(app)
        .post('/api/assignments')
        .set('Authorization', `Bearer ${authToken}`)
        .send({
          classroomId,
          title: 'èª²æ–‡æœ—è®€',
          description: 'æœ—è®€ç¬¬ä¸€èª²',
          dueDate: '2024-02-20',
          audioScript: 'æˆ‘å«å°æ˜'
        });

      assignmentId = assignRes.body.id;
    });

    it('should accept valid submission', async () => {
      const res = await request(app)
        .post(`/api/assignments/${assignmentId}/submissions`)
        .set('Authorization', `Bearer ${studentToken}`)
        .attach('audio', Buffer.from([1, 2, 3]), 'audio.wav');

      expect(res.status).toBe(201);
      expect(res.body).toHaveProperty('submissionId');
      expect(res.body.status).toBe('pending_review');
    });

    it('should trigger AI scoring', async () => {
      const res = await request(app)
        .post(`/api/assignments/${assignmentId}/submissions`)
        .set('Authorization', `Bearer ${studentToken}`)
        .attach('audio', Buffer.from([1, 2, 3]), 'audio.wav');

      expect(res.status).toBe(201);

      // ç­‰å¾… AI è©•åˆ†å®Œæˆ
      await new Promise(resolve => setTimeout(resolve, 2000));

      const submissionRes = await request(app)
        .get(`/api/submissions/${res.body.submissionId}`)
        .set('Authorization', `Bearer ${studentToken}`);

      expect(submissionRes.body.aiScore).toBeDefined();
      expect(submissionRes.body.transcript).toBeDefined();
    });

    it('should prevent multiple submissions within cooldown', async () => {
      // ç¬¬ä¸€æ¬¡æäº¤
      const res1 = await request(app)
        .post(`/api/assignments/${assignmentId}/submissions`)
        .set('Authorization', `Bearer ${studentToken}`)
        .attach('audio', Buffer.from([1, 2, 3]), 'audio.wav');

      expect(res1.status).toBe(201);

      // ç«‹å³é‡æ–°æäº¤ (æ‡‰è©²è¢«é™åˆ¶)
      const res2 = await request(app)
        .post(`/api/assignments/${assignmentId}/submissions`)
        .set('Authorization', `Bearer ${studentToken}`)
        .attach('audio', Buffer.from([1, 2, 3]), 'audio.wav');

      expect(res2.status).toBe(429); // Too Many Requests
    });
  });

  describe('GET /api/classrooms/:id/assignments', () => {
    it('should list all assignments in classroom', async () => {
      const res = await request(app)
        .get(`/api/classrooms/${classroomId}/assignments`)
        .set('Authorization', `Bearer ${authToken}`);

      expect(res.status).toBe(200);
      expect(Array.isArray(res.body)).toBe(true);
      expect(res.body.length).toBeGreaterThan(0);
    });

    it('should support pagination', async () => {
      const res = await request(app)
        .get(`/api/classrooms/${classroomId}/assignments`)
        .query({ page: 1, limit: 10 })
        .set('Authorization', `Bearer ${authToken}`);

      expect(res.status).toBe(200);
      expect(res.body).toHaveProperty('items');
      expect(res.body).toHaveProperty('total');
      expect(res.body).toHaveProperty('page');
    });

    it('should filter by due date', async () => {
      const res = await request(app)
        .get(`/api/classrooms/${classroomId}/assignments`)
        .query({
          dueDateFrom: '2024-01-01',
          dueDateTo: '2024-02-28'
        })
        .set('Authorization', `Bearer ${authToken}`);

      expect(res.status).toBe(200);
      res.body.items.forEach((assignment: any) => {
        const dueDate = new Date(assignment.dueDate);
        expect(dueDate >= new Date('2024-01-01')).toBe(true);
        expect(dueDate <= new Date('2024-02-28')).toBe(true);
      });
    });
  });
});
```

### 2.2 è³‡æ–™åº«æ•´åˆæ¸¬è©¦

```typescript
// src/database/__tests__/schema.integration.test.ts

import { database } from '../../database';

describe('Database Schema Integration', () => {
  beforeAll(async () => {
    await database.connect();
  });

  afterAll(async () => {
    await database.disconnect();
  });

  afterEach(async () => {
    // æ¸…ç†æ¸¬è©¦è³‡æ–™
    await database.query('TRUNCATE users, classrooms, assignments, submissions');
  });

  describe('Multi-tenancy', () => {
    it('should enforce platform isolation', async () => {
      // å»ºç«‹å…©å€‹å¹³å°
      const platform1 = await database.query(
        `INSERT INTO platforms (name, subdomain)
         VALUES ($1, $2)
         RETURNING platform_id`,
        ['å¹³å°1', 'platform1']
      );

      const platform2 = await database.query(
        `INSERT INTO platforms (name, subdomain)
         VALUES ($1, $2)
         RETURNING platform_id`,
        ['å¹³å°2', 'platform2']
      );

      // å»ºç«‹å…©å€‹çµ„ç¹”
      const org1 = await database.query(
        `INSERT INTO organizations (platform_id, name, type)
         VALUES ($1, $2, $3)
         RETURNING organization_id`,
        [platform1.rows[0].platform_id, 'çµ„ç¹”1', 'school']
      );

      const org2 = await database.query(
        `INSERT INTO organizations (platform_id, name, type)
         VALUES ($1, $2, $3)
         RETURNING organization_id`,
        [platform2.rows[0].platform_id, 'çµ„ç¹”2', 'school']
      );

      // æŸ¥è©¢æ‡‰è©²éš”é›¢
      const result = await database.query(
        `SELECT * FROM organizations WHERE platform_id = $1`,
        [platform1.rows[0].platform_id]
      );

      expect(result.rows).toHaveLength(1);
      expect(result.rows[0].organization_id)
        .toBe(org1.rows[0].organization_id);
    });
  });

  describe('Assignment Submission Workflow', () => {
    it('should create complete submission record', async () => {
      // å»ºç«‹ä½¿ç”¨è€…
      const user = await database.query(
        `INSERT INTO users (email, name, role)
         VALUES ($1, $2, $3)
         RETURNING user_id`,
        ['student@test.com', 'å°æ˜', 'student']
      );

      // å»ºç«‹ç­ç´š
      const classroom = await database.query(
        `INSERT INTO classrooms (name, grade)
         VALUES ($1, $2)
         RETURNING classroom_id`,
        ['äºŒå¹´ç´šç”²ç­', 2]
      );

      // å»ºç«‹ä½œæ¥­
      const assignment = await database.query(
        `INSERT INTO assignments (classroom_id, title, audio_script, due_date)
         VALUES ($1, $2, $3, $4)
         RETURNING assignment_id`,
        [classroom.rows[0].classroom_id, 'èª²æ–‡æœ—è®€', 'æˆ‘å«å°æ˜', '2024-02-20']
      );

      // å»ºç«‹æäº¤
      const submission = await database.query(
        `INSERT INTO submissions (assignment_id, student_id, audio_url, status)
         VALUES ($1, $2, $3, $4)
         RETURNING submission_id, created_at`,
        [
          assignment.rows[0].assignment_id,
          user.rows[0].user_id,
          'https://s3.../audio.wav',
          'pending_review'
        ]
      );

      expect(submission.rows[0].submission_id).toBeDefined();
      expect(submission.rows[0].created_at).toBeDefined();

      // é©—è­‰é—œè¯
      const verify = await database.query(
        `SELECT
          s.submission_id,
          a.title,
          u.name,
          c.name as classroom_name
         FROM submissions s
         JOIN assignments a ON s.assignment_id = a.assignment_id
         JOIN users u ON s.student_id = u.user_id
         JOIN classrooms c ON a.classroom_id = c.classroom_id
         WHERE s.submission_id = $1`,
        [submission.rows[0].submission_id]
      );

      expect(verify.rows[0].title).toBe('èª²æ–‡æœ—è®€');
      expect(verify.rows[0].name).toBe('å°æ˜');
      expect(verify.rows[0].classroom_name).toBe('äºŒå¹´ç´šç”²ç­');
    });
  });

  describe('Constraints & Validations', () => {
    it('should enforce unique email constraint', async () => {
      const email = 'duplicate@test.com';

      await database.query(
        `INSERT INTO users (email, name, role)
         VALUES ($1, $2, $3)`,
        [email, 'ç”¨æˆ¶1', 'student']
      );

      // å˜—è©¦æ’å…¥é‡è¤‡ email
      expect(
        database.query(
          `INSERT INTO users (email, name, role)
           VALUES ($1, $2, $3)`,
          [email, 'ç”¨æˆ¶2', 'student']
        )
      ).rejects.toThrow('duplicate key');
    });

    it('should enforce foreign key constraints', async () => {
      // å˜—è©¦å»ºç«‹å¼•ç”¨ä¸å­˜åœ¨çš„ç­ç´š
      expect(
        database.query(
          `INSERT INTO assignments (classroom_id, title)
           VALUES ($1, $2)`,
          ['non-existent-classroom', 'ä½œæ¥­']
        )
      ).rejects.toThrow('foreign key constraint');
    });
  });
});
```

### 2.3 æœå‹™å±¤æ•´åˆæ¸¬è©¦

```typescript
// src/services/__tests__/github-sync.integration.test.ts

import { GitHubSyncService } from '../../services/github-sync.service';
import { database } from '../../database';
import { simpleGit } from 'simple-git';

describe('GitHub Sync Service Integration', () => {
  let service: GitHubSyncService;

  beforeAll(async () => {
    await database.connect();
    service = new GitHubSyncService(database, simpleGit);
  });

  afterAll(async () => {
    await database.disconnect();
  });

  describe('syncCourses', () => {
    it('should sync courses from GitHub to database', async () => {
      // åˆå§‹ç‹€æ…‹: è³‡æ–™åº«ç‚ºç©º
      let courses = await database.query(
        'SELECT COUNT(*) as count FROM courses'
      );
      expect(parseInt(courses.rows[0].count)).toBe(0);

      // åŸ·è¡ŒåŒæ­¥
      await service.syncCourses();

      // æª¢æŸ¥è³‡æ–™åº«å·²æ›´æ–°
      courses = await database.query(
        'SELECT COUNT(*) as count FROM courses'
      );
      expect(parseInt(courses.rows[0].count)).toBeGreaterThan(0);
    });

    it('should update existing courses', async () => {
      // å»ºç«‹åˆå§‹èª²ç¨‹
      await database.query(
        `INSERT INTO courses (title, content, version)
         VALUES ($1, $2, $3)`,
        ['èª²ç¨‹1', 'èˆŠå…§å®¹', 'v1']
      );

      // æ¨¡æ“¬ GitHub èª²ç¨‹æ›´æ–°
      // ... (mock simpleGit pull)

      // åŸ·è¡ŒåŒæ­¥
      await service.syncCourses();

      // é©—è­‰èª²ç¨‹å·²æ›´æ–°
      const course = await database.query(
        'SELECT * FROM courses WHERE title = $1',
        ['èª²ç¨‹1']
      );

      expect(course.rows[0].version).toBe('v2');
    });

    it('should log sync errors', async () => {
      // æ¨¡æ“¬ Git pull å¤±æ•—
      // ... (mock simpleGit error)

      await service.syncCourses();

      // é©—è­‰éŒ¯èª¤å·²è¨˜éŒ„
      const logs = await database.query(
        'SELECT * FROM github_sync_logs WHERE status = $1',
        ['failed']
      );

      expect(logs.rows.length).toBeGreaterThan(0);
    });
  });
});
```

---

## 3ï¸âƒ£ E2E æ¸¬è©¦ (5%)

### 3.1 Playwright E2E æ¸¬è©¦è¨­å®š

```typescript
// playwright.config.ts

import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure'
  },

  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] }
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] }
    }
  ],

  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI
  }
});
```

### 3.2 å­¸ç”Ÿæäº¤ä½œæ¥­æµç¨‹ E2E æ¸¬è©¦

```typescript
// e2e/student-submission.spec.ts

import { test, expect } from '@playwright/test';

test.describe('Student Assignment Submission', () => {
  test.beforeEach(async ({ page }) => {
    // ç™»å…¥å­¸ç”Ÿå¸³è™Ÿ
    await page.goto('/login');
    await page.fill('input[name="email"]', 'student@test.com');
    await page.fill('input[name="password"]', 'password123');
    await page.click('button[type="submit"]');

    // ç­‰å¾…ç™»å…¥å®Œæˆ
    await expect(page).toHaveURL('/student/dashboard');
  });

  test('should complete assignment submission flow', async ({ page }) => {
    // 1. é€²å…¥ä½œæ¥­åˆ—è¡¨
    await page.click('a:has-text("æˆ‘çš„ä½œæ¥­")');
    await expect(page).toHaveURL(/\/assignments/);

    // 2. é¸æ“‡ä½œæ¥­
    const firstAssignment = page
      .locator('[data-testid="assignment-card"]')
      .first();

    await expect(firstAssignment).toContainText('èª²æ–‡æœ—è®€');
    await firstAssignment.click();

    // 3. æŸ¥çœ‹ä½œæ¥­è©³æƒ…
    await expect(page.locator('h1')).toContainText('èª²æ–‡æœ—è®€');
    await expect(page.locator('[data-testid="audio-script"]'))
      .toContainText('æˆ‘å«å°æ˜');

    // 4. å•Ÿå‹•éŒ„éŸ³
    const recordButton = page.locator('button:has-text("é–‹å§‹éŒ„éŸ³")');
    await recordButton.click();

    // 5. é©—è­‰éŒ„éŸ³ç‹€æ…‹
    await expect(page.locator('[data-testid="recording-status"]'))
      .toContainText('éŒ„éŸ³ä¸­');

    // 6. ç­‰å¾…éŒ„éŸ³ï¼ˆæ¨¡æ“¬ 5 ç§’ï¼‰
    await page.waitForTimeout(5000);

    // 7. åœæ­¢éŒ„éŸ³
    const stopButton = page.locator('button:has-text("åœæ­¢éŒ„éŸ³")');
    await stopButton.click();

    // 8. é©—è­‰åœæ­¢ç‹€æ…‹
    await expect(page.locator('[data-testid="recording-status"]'))
      .toContainText('å·²åœæ­¢');

    // 9. æäº¤ä½œæ¥­
    const submitButton = page.locator('button:has-text("æäº¤ä½œæ¥­")');
    await submitButton.click();

    // 10. ç­‰å¾…ä¸Šå‚³
    await page.waitForTimeout(3000);

    // 11. é©—è­‰æäº¤æˆåŠŸ
    await expect(page.locator('[data-testid="success-message"]'))
      .toContainText('ä½œæ¥­æäº¤æˆåŠŸ');

    // 12. é©—è­‰å°å‘çµæœé 
    await expect(page).toHaveURL(/\/assignments\/\w+\/result/);

    // 13. æŸ¥çœ‹è©•åˆ†çµæœ
    await expect(page.locator('[data-testid="score"]'))
      .toContainText(/\d+/); // æ‡‰è©²æœ‰åˆ†æ•¸

    // 14. æŸ¥çœ‹è©³ç´°åé¥‹
    const feedbackSection = page.locator('[data-testid="feedback"]');
    await expect(feedbackSection).toBeVisible();
  });

  test('should handle recording errors gracefully', async ({ page }) => {
    await page.click('a:has-text("æˆ‘çš„ä½œæ¥­")');
    const firstAssignment = page
      .locator('[data-testid="assignment-card"]')
      .first();
    await firstAssignment.click();

    // æ¨¡æ“¬éº¥å…‹é¢¨ä¸å¯ç”¨çš„éŒ¯èª¤
    await page.evaluate(() => {
      // æ³¨å…¥éŒ¯èª¤
      (navigator as any).mediaDevices = {
        getUserMedia: () => Promise.reject(
          new Error('Permission denied')
        )
      };
    });

    const recordButton = page.locator('button:has-text("é–‹å§‹éŒ„éŸ³")');
    await recordButton.click();

    // é©—è­‰éŒ¯èª¤è¨Šæ¯
    await expect(page.locator('[data-testid="error-message"]'))
      .toContainText('éº¥å…‹é¢¨ä¸å¯ç”¨');
  });

  test('should prevent duplicate submission', async ({ page }) => {
    await page.click('a:has-text("æˆ‘çš„ä½œæ¥­")');
    const firstAssignment = page
      .locator('[data-testid="assignment-card"]')
      .first();
    await firstAssignment.click();

    // ç¬¬ä¸€æ¬¡æäº¤
    await page.click('button:has-text("é–‹å§‹éŒ„éŸ³")');
    await page.waitForTimeout(2000);
    await page.click('button:has-text("åœæ­¢éŒ„éŸ³")');
    await page.click('button:has-text("æäº¤ä½œæ¥­")');
    await page.waitForTimeout(3000);

    // å°å‘çµæœé 
    await expect(page).toHaveURL(/\/result/);

    // è¿”å›ä½œæ¥­é 
    await page.goBack();

    // é©—è­‰æäº¤æŒ‰éˆ•å·²ç¦ç”¨
    const submitButton = page.locator('button:has-text("æäº¤ä½œæ¥­")');
    await expect(submitButton).toBeDisabled();

    // é©—è­‰æç¤ºè¨Šæ¯
    await expect(page.locator('[data-testid="already-submitted"]'))
      .toContainText('å·²æäº¤');
  });

  test('should display real-time scoring progress', async ({ page }) => {
    await page.click('a:has-text("æˆ‘çš„ä½œæ¥­")');
    const firstAssignment = page
      .locator('[data-testid="assignment-card"]')
      .first();
    await firstAssignment.click();

    // æäº¤
    await page.click('button:has-text("é–‹å§‹éŒ„éŸ³")');
    await page.waitForTimeout(2000);
    await page.click('button:has-text("åœæ­¢éŒ„éŸ³")');
    await page.click('button:has-text("æäº¤ä½œæ¥­")');

    // æŸ¥çœ‹çµæœé  - æ‡‰è©²æœ‰é€²åº¦æŒ‡ç¤º
    await expect(page.locator('[data-testid="scoring-progress"]'))
      .toContainText('AI è©•åˆ†ä¸­');

    // ç­‰å¾…è©•åˆ†å®Œæˆï¼ˆæœ€å¤š 30 ç§’ï¼‰
    const scoreElement = page.locator('[data-testid="score"]');
    await scoreElement.waitFor({ timeout: 30000 });

    // é©—è­‰åˆ†æ•¸é¡¯ç¤º
    await expect(scoreElement).toContainText(/\d+/);
  });
});
```

### 3.3 æ•™å¸«æ‰¹æ”¹æµç¨‹ E2E æ¸¬è©¦

```typescript
// e2e/teacher-grading.spec.ts

import { test, expect } from '@playwright/test';

test.describe('Teacher Grading Workflow', () => {
  test.beforeEach(async ({ page }) => {
    // ä»¥æ•™å¸«èº«ä»½ç™»å…¥
    await page.goto('/login');
    await page.fill('input[name="email"]', 'teacher@test.com');
    await page.fill('input[name="password"]', 'password123');
    await page.click('button[type="submit"]');

    await expect(page).toHaveURL('/teacher/dashboard');
  });

  test('should complete grading workflow', async ({ page }) => {
    // 1. é€²å…¥ç­ç´š
    await page.click('a:has-text("æˆ‘çš„ç­ç´š")');
    await expect(page).toHaveURL(/\/classrooms/);

    // 2. é¸æ“‡ç­ç´š
    const classroom = page
      .locator('[data-testid="classroom-card"]')
      .first();
    await classroom.click();

    // 3. æŸ¥çœ‹ä½œæ¥­åˆ—è¡¨
    await expect(page.locator('h2')).toContainText('ä½œæ¥­');

    // 4. é€²å…¥æ‰¹æ”¹æª¢è¦–
    const assignmentRow = page
      .locator('[data-testid="assignment-row"]')
      .first();
    await assignmentRow.click();

    // 5. æŸ¥çœ‹å­¸ç”Ÿæäº¤åˆ—è¡¨
    await expect(page.locator('h3')).toContainText('å­¸ç”Ÿæäº¤');

    // 6. é¸æ“‡å­¸ç”Ÿæäº¤
    const submission = page
      .locator('[data-testid="submission-item"]')
      .first();
    await submission.click();

    // 7. æª¢æŸ¥ AI è©•åˆ†
    await expect(page.locator('[data-testid="ai-score"]'))
      .toContainText(/\d+/);

    // 8. æŸ¥çœ‹èªéŸ³å›æ”¾
    const audioPlayer = page.locator('[data-testid="audio-player"]');
    await expect(audioPlayer).toBeVisible();

    // 9. æ’­æ”¾éŸ³æª”
    await audioPlayer.click();
    await page.waitForTimeout(2000);

    // 10. æ·»åŠ æ‰¹èªè©•è«–
    const commentBox = page.locator('textarea[data-testid="comment"]');
    await commentBox.fill('ç™¼éŸ³å¾ˆå¥½,ä½†è¦æ³¨æ„è²èª¿ã€‚');

    // 11. èª¿æ•´è©•åˆ†ï¼ˆå¦‚æœéœ€è¦ï¼‰
    const scoreInput = page
      .locator('input[data-testid="manual-score"]');
    if (await scoreInput.isVisible()) {
      await scoreInput.fill('92');
    }

    // 12. æäº¤è©•åˆ†
    const submitGradeButton = page.locator(
      'button:has-text("æäº¤è©•åˆ†")'
    );
    await submitGradeButton.click();

    // 13. é©—è­‰æˆåŠŸ
    await expect(page.locator('[data-testid="success-message"]'))
      .toContainText('è©•åˆ†å·²ä¿å­˜');

    // 14. è¿”å›åˆ—è¡¨
    await page.goBack();

    // 15. é©—è­‰ç‹€æ…‹æ›´æ–°
    const submissionStatus = submission
      .locator('[data-testid="status"]');
    await expect(submissionStatus).toContainText('å·²æ‰¹æ”¹');
  });

  test('should export grading report', async ({ page }) => {
    await page.click('a:has-text("æˆ‘çš„ç­ç´š")');
    const classroom = page
      .locator('[data-testid="classroom-card"]')
      .first();
    await classroom.click();

    // æ‰¾åˆ°åŒ¯å‡ºæŒ‰éˆ•
    const exportButton = page.locator(
      'button:has-text("åŒ¯å‡ºæˆç¸¾")'
    );
    await expect(exportButton).toBeVisible();

    // é»æ“ŠåŒ¯å‡º
    const downloadPromise = page.waitForEvent('download');
    await exportButton.click();
    const download = await downloadPromise;

    // é©—è­‰æª”æ¡ˆä¸‹è¼‰
    expect(download.suggestedFilename()).toContain('.csv');
  });

  test('should display class statistics', async ({ page }) => {
    await page.click('a:has-text("æˆ‘çš„ç­ç´š")');
    const classroom = page
      .locator('[data-testid="classroom-card"]')
      .first();
    await classroom.click();

    // æŸ¥çœ‹ç­ç´šçµ±è¨ˆ
    const stats = page.locator('[data-testid="class-statistics"]');
    await expect(stats).toBeVisible();

    // é©—è­‰çµ±è¨ˆæ•¸æ“š
    await expect(stats.locator('[data-testid="avg-score"]'))
      .toContainText(/\d+/);

    await expect(stats.locator('[data-testid="submission-rate"]'))
      .toContainText(/%/);

    await expect(stats.locator('[data-testid="total-submissions"]'))
      .toContainText(/\d+/);
  });
});
```

---

## 4ï¸âƒ£ API æ¸¬è©¦ (Postman / REST Client)

### 4.1 REST Client æ¸¬è©¦é›†åˆ

```http
# rest-client/api-tests.rest

@baseUrl = http://localhost:3000/api
@authToken = Bearer your_token_here
@classroomId = classroom-123
@assignmentId = assignment-456

### èªè­‰ API

# ç™»å…¥
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "student@test.com",
  "password": "password123"
}

### @authToken = Bearer <token from response>

---

# ç²å–ç”¨æˆ¶è³‡æ–™
GET {{baseUrl}}/auth/me
Authorization: {{authToken}}

---

### ç­ç´š API

# ç²å–ç­ç´šåˆ—è¡¨
GET {{baseUrl}}/classrooms
Authorization: {{authToken}}

---

# å»ºç«‹ç­ç´š
POST {{baseUrl}}/classrooms
Authorization: {{authToken}}
Content-Type: application/json

{
  "name": "äºŒå¹´ç´šç”²ç­",
  "grade": 2,
  "section": "A",
  "googleClassroomId": "google-classroom-123"
}

---

# ç²å–ç­ç´šè©³æƒ…
GET {{baseUrl}}/classrooms/{{classroomId}}
Authorization: {{authToken}}

---

### ä½œæ¥­ API

# å»ºç«‹ä½œæ¥­
POST {{baseUrl}}/assignments
Authorization: {{authToken}}
Content-Type: application/json

{
  "classroomId": "{{classroomId}}",
  "title": "èª²æ–‡æœ—è®€",
  "description": "æœ—è®€ç¬¬ä¸€èª²èª²æ–‡",
  "audioScript": "æˆ‘å«å°æ˜",
  "dueDate": "2024-02-20T23:59:59Z",
  "rubric": {
    "accuracy": 0.5,
    "fluency": 0.3,
    "tone": 0.2
  }
}

---

# ç²å–ä½œæ¥­è©³æƒ…
GET {{baseUrl}}/assignments/{{assignmentId}}
Authorization: {{authToken}}

---

# ç²å–ç­ç´šä½œæ¥­åˆ—è¡¨
GET {{baseUrl}}/classrooms/{{classroomId}}/assignments
Authorization: {{authToken}}

---

### æäº¤ API

# æäº¤ä½œæ¥­
POST {{baseUrl}}/assignments/{{assignmentId}}/submissions
Authorization: {{authToken}}
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary

------WebKitFormBoundary
Content-Disposition: form-data; name="audio"; filename="submission.wav"
Content-Type: audio/wav

< ./test-audio.wav
------WebKitFormBoundary--

---

# æŸ¥çœ‹æäº¤è¨˜éŒ„
GET {{baseUrl}}/submissions?classroomId={{classroomId}}&assignmentId={{assignmentId}}
Authorization: {{authToken}}

---

# ç²å–å–®å€‹æäº¤è©³æƒ…
GET {{baseUrl}}/submissions/{{submissionId}}
Authorization: {{authToken}}

---

### è©•åˆ† API

# ç²å–è©•åˆ†è©³æƒ…
GET {{baseUrl}}/scores/{{submissionId}}
Authorization: {{authToken}}

---

# æ•™å¸«èª¿æ•´è©•åˆ†
PATCH {{baseUrl}}/scores/{{scoreId}}
Authorization: {{authToken}}
Content-Type: application/json

{
  "manualScore": 92,
  "comment": "ç™¼éŸ³å¾ˆå¥½ï¼Œä½†è¦æ³¨æ„è²èª¿ã€‚",
  "feedback": "éœ€è¦åŠ å¼·è²èª¿çš„æº–ç¢ºåº¦"
}

---

### é€²åº¦è¿½è¹¤ API

# ç²å–å­¸ç”Ÿé€²åº¦
GET {{baseUrl}}/students/{{studentId}}/progress
Authorization: {{authToken}}

---

# ç²å–ç­ç´šé€²åº¦çµ±è¨ˆ
GET {{baseUrl}}/classrooms/{{classroomId}}/progress-analytics
Authorization: {{authToken}}

---

# å°å‡ºç­ç´šæˆç¸¾
POST {{baseUrl}}/classrooms/{{classroomId}}/export-grades
Authorization: {{authToken}}
Content-Type: application/json

{
  "format": "csv",
  "includeComments": true
}

---

### éŒ¯èª¤æ¡ˆä¾‹æ¸¬è©¦

# æœªèªè­‰çš„è«‹æ±‚ï¼ˆæ‡‰è¿”å› 401ï¼‰
GET {{baseUrl}}/assignments

---

# ç„¡æ•ˆçš„ä½œæ¥­ IDï¼ˆæ‡‰è¿”å› 404ï¼‰
GET {{baseUrl}}/assignments/invalid-id
Authorization: {{authToken}}

---

# ç„¡æ•ˆçš„è«‹æ±‚ä½“ï¼ˆæ‡‰è¿”å› 400ï¼‰
POST {{baseUrl}}/assignments
Authorization: {{authToken}}
Content-Type: application/json

{
  "classroomId": "{{classroomId}}"
  // ç¼ºå°‘å¿…éœ€çš„ title å­—æ®µ
}

---

# è¶…å‡ºé€Ÿç‡é™åˆ¶çš„è«‹æ±‚ï¼ˆæ‡‰è¿”å› 429ï¼‰
GET {{baseUrl}}/assignments?page=1
Authorization: {{authToken}}

---
```

---

## 5ï¸âƒ£ è³‡æ–™åº«æ¸¬è©¦

### 5.1 Test Database è¨­å®š

```typescript
// src/test/database.ts

import { Pool } from 'pg';
import { execSync } from 'child_process';
import * as fs from 'fs';
import * as path from 'path';

let testPool: Pool;

export async function setupTestDatabase() {
  // 1. å»ºç«‹æ¸¬è©¦è³‡æ–™åº«
  const client = new Pool({
    host: process.env.DB_HOST || 'localhost',
    port: parseInt(process.env.DB_PORT || '5432'),
    database: 'postgres', // é è¨­è³‡æ–™åº«
    user: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASSWORD || 'postgres'
  });

  const dbName = `test_db_${Date.now()}`;

  try {
    await client.query(`CREATE DATABASE "${dbName}"`);
  } catch (error) {
    console.error('Failed to create test database:', error);
    throw error;
  }

  // 2. åŸ·è¡Œ migration
  testPool = new Pool({
    host: process.env.DB_HOST || 'localhost',
    port: parseInt(process.env.DB_PORT || '5432'),
    database: dbName,
    user: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASSWORD || 'postgres'
  });

  try {
    const schemaPath = path.join(__dirname, '../migrations/schema.sql');
    const schema = fs.readFileSync(schemaPath, 'utf8');
    await testPool.query(schema);
  } catch (error) {
    console.error('Failed to execute migrations:', error);
    throw error;
  }

  await client.end();

  return {
    pool: testPool,
    dbName,
    query: (sql: string, params?: any[]) => testPool.query(sql, params)
  };
}

export async function teardownTestDatabase(dbName: string) {
  if (testPool) {
    await testPool.end();
  }

  const client = new Pool({
    host: process.env.DB_HOST || 'localhost',
    port: parseInt(process.env.DB_PORT || '5432'),
    database: 'postgres',
    user: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASSWORD || 'postgres'
  });

  try {
    // å¼·åˆ¶æ–·é–‹æ‰€æœ‰é€£æ¥
    await client.query(
      `SELECT pg_terminate_backend(pg_stat_activity.pid)
       FROM pg_stat_activity
       WHERE pg_stat_activity.datname = $1`,
      [dbName]
    );

    // åˆªé™¤è³‡æ–™åº«
    await client.query(`DROP DATABASE "${dbName}"`);
  } catch (error) {
    console.error('Failed to drop test database:', error);
  } finally {
    await client.end();
  }
}
```

### 5.2 Fixtures (æ¸¬è©¦æ•¸æ“š)

```typescript
// src/test/fixtures.ts

import { Pool } from 'pg';

export async function seedTestData(pool: Pool) {
  // 1. å»ºç«‹å¹³å°
  const platform = await pool.query(
    `INSERT INTO platforms (name, subdomain)
     VALUES ($1, $2)
     RETURNING platform_id`,
    ['æ¸¬è©¦å¹³å°', 'test-platform']
  );

  // 2. å»ºç«‹çµ„ç¹”
  const organization = await pool.query(
    `INSERT INTO organizations (platform_id, name, type)
     VALUES ($1, $2, $3)
     RETURNING organization_id`,
    [platform.rows[0].platform_id, 'æ¸¬è©¦å­¸æ ¡', 'school']
  );

  // 3. å»ºç«‹å­¸æ ¡
  const school = await pool.query(
    `INSERT INTO schools (organization_id, name)
     VALUES ($1, $2)
     RETURNING school_id`,
    [organization.rows[0].organization_id, 'åœ‹ç«‹æ¸¬è©¦å°å­¸']
  );

  // 4. å»ºç«‹ç­ç´š
  const classroom = await pool.query(
    `INSERT INTO classrooms (school_id, name, grade, section)
     VALUES ($1, $2, $3, $4)
     RETURNING classroom_id`,
    [school.rows[0].school_id, 'äºŒå¹´ç´šç”²ç­', 2, 'A']
  );

  // 5. å»ºç«‹ä½¿ç”¨è€…
  const teacher = await pool.query(
    `INSERT INTO users (email, name, role)
     VALUES ($1, $2, $3)
     RETURNING user_id`,
    ['teacher@test.com', 'ç‹è€å¸«', 'teacher']
  );

  const students = await pool.query(
    `INSERT INTO users (email, name, role)
     VALUES
     ($1, $2, $3),
     ($4, $5, $6),
     ($7, $8, $9)
     RETURNING user_id, email`,
    [
      'student1@test.com', 'å°æ˜', 'student',
      'student2@test.com', 'å°ç´…', 'student',
      'student3@test.com', 'å°ç‹', 'student'
    ]
  );

  // 6. å»ºç«‹ç­ç´šæˆå“¡é—œè¯
  await pool.query(
    `INSERT INTO classroom_students (classroom_id, student_id)
     VALUES ($1, $2), ($1, $3), ($1, $4)`,
    [
      classroom.rows[0].classroom_id,
      students.rows[0].user_id,
      students.rows[1].user_id,
      students.rows[2].user_id
    ]
  );

  // 7. å»ºç«‹ä½œæ¥­
  const assignment = await pool.query(
    `INSERT INTO assignments (classroom_id, title, description, audio_script, due_date)
     VALUES ($1, $2, $3, $4, $5)
     RETURNING assignment_id`,
    [
      classroom.rows[0].classroom_id,
      'èª²æ–‡æœ—è®€',
      'æœ—è®€ç¬¬ä¸€èª²èª²æ–‡',
      'æˆ‘å«å°æ˜',
      new Date('2024-02-20')
    ]
  );

  // 8. å»ºç«‹å­¸ç”Ÿæäº¤
  const submissions = await pool.query(
    `INSERT INTO submissions (assignment_id, student_id, audio_url, status)
     VALUES
     ($1, $2, $3, $4),
     ($1, $5, $6, $7)
     RETURNING submission_id`,
    [
      assignment.rows[0].assignment_id,
      students.rows[0].user_id,
      'https://s3.../student1-audio.wav',
      'completed',
      students.rows[1].user_id,
      'https://s3.../student2-audio.wav',
      'pending_review'
    ]
  );

  return {
    platform: platform.rows[0],
    organization: organization.rows[0],
    school: school.rows[0],
    classroom: classroom.rows[0],
    teacher: teacher.rows[0],
    students: students.rows,
    assignment: assignment.rows[0],
    submissions: submissions.rows
  };
}

export async function clearAllData(pool: Pool) {
  const tables = [
    'ai_scores',
    'scores',
    'submissions',
    'submission_files',
    'assignments',
    'classroom_students',
    'classrooms',
    'schools',
    'organizations',
    'platforms',
    'users'
  ];

  for (const table of tables) {
    await pool.query(`TRUNCATE TABLE ${table} CASCADE`);
  }
}
```

---

## 6ï¸âƒ£ Mock ç­–ç•¥

### 6.1 å¤–éƒ¨ API Mock

```typescript
// src/test/mocks/whisper.mock.ts

import { Whisper } from '../../integrations/whisper.service';

export function createMockWhisper(): jest.Mocked<Whisper> {
  return {
    transcribe: jest.fn(async (audioUrl: string) => {
      // æ¨¡æ“¬è½‰éŒ„
      if (audioUrl.includes('error')) {
        throw new Error('Transcription failed');
      }

      return {
        text: 'æˆ‘å«å°æ˜',
        confidence: 0.98,
        duration: 3.2,
        language: 'zh-CN'
      };
    }),

    uploadAudio: jest.fn(async (audioBlob: Blob) => {
      return `https://s3.../audio-${Date.now()}.wav`;
    })
  };
}

// src/test/mocks/google-classroom.mock.ts

import { GoogleClassroom } from '../../integrations/google-classroom.service';

export function createMockGoogleClassroom(): jest.Mocked<GoogleClassroom> {
  return {
    listCourses: jest.fn(async () => [
      {
        id: 'course-1',
        name: 'äºŒå¹´ç´šç”²ç­',
        section: 'A'
      }
    ]),

    listStudents: jest.fn(async (courseId: string) => [
      {
        userId: 'user-1',
        profile: {
          emailAddress: 'student1@test.com',
          name: {
            givenName: 'å°æ˜',
            familyName: ''
          }
        }
      }
    ]),

    createAssignment: jest.fn(async (courseId, assignment) => ({
      id: `assignment-${Date.now()}`,
      title: assignment.title
    }))
  };
}
```

---

## 7ï¸âƒ£ CI/CD æ•´åˆ (GitHub Actions)

### 7.1 è‡ªå‹•åŒ–æ¸¬è©¦ Pipeline

```yaml
# .github/workflows/test.yml

name: Automated Tests

on:
  push:
    branches: [main, develop, feature/**]
  pull_request:
    branches: [main, develop]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:unit
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost/test_db

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/coverage-final.json

  integration-tests:
    runs-on: ubuntu-latest
    needs: unit-tests
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run integration tests
        run: npm run test:integration
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost/test_db

  e2e-tests:
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload Playwright report
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: playwright-report
          path: playwright-report/

  coverage-check:
    runs-on: ubuntu-latest
    needs: unit-tests

    steps:
      - uses: actions/checkout@v3

      - name: Check coverage threshold
        run: |
          if [ $(cat coverage/coverage-summary.json | jq '.total.lines.pct') -lt 80 ]; then
            echo "Coverage below 80%"
            exit 1
          fi
```

### 7.2 æ€§èƒ½æ¸¬è©¦ Pipeline

```yaml
# .github/workflows/performance-test.yml

name: Performance Tests

on:
  schedule:
    - cron: '0 2 * * *' # æ¯å¤©å‡Œæ™¨ 2 é»
  workflow_dispatch:

jobs:
  performance-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install k6
        run: sudo apt-get update && sudo apt-get install -y k6

      - name: Run performance tests
        run: k6 run performance-tests/load-test.js
        env:
          BASE_URL: http://localhost:3000

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: k6-results
          path: results/
```

---

## 8ï¸âƒ£ æ•ˆèƒ½æ¸¬è©¦ (k6 / Artillery)

### 8.1 k6 æ•ˆèƒ½æ¸¬è©¦

```typescript
// performance-tests/load-test.js

import http from 'k6/http';
import { check, group, sleep } from 'k6';

export let options = {
  stages: [
    { duration: '30s', target: 20 },   // ç·šæ€§å¢åŠ åˆ° 20 å€‹è™›æ“¬ç”¨æˆ¶
    { duration: '1m30s', target: 100 }, // ç·šæ€§å¢åŠ åˆ° 100 å€‹è™›æ“¬ç”¨æˆ¶
    { duration: '20s', target: 0 }     // ç·šæ€§é™ä½åˆ° 0
  ],
  thresholds: {
    http_req_duration: ['p(95)<500', 'p(99)<1000'],
    http_req_failed: ['rate<0.1']
  }
};

const BASE_URL = __ENV.BASE_URL || 'http://localhost:3000';

export default function() {
  // 1. ç™»å…¥
  group('Authentication', function() {
    const loginRes = http.post(`${BASE_URL}/api/auth/login`, {
      email: 'student@test.com',
      password: 'password123'
    });

    check(loginRes, {
      'login status is 200': (r) => r.status === 200,
      'login response contains token': (r) => r.body.includes('token')
    });

    var authToken = loginRes.json('token');
    sleep(1);

    // 2. ç²å–ä½œæ¥­åˆ—è¡¨
    group('Fetch Assignments', function() {
      const assignRes = http.get(
        `${BASE_URL}/api/classrooms/classroom-123/assignments`,
        {
          headers: {
            Authorization: `Bearer ${authToken}`
          }
        }
      );

      check(assignRes, {
        'assignment list status is 200': (r) => r.status === 200,
        'assignment list is array': (r) => Array.isArray(r.json())
      });
    });

    sleep(2);

    // 3. æäº¤ä½œæ¥­ (æ¨¡æ“¬)
    group('Submit Assignment', function() {
      const submitRes = http.post(
        `${BASE_URL}/api/assignments/assignment-1/submissions`,
        {
          audioUrl: 'https://s3.../audio.wav'
        },
        {
          headers: {
            Authorization: `Bearer ${authToken}`,
            'Content-Type': 'application/json'
          }
        }
      );

      check(submitRes, {
        'submission status is 201': (r) => r.status === 201,
        'submission has ID': (r) => r.json('submissionId')
      });
    });

    sleep(1);
  });
}
```

### 8.2 Artillery è² è¼‰æ¸¬è©¦

```yaml
# performance-tests/artillery-load-test.yml

config:
  target: "{{ $processEnvironment.BASE_URL || 'http://localhost:3000' }}"
  phases:
    - duration: 60
      arrivalRate: 10
      name: "Warm up"
    - duration: 120
      arrivalRate: 50
      name: "Ramp up"
    - duration: 60
      arrivalRate: 100
      name: "Spike"
  processor: "./processor.js"
  variables:
    emails:
      - student1@test.com
      - student2@test.com
      - student3@test.com

scenarios:
  - name: "Student Assignment Flow"
    flow:
      - post:
          url: "/api/auth/login"
          json:
            email: "{{ $randomChoice(emails) }}"
            password: "password123"
          capture:
            json: "$.token"
            as: "authToken"

      - get:
          url: "/api/classrooms/classroom-123/assignments"
          headers:
            Authorization: "Bearer {{ authToken }}"

      - think: 5

      - post:
          url: "/api/assignments/assignment-1/submissions"
          headers:
            Authorization: "Bearer {{ authToken }}"
          json:
            audioUrl: "https://s3.../audio.wav"

      - think: 2

      - get:
          url: "/api/classrooms/classroom-123/progress-analytics"
          headers:
            Authorization: "Bearer {{ authToken }}"
```

---

## 9ï¸âƒ£ æ¸¬è©¦è¦†è“‹ç‡ç›®æ¨™

```typescript
// jest.config.js

module.exports = {
  // ...
  collectCoverageFrom: [
    'src/**/*.{ts,tsx}',
    '!src/**/*.d.ts',
    '!src/main.ts',
    '!src/index.tsx'
  ],
  coverageThresholds: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    },
    // é—œéµè·¯å¾‘æ›´é«˜çš„è¦†è“‹ç‡
    './src/services/ai-scoring.service.ts': {
      branches: 95,
      functions: 95,
      lines: 95,
      statements: 95
    },
    './src/services/github-sync.service.ts': {
      branches: 90,
      functions: 90,
      lines: 90,
      statements: 90
    }
  }
};
```

### 9.1 è¦†è“‹ç‡ç›®æ¨™åˆ†è§£

```
æ•´é«”ç›®æ¨™: > 80%

åˆ†å±¤ç›®æ¨™:
â”œâ”€ å–®å…ƒæ¸¬è©¦: 80% è¦†è“‹ç‡
â”‚  â”œâ”€ Services: 95%
â”‚  â”œâ”€ Controllers: 85%
â”‚  â”œâ”€ Utils: 90%
â”‚  â””â”€ Components: 80%
â”‚
â”œâ”€ æ•´åˆæ¸¬è©¦: 15% è¦†è“‹ç‡
â”‚  â”œâ”€ API endpoints: 100%
â”‚  â”œâ”€ Database flows: 85%
â”‚  â””â”€ Service interactions: 80%
â”‚
â””â”€ E2E æ¸¬è©¦: 5% è¦†è“‹ç‡
   â”œâ”€ Critical paths: 100%
   â”œâ”€ Error handling: 80%
   â””â”€ User workflows: 90%

ç‰¹æ®Šè¦å‰‡:
âœ… AI è©•åˆ†å¼•æ“: > 95% (ç”Ÿå‘½é€±æœŸé—œéµ)
âœ… GitHub åŒæ­¥: > 90% (è³‡æ–™å®Œæ•´æ€§é—œéµ)
âœ… èªè­‰ç³»çµ±: > 90% (å®‰å…¨æ€§é—œéµ)
âœ… è©•åˆ† API: > 85% (ç”¨æˆ¶é«”é©—é—œéµ)

è±å…é …:
âŒ Mock å®šç¾©ä¸è¨ˆå…¥è¦†è“‹ç‡
âŒ æ¸¬è©¦å·¥å…·å‡½æ•¸ä¸è¨ˆå…¥è¦†è“‹ç‡
âŒ é…ç½®æª”æ¡ˆä¸è¨ˆå…¥è¦†è“‹ç‡
```

---

## ğŸ”Ÿ åŸ·è¡Œå‘½ä»¤é€ŸæŸ¥

```bash
# å–®å…ƒæ¸¬è©¦
npm run test:unit              # åŸ·è¡Œæ‰€æœ‰å–®å…ƒæ¸¬è©¦
npm run test:unit:watch       # ç›£æ§æ¨¡å¼
npm run test:unit -- --coverage  # ç”Ÿæˆè¦†è“‹ç‡å ±å‘Š

# æ•´åˆæ¸¬è©¦
npm run test:integration       # åŸ·è¡Œæ‰€æœ‰æ•´åˆæ¸¬è©¦
npm run test:integration:watch # ç›£æ§æ¨¡å¼

# E2E æ¸¬è©¦
npm run test:e2e              # åŸ·è¡Œæ‰€æœ‰ E2E æ¸¬è©¦
npm run test:e2e -- --headed  # æœ‰è¦–çª—åŸ·è¡Œ
npm run test:e2e -- --debug   # èª¿è©¦æ¨¡å¼

# å…¨éƒ¨æ¸¬è©¦
npm run test                  # åŸ·è¡Œå…¨éƒ¨æ¸¬è©¦ (å–®å…ƒ + æ•´åˆ + E2E)
npm run test:all             # åŒ…æ‹¬æ•ˆèƒ½æ¸¬è©¦

# æ•ˆèƒ½æ¸¬è©¦
npm run test:performance     # åŸ·è¡Œ k6 æ•ˆèƒ½æ¸¬è©¦
npm run test:load           # åŸ·è¡Œ Artillery è² è¼‰æ¸¬è©¦

# è¦†è“‹ç‡æª¢æŸ¥
npm run test:coverage       # æª¢æŸ¥è¦†è“‹ç‡
npm run test:coverage:report # ç”Ÿæˆ HTML è¦†è“‹ç‡å ±å‘Š

# CI ç’°å¢ƒ
npm run test:ci             # å°ˆç‚º CI å„ªåŒ–çš„åŸ·è¡Œ
npm run test:ci:coverage    # ä¸Šå‚³è¦†è“‹ç‡åˆ° Codecov
```

---

## ğŸ“‹ æ¸¬è©¦æª¢æŸ¥æ¸…å–®

### Pre-Commit

- [ ] æ‰€æœ‰æœ¬åœ°å–®å…ƒæ¸¬è©¦é€šé (`npm run test:unit`)
- [ ] è¦†è“‹ç‡ç¬¦åˆé–¾å€¼ (> 80%)
- [ ] æ²’æœ‰ linting éŒ¯èª¤ (`npm run lint`)
- [ ] TypeScript é¡å‹æª¢æŸ¥é€šé (`npm run type-check`)

### Pre-PR

- [ ] æ–°å¢çš„ä»£ç¢¼æœ‰ç›¸æ‡‰çš„å–®å…ƒæ¸¬è©¦
- [ ] æ•´åˆæ¸¬è©¦é€šé (`npm run test:integration`)
- [ ] E2E æ¸¬è©¦é€šé (`npm run test:e2e`)
- [ ] è¦†è“‹ç‡æå‡æˆ–ä¿æŒ
- [ ] ç„¡æ–°çš„è­¦å‘Šæˆ–éŒ¯èª¤

### Pre-Merge (Staging)

- [ ] æ‰€æœ‰ CI/CD æ¸¬è©¦é€šé
- [ ] æ•ˆèƒ½æ¸¬è©¦ç„¡é€€åŒ– (P95 < 500ms)
- [ ] è³‡æ–™åº«é·ç§»æ¸¬è©¦é€šé
- [ ] å®‰å…¨æƒæç„¡é—œéµå•é¡Œ

---

## ğŸ¯ æœ€ä½³å¯¦è¸

### 1. æ¸¬è©¦é‡‘å­—å¡”åŸå‰‡

```
âœ… DO:
- å¤šæ•¸æ¸¬è©¦åœ¨åº•å±¤ (å–®å…ƒæ¸¬è©¦)
- è¼ƒå°‘æ•´åˆæ¸¬è©¦
- æœ€å°‘ E2E æ¸¬è©¦

âŒ DON'T:
- å¯«å¤ªå¤š E2E æ¸¬è©¦ (æ…¢ä¸”è„†å¼±)
- è·³éå–®å…ƒæ¸¬è©¦ç›´æ¥å¯«æ•´åˆ
- ç”¨ E2E æ¸¬è©¦é©—è­‰é‚è¼¯ (æ‡‰ç”¨å–®å…ƒæ¸¬è©¦)
```

### 2. Mock èˆ‡ Stub

```typescript
// âœ… GOOD: Mock å¤–éƒ¨ä¾è³´
const mockWhisper = jest.fn()
  .mockResolvedValue({ text: 'æˆ‘å«å°æ˜' });

// âŒ BAD: çœŸå¯¦èª¿ç”¨å¤–éƒ¨ API
const transcript = await realWhisper.transcribe(audioUrl);
```

### 3. æ¸¬è©¦éš”é›¢

```typescript
// âœ… GOOD: æ¯å€‹æ¸¬è©¦ç¨ç«‹
beforeEach(async () => {
  await setupTestData();
});

afterEach(async () => {
  await cleanupTestData();
});

// âŒ BAD: æ¸¬è©¦ä¹‹é–“æœ‰ä¾è³´
it('test 1', async () => {
  data = await setup();
});

it('test 2', async () => {
  expect(data).toBeDefined(); // ä¾è³´å‰ä¸€å€‹æ¸¬è©¦
});
```

### 4. æ¸…æ™°çš„æ¸¬è©¦åç¨±

```typescript
// âœ… GOOD
it('should return user profile when valid ID provided')
it('should throw error when email already exists')
it('should prevent submission after deadline')

// âŒ BAD
it('works')
it('test user')
it('error case')
```

---

**ç¸½çµ**: å®Œæ•´çš„æ¸¬è©¦ç­–ç•¥ç¢ºä¿ç³»çµ±ç©©å®šã€åŠŸèƒ½æ­£ç¢ºã€æ•ˆèƒ½é”æ¨™ã€‚è‡ªå‹•åŒ–æ¸¬è©¦è®“é–‹ç™¼è€…æ”¾å¿ƒé‡æ§‹,æŒçºŒæ•´åˆç¢ºä¿è³ªé‡ã€‚å„ªå…ˆæ–¼åŠŸèƒ½å®Œæˆå…¶æ¬¡å®Œæˆçš„æ¸¬è©¦,æ˜¯é•·æœŸå¯ç¶­è­·æ€§çš„æŠ•è³‡ã€‚
