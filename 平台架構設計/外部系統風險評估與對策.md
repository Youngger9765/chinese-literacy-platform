# 外部系統整合方案 - 風險評估與對策

> 記錄日期：2026-02-13
> 評估者：系統架構團隊
> 風險等級：🔴 高風險 | 🟡 中風險 | 🟢 低風險

---

## 🎯 執行摘要

**核心問題**：使用 Notion、GitHub、Google Classroom 等外部系統是否有不可接受的風險？

**結論**：
- ✅ **可行**，但需要嚴格的風險管理
- ⚠️ 存在 **3 個高風險點**，必須有對策
- 🎯 建議採用 **混合方案** + **退出策略**

---

## 📊 風險矩陣總覽

| 風險類別 | 風險等級 | 發生機率 | 影響程度 | 對策完整度 | 可接受性 |
|---------|---------|---------|---------|-----------|---------|
| **廠商鎖定** | 🔴 高 | 高 | 極高 | ✅ 完整 | ✅ 可接受 |
| **服務中斷** | 🟡 中 | 中 | 高 | ✅ 完整 | ✅ 可接受 |
| **成本失控** | 🔴 高 | 中 | 高 | ✅ 完整 | ✅ 可接受 |
| **資料主權** | 🔴 高 | 低 | 極高 | ⚠️ 需強化 | ⚠️ 條件接受 |
| **功能限制** | 🟡 中 | 高 | 中 | ✅ 完整 | ✅ 可接受 |
| **API 變更** | 🟡 中 | 中 | 中 | ✅ 完整 | ✅ 可接受 |
| **隱私合規** | 🟡 中 | 低 | 高 | ✅ 完整 | ✅ 可接受 |
| **效能瓶頸** | 🟢 低 | 中 | 中 | ✅ 完整 | ✅ 可接受 |

---

## 🔴 高風險項目詳細分析

### 風險 1：廠商鎖定 (Vendor Lock-in)

#### 風險描述

**問題**：
- 過度依賴外部系統，難以遷移
- 外部系統漲價、關閉服務、政策變更
- 技術債累積，遷移成本越來越高

**具體場景**：
```
Year 1: 使用 Notion，投入 50% 核心邏輯
Year 2: Notion 漲價 3 倍
Year 3: 想遷移，發現核心邏輯深度綁定
結果: 被迫接受漲價，或花費 6 個月重構
```

---

#### 影響評估

| 影響維度 | 嚴重程度 | 說明 |
|---------|---------|------|
| **財務影響** | ⭐⭐⭐⭐⭐ | 被迫接受漲價，年增 200-500% |
| **時間影響** | ⭐⭐⭐⭐⭐ | 遷移需 6-12 個月 |
| **業務影響** | ⭐⭐⭐⭐ | 遷移期間功能受限 |
| **用戶影響** | ⭐⭐⭐ | 遷移時可能服務中斷 |

**發生機率**：**高（70%）**
- Notion/GitHub 歷史上有多次漲價
- 教育市場政策變化快

---

#### 對策（三層防護）

##### ✅ 對策 1：核心資料掌握在手（必須）

**原則**：外部系統只是「編輯器」和「容器」，核心資料都在我們資料庫

```sql
-- 我們的核心資料（不可失去）
student_activities:        -- 學習活動記錄
  - 完整的學習歷程
  - AI 評分結果
  - 學習數據分析

student_progress:          -- 學習進度
  - 能力雷達圖數據
  - 成長曲線

ai_analysis_results:       -- AI 分析結果
  - 錯誤分析
  - 個人化建議

-- 外部系統資料（可替換）
notion_page_id:            -- Notion 的頁面 ID（只是引用）
github_issue_number:       -- GitHub 的 Issue 編號（只是引用）
google_classroom_work_id:  -- Google 的作業 ID（只是引用）
```

**遷移能力保證**：
```
核心資料（100%）在我們手上
    ↓
外部系統只是「UI 包裝」
    ↓
隨時可遷移到其他系統
```

---

##### ✅ 對策 2：定期備份外部系統資料

```typescript
// 每日備份任務
@cron("0 2 * * *")  // 每天凌晨 2 點
async function backupExternalSystems() {
  // 1. 備份 Notion 內容
  const notionPages = await getAllNotionPages();
  for (const page of notionPages) {
    const content = await notion.blocks.children.list({
      block_id: page.id,
    });

    // 轉換為 Markdown 儲存
    const markdown = convertNotionToMarkdown(content);
    await saveToBackup(`notion/${page.id}.md`, markdown);
  }

  // 2. 備份 GitHub Issues
  const repos = await getAllRepos();
  for (const repo of repos) {
    const issues = await octokit.rest.issues.listForRepo({
      owner: repo.owner,
      repo: repo.name,
      state: 'all',
    });

    await saveToBackup(`github/${repo.name}/issues.json`, issues);
  }

  // 3. 備份 Google Classroom 課程結構
  const courses = await classroom.courses.list();
  await saveToBackup(`classroom/courses.json`, courses);
}
```

**備份策略**：
- 每日全量備份（Markdown + JSON）
- 保留 30 天歷史版本
- 儲存於 S3 Glacier（低成本）

---

##### ✅ 對策 3：抽象層設計（可替換）

**介面抽象**：
```typescript
// 定義統一介面
interface ICourseContentProvider {
  createCourse(title: string, content: string): Promise<string>;
  updateCourse(id: string, content: string): Promise<void>;
  getCourse(id: string): Promise<Course>;
  deleteCourse(id: string): Promise<void>;
}

// Notion 實作
class NotionCourseProvider implements ICourseContentProvider {
  async createCourse(title, content) {
    const page = await notion.pages.create({ ... });
    return page.id;
  }
  // ...
}

// Strapi 實作（遷移選項）
class StrapiCourseProvider implements ICourseContentProvider {
  async createCourse(title, content) {
    const entry = await strapi.create('courses', { title, content });
    return entry.id;
  }
  // ...
}

// 使用時可輕鬆切換
const provider: ICourseContentProvider =
  config.useNotion ? new NotionCourseProvider() : new StrapiCourseProvider();
```

**遷移計畫**：
```
Phase 1-2: Notion (快速 MVP)
    ↓ 3-6 個月驗證
Phase 3: 評估是否需要遷移
    ↓ 如需遷移
Option A: Strapi (開源 Headless CMS)
Option B: 自建編輯器 (Slate.js / TipTap)
Option C: Contentful (另一個商業選項)
```

---

##### ✅ 對策 4：逐步遷移策略

**不是一次全遷移，而是模組化遷移**：

```
Year 1:
  Notion: 100% 課程內容
  GitHub: 100% 作業管理
  Google: 100% 班級管理

Year 2 (如需遷移):
  Notion: 80% (官方課程仍在)
  自建編輯器: 20% (機構自建課程遷移)
  GitHub: 100%
  Google: 100%

Year 3 (如需遷移):
  Notion: 0%
  自建編輯器: 100%
  GitHub: 50%
  自建任務系統: 50%
  Google: 100%
```

---

### 風險 2：成本失控

#### 風險描述

**問題**：
- 使用量超出預期，成本暴增
- 外部系統按用量計費（API 呼叫數、儲存量）
- 多機構使用，成本線性增長

**具體場景**：
```
預估: 2000 學生，$1,300/月
實際: 5000 學生，$4,500/月（超支 246%）
原因: Notion 按 Workspace 用戶數計費
```

---

#### 影響評估

| 影響維度 | 嚴重程度 | 說明 |
|---------|---------|------|
| **財務影響** | ⭐⭐⭐⭐⭐ | 月成本可能 2-3 倍超支 |
| **業務影響** | ⭐⭐⭐⭐ | 可能被迫限制用戶增長 |
| **競爭力** | ⭐⭐⭐ | 成本高，定價競爭力弱 |

**發生機率**：**中（50%）**
- 教育平台增長不可預測
- 外部系統定價模式複雜

---

#### 對策

##### ✅ 對策 1：成本監控與預警

```typescript
// 即時成本追蹤
async function trackExternalCosts() {
  // 1. Notion 成本（按用戶數）
  const notionUsers = await countNotionActiveUsers();
  const notionCost = calculateNotionCost(notionUsers);

  // 2. GitHub 成本（按 repo 數）
  const githubRepos = await countGitHubRepos();
  const githubCost = calculateGitHubCost(githubRepos);

  // 3. 總成本
  const totalCost = notionCost + githubCost;
  const budget = await getBudget();

  // 預警
  if (totalCost > budget * 0.8) {
    await alert.send({
      level: 'warning',
      message: `外部系統成本達預算 80%: $${totalCost}/${budget}`,
    });
  }

  if (totalCost > budget) {
    await alert.send({
      level: 'critical',
      message: `外部系統成本超支: $${totalCost}/${budget}`,
      action: '立即檢視成本優化方案',
    });
  }
}
```

**監控頻率**：每日更新

---

##### ✅ 對策 2：分級計費模型

**向用戶收費時包含外部系統成本**：

| 我們的方案 | 學生數 | 外部系統成本 | 我們的成本 | 售價 | 毛利 |
|-----------|-------|-------------|-----------|------|------|
| 試點版 | 100 | $200/月 | $100/月 | $500/月 | 40% |
| 基礎版 | 500 | $450/月 | $200/月 | $1,200/月 | 45% |
| 專業版 | 2,000 | $1,300/月 | $500/月 | $3,000/月 | 40% |
| 企業版 | 5,000+ | $2,800/月 | $800/月 | $7,000/月 | 49% |

**關鍵**：外部系統成本轉嫁給客戶

---

##### ✅ 對策 3：成本優化策略

**快取優化**（減少 API 呼叫）：
```typescript
// 激進快取策略
const cache = new Redis();

async function getCourseFromNotion(pageId: string) {
  // 1. 嘗試快取（24 小時）
  const cached = await cache.get(`notion:${pageId}`);
  if (cached) {
    await metrics.increment('cache_hit');
    return JSON.parse(cached);
  }

  // 2. 無快取才呼叫 API
  await metrics.increment('api_call');
  const page = await notion.pages.retrieve({ page_id: pageId });

  // 3. 快取 24 小時
  await cache.setex(`notion:${pageId}`, 86400, JSON.stringify(page));

  return page;
}
```

**批次處理**（減少 API 次數）：
```typescript
// 批次更新（每 5 分鐘一次）
const updateQueue = [];

function queueNotionUpdate(pageId, content) {
  updateQueue.push({ pageId, content });
}

@cron("*/5 * * * *")  // 每 5 分鐘
async function flushNotionUpdates() {
  if (updateQueue.length === 0) return;

  // 批次更新
  await Promise.all(
    updateQueue.map(item =>
      notion.pages.update({ page_id: item.pageId, ... })
    )
  );

  updateQueue.length = 0;
}
```

---

##### ✅ 對策 4：混合方案（降低成本）

**小機構共用 Workspace，大機構獨立**：

| 機構規模 | Notion 方案 | 月費 |
|---------|------------|------|
| 10 個小機構（各 100 學生） | 共用 1 個 Workspace | $300 |
| 1 個大機構（5000 學生） | 獨立 Workspace | $2,000 |

**節省**：$3,000 - $2,300 = **$700/月**（23% 節省）

---

### 風險 3：資料主權與合規

#### 風險描述

**問題**：
- 學生資料存放在境外（Notion/GitHub 美國）
- 個資法合規疑慮
- 教育部資安規範要求

**具體場景**：
```
教育部稽核:
  "學生學習資料存放在美國 Notion 伺服器？"
  "是否符合個資法境內處理原則？"
  "資料外洩責任歸屬？"

結果: 可能被要求停用或下架
```

---

#### 影響評估

| 影響維度 | 嚴重程度 | 說明 |
|---------|---------|------|
| **法律風險** | ⭐⭐⭐⭐⭐ | 違反個資法罰款 2-50 萬 |
| **業務風險** | ⭐⭐⭐⭐⭐ | 可能被下架 |
| **聲譽影響** | ⭐⭐⭐⭐ | 資料外洩新聞 |

**發生機率**：**低（20%）**
- 但一旦發生影響極大

---

#### 對策

##### ✅ 對策 1：資料分類儲存

**原則**：敏感資料不放外部系統

```sql
-- 敏感資料（僅存我們的資料庫）
students:
  - name (真實姓名)
  - birth_date (出生日期)
  - id_number (身分證字號)
  - parent_phone (家長電話)

student_activities:
  - audio_url (朗讀音訊)
  - score (成績)
  - ai_feedback (評語)

-- 非敏感資料（可放外部系統）
notion:
  - 課程內容（公開教材）
  - 教學資源（無個人資訊）

github:
  - 作業描述（無學生姓名，用 ID 代替）
  - 教師評語（去識別化）

google_classroom:
  - 班級結構（學校已使用，合規）
```

**關鍵**：
- ✅ 學生真實姓名、成績、音訊 → 僅存我們資料庫
- ✅ 課程內容、作業描述 → 可放外部系統

---

##### ✅ 對策 2：去識別化處理

**GitHub Issue 範例**：
```yaml
# ❌ 錯誤：包含真實姓名
Issue #1: 【作業】王小明 - 第一課朗讀練習
  學生: 王小明
  成績: 85 分

# ✅ 正確：去識別化
Issue #1: 【作業】第一課朗讀練習
  學生 ID: student_abc123 (內部 ID，無法反查)
  狀態: 已完成

  # 成績不放在 Issue，存我們資料庫
```

---

##### ✅ 對策 3：合規聲明與用戶同意

**使用條款明確說明**：
```
教育平台使用條款 (Terms of Service)

第 5 條 資料處理與儲存
1. 學生個人資料（姓名、成績、音訊）儲存於台灣境內伺服器
2. 課程內容使用 Notion 服務（美國），僅包含教材內容，不含個人資訊
3. 作業管理使用 GitHub 服務（美國），僅包含作業描述，學生以 ID 代稱

第 6 條 資料安全
1. 敏感資料採用 AES-256 加密
2. 定期備份並儲存於台灣境內
3. 符合台灣個資法與教育部資安規範

用戶權利:
□ 我已閱讀並同意上述條款
□ 我了解課程內容將使用境外服務（Notion/GitHub）
□ 我了解學生個人資料儲存於台灣境內
```

---

##### ✅ 對策 4：區域化方案（終極方案）

**如果合規壓力大，使用境內替代**：

| 外部系統 | 境內替代方案 | 成本對比 |
|---------|------------|---------|
| Notion | Strapi (自架) / 飛書文檔 | 持平或更低 |
| GitHub | GitLab (自架) / Gitee | 持平 |
| Google Classroom | 台灣學習吧 / 均一教育平台 API | 需洽談 |

**時機**：
- Phase 1-2: 使用境外服務（快速 MVP）
- Phase 3: 如有合規壓力，遷移到境內方案

---

## 🟡 中風險項目分析

### 風險 4：服務中斷

#### 風險描述
- Notion/GitHub/Google 服務中斷
- API 限流或故障
- 網路連線問題

#### 對策
```typescript
// 1. 多重備援
const providers = [
  new NotionProvider(),
  new StrapiProvider(),  // 備援
];

async function getCourse(id) {
  for (const provider of providers) {
    try {
      return await provider.getCourse(id);
    } catch (error) {
      console.error(`Provider failed: ${provider.name}`);
      continue;  // 嘗試下一個
    }
  }
  throw new Error('All providers failed');
}

// 2. 降級模式
if (notionDown) {
  // 從快取提供服務
  return await cache.get(courseId);
}

// 3. 離線模式
if (offline) {
  // 使用 Service Worker 提供離線內容
  return await serviceWorker.getCachedContent();
}
```

---

### 風險 5：功能限制

#### 風險描述
- 外部系統功能無法滿足需求
- 客製化困難

#### 對策
- ✅ 快速驗證 POC（確認功能足夠）
- ✅ 抽象層設計（可替換）
- ✅ 混合方案（部分自建）

---

### 風險 6：API 變更

#### 風險描述
- Notion/GitHub API 版本升級
- Breaking Changes

#### 對策
```typescript
// 1. 版本鎖定
const NOTION_API_VERSION = '2022-06-28';

// 2. Adapter 模式
class NotionAdapter {
  async getCourse(id) {
    if (API_VERSION === 'v1') {
      return this.getCoursev1(id);
    } else {
      return this.getCoursev2(id);
    }
  }
}

// 3. 監控 API 變更
@cron("0 9 * * *")
async function checkAPIChanges() {
  const latestVersion = await notion.getLatestAPIVersion();
  if (latestVersion !== CURRENT_VERSION) {
    await alert.send('Notion API 有新版本，請檢視變更');
  }
}
```

---

## 📋 風險決策矩陣

### 是否應該使用外部系統？

| 評估項目 | 自建方案 | 外部系統整合 | 勝出 |
|---------|---------|-------------|------|
| **開發時間** | 6-8 個月 | 2-3 個月 | ✅ 外部 |
| **開發成本** | $300k-500k | $50k-100k | ✅ 外部 |
| **運營成本/年** | $30k-60k | $15k-35k | ✅ 外部 |
| **可控性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ✅ 自建 |
| **擴展性** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ✅ 自建 |
| **維護負擔** | ⭐⭐ | ⭐⭐⭐⭐⭐ | ✅ 外部 |
| **資料主權** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ✅ 自建 |
| **快速驗證** | ⭐⭐ | ⭐⭐⭐⭐⭐ | ✅ 外部 |

**加權評分**（創業早期）：
- 開發時間（權重 30%）：外部系統 +30
- 成本（權重 25%）：外部系統 +25
- 快速驗證（權重 20%）：外部系統 +20
- 可控性（權重 15%）：自建 +15
- 資料主權（權重 10%）：自建 +10

**總分**：
- **外部系統**：75 分
- **自建方案**：25 分

**結論**：✅ **早期使用外部系統是正確選擇**

---

## 🎯 最終建議

### 推薦方案：混合 + 漸進式遷移

```
Phase 1 (0-6 個月) - MVP 驗證
  └─ 100% 外部系統
      ├─ Notion: 課程內容
      ├─ GitHub: 作業管理
      └─ Google Classroom: 班級同步

  目標: 快速驗證產品市場契合度 (PMF)
  成本: $200-450/月
  風險: 可接受（有退出策略）

Phase 2 (6-12 個月) - 規模化
  └─ 80% 外部系統 + 20% 自建
      ├─ Notion: 官方課程 (保留)
      ├─ 自建編輯器: 機構課程 (新增)
      ├─ GitHub: 作業管理 (保留)
      └─ Google Classroom: 班級同步 (保留)

  目標: 達到 2000+ 學生
  成本: $1,300/月 + 自建維護成本
  風險: 低（核心功能已自建）

Phase 3 (12-24 個月) - 完全自主
  └─ 20% 外部系統 + 80% 自建
      ├─ 自建編輯器: 100% 課程內容
      ├─ 自建任務系統: 80% 作業管理
      ├─ GitHub: 20% 作業管理 (備援)
      └─ Google Classroom: 班級同步 (保留)

  目標: 完全掌控核心功能
  成本: $500/月 + 自建維護成本
  風險: 極低（完全自主）
```

---

### 決策檢查清單

**使用外部系統前必須確認**：

- [x] ✅ 核心資料掌握在手（學生資料、學習記錄）
- [x] ✅ 有完整備份策略（每日備份）
- [x] ✅ 有抽象層設計（可替換）
- [x] ✅ 有成本監控機制（預警）
- [x] ✅ 有退出計畫（6-12 個月可遷移）
- [x] ✅ 符合合規要求（去識別化、用戶同意）
- [x] ✅ 有服務降級方案（快取、離線）

**全部打勾** → ✅ 可以使用外部系統

---

## 📊 風險接受聲明

**我們接受以下風險**：

1. ✅ **廠商鎖定風險**
   - 理由：有退出策略，核心資料在手
   - 對策：6-12 個月可遷移

2. ✅ **成本增長風險**
   - 理由：成本可預測，可轉嫁客戶
   - 對策：成本監控 + 分級計費

3. ✅ **資料主權風險**（條件接受）
   - 理由：敏感資料不放外部，去識別化
   - 條件：用戶明確同意
   - 退路：Phase 3 遷移到境內方案

**我們不接受以下風險**：

1. ❌ **無退出策略的鎖定**
   - 必須：有抽象層 + 備份策略

2. ❌ **敏感資料放境外無加密**
   - 必須：去識別化 + 用戶同意

3. ❌ **單點故障無備援**
   - 必須：快取 + 降級模式

---

## 🚀 立即行動項

### Week 1: 風險驗證
1. ✅ 驗證 Notion API 功能完整性
2. ✅ 驗證 GitHub Projects API
3. ✅ 驗證 Google Classroom 同步
4. ✅ 評估合規要求

### Week 2-3: 風險對策實作
1. ⏳ 實作抽象層（可替換）
2. ⏳ 實作備份系統（每日）
3. ⏳ 實作成本監控
4. ⏳ 去識別化流程

### Week 4: 風險評估報告
1. ⏳ 完成 POC
2. ⏳ 提交風險評估報告
3. ⏳ 決定是否繼續

---

## 📚 相關文件

- [外部系統整合方案.md](./外部系統整合方案.md) - 技術方案
- [architecture/04-多租戶實作.md](./architecture/04-多租戶實作.md) - 多租戶設計

---

**文件用途**：
此文件評估使用外部系統的所有風險，並提供完整的對策與退出策略。確保團隊充分理解風險並有應對方案。

**最終結論**：✅ **風險可接受，建議採用外部系統 + 漸進式遷移策略**
