# 簡化版：減少外部依賴，先做好核心

> **核心原則**: 能用開源/本地方案的，不用外部 API
> **優先級**: 核心功能 > 進階功能 > 外部整合

---

## ❌ 原方案的問題（過度依賴外部）

```
外部依賴：
1. Azure Speech SDK     → 成本 $250/月，風險高
2. LLM API (GPT-4)      → 成本 $45/月，風險高
3. GCP Cloud Run        → 部署依賴

總成本：$295/月
風險：外部服務掛了，整個系統不能用
```

---

## ✅ 簡化方案（減少外部依賴）

### 核心原則

```
能本地做的，不用外部 API
能開源的，不用付費服務
能簡單的，不要複雜
```

---

## 🎯 Phase 1: 核心功能（不依賴外部）

### Week 3-10: 朗讀分析核心（本地方案）

#### 語音辨識：Whisper（開源，可本地運行）

**為什麼用 Whisper？**
- ✅ 開源免費（OpenAI 發布）
- ✅ 中文支援好（zh-TW 可用）
- ✅ 可本地運行（不用付費 API）
- ✅ 準確率高（接近 Azure）

**部署方式**：
```python
# FastAPI 本地運行 Whisper
import whisper

model = whisper.load_model("base")  # 或 small, medium

def transcribe_audio(audio_file):
    result = model.transcribe(audio_file, language="zh")
    return result["text"]
```

**成本**：
- API 費用：$0（本地運行）
- 伺服器：需要 GPU（可用 GCP T4 GPU ~$100/月）
- **總計**：$100/月（比 Azure $250/月 便宜 60%）

---

#### 文本比對：Python 內建庫（不用外部 API）

**完全本地運算**：
```python
import difflib
from jellyfish import jaro_winkler_similarity

def compare_text(original, transcribed):
    # 逐字比對
    diff = difflib.ndiff(original, transcribed)

    errors = []
    for word in diff:
        if word.startswith('- '):
            errors.append(word[2:])  # 少讀的字
        elif word.startswith('+ '):
            errors.append(word[2:])  # 多讀的字

    # 計算相似度
    accuracy = jaro_winkler_similarity(original, transcribed)

    return {
        "accuracy": accuracy,
        "errors": errors
    }
```

**成本**：$0（Python 內建）

---

### Week 3-10: 蘇格拉底對話（先不做，或用簡單方案）

#### 方案 A：先不做（最簡單）✅ 推薦

```
Phase 1 只做朗讀分析：
- 學生朗讀 → AI 分析 → 顯示錯誤 → 結束

蘇格拉底對話延後到 Phase 2 或 Phase 3
等核心功能穩定後再加
```

#### 方案 B：Rule-based 問題（不用 LLM）

```python
# 預設問題模板（不用 LLM）
questions = {
    "understanding": [
        "這篇文章的主角是誰？",
        "故事發生在哪裡？",
        "主角遇到什麼問題？"
    ],
    "opinion": [
        "你喜歡這個故事嗎？為什麼？",
        "如果是你，你會怎麼做？"
    ]
}

# 簡單評分（關鍵字匹配）
def evaluate_answer(question, answer, lesson_content):
    keywords = extract_keywords(lesson_content)
    score = sum(1 for kw in keywords if kw in answer)
    return score / len(keywords)
```

**優點**：
- ✅ 不用 LLM API（成本 $0）
- ✅ 可控（問題品質穩定）
- ✅ 快速（不需等 API 回應）

**缺點**：
- ❌ 不夠智能（無法根據學生回答調整）
- ❌ 問題較死板

---

## 🗄️ 資料庫：PostgreSQL（本地）

**不用外部服務**：
```
開發：Docker Compose 本地 PostgreSQL
正式：自架 PostgreSQL（GCP Compute Engine）

不用 Cloud SQL（省錢）
```

---

## 🚀 部署：簡化方案

### 開發階段（本地）
```
Docker Compose:
- Next.js (port 3000)
- FastAPI (port 8000)
- PostgreSQL (port 5432)
- Whisper (內建在 FastAPI)

一鍵啟動：docker-compose up
```

### 正式環境（自架，不用 Cloud Run）
```
GCP Compute Engine (VM):
- 1 台 VM（4 vCPU + 16GB RAM + T4 GPU）
- Docker Compose 部署
- Nginx 反向代理

成本：~$150/月
（比 Cloud Run + Cloud SQL + Azure 便宜 50%）
```

---

## 💰 成本對比

| 項目 | 原方案 | 簡化方案 | 節省 |
|------|-------|---------|------|
| **語音辨識** | Azure $250/月 | Whisper (GPU VM) $100/月 | $150 |
| **LLM 對話** | GPT-4 $45/月 | Rule-based $0 | $45 |
| **資料庫** | Cloud SQL $50/月 | 自架 PostgreSQL $0 | $50 |
| **部署** | Cloud Run $30/月 | Compute Engine $150/月 | -$120 |
| **總計** | **$375/月** | **$250/月** | **$125 (33%)** |

**更重要的是**：
- ✅ 不依賴外部 API（Azure/OpenAI 掛了，我們還能用）
- ✅ 可控性高（Whisper 可 fine-tune）
- ✅ 無供應商鎖定

---

## 📋 調整後的開發順序

### Phase 0 (Week 1-2): 環境 + Whisper 測試

```
Week 1:
- GitHub 倉庫
- Docker Compose (Next.js + FastAPI + PostgreSQL)
- Whisper 本地測試環境

Week 2:
- Whisper zh-TW 準確率測試
- 兒童語音樣本測試
- 成本評估（GPU VM）
```

---

### Phase 1 (Week 3-10): 朗讀分析（只做核心）

```
Week 3-4: 資料庫設計
Week 5-7: Whisper 整合 + 文本比對
Week 8-10: 學生介面 + 即時回饋

交付物：
- 學生可錄音 ✅
- AI 分析正確率 ✅
- 顯示錯誤字詞 ✅
- 儲存學習記錄 ✅

暫不做：
- ❌ 蘇格拉底對話（延後）
- ❌ 生字學習（延後）
```

**Demo 2 (Week 10)**：展示朗讀分析核心功能

---

### Phase 2 (Week 11-16): 學習歷程

```
Week 11-12: 錯誤詞彙追蹤
Week 13-14: 學習曲線圖
Week 15-16: 進度視覺化

不做蘇格拉底對話（太複雜，依賴外部）
```

---

### Phase 3 (Week 17-20): 校班師生課

```
Week 17-18: 班級管理
Week 19-20: 教師介面

保持不變
```

---

### Phase 4 (Week 21-22): 作業模式

```
Week 21-22: 作業指派

保持不變
```

---

### Phase 5 (Week 23-24): Beta 測試

```
Week 23-24: 測試 + 上線

如果有餘力，Phase 5 再加蘇格拉底對話（LLM）
```

---

## 🎯 核心功能定義（簡化版）

### 自學模式（不含蘇格拉底對話）

```
學生流程：
1. 選課文
2. 朗讀（分段）
3. AI 分析 → 顯示錯誤
4. 看學習歷程
5. 重複練習

不包含：
- ❌ AI 問問題（蘇格拉底對話）
- ❌ 理解度評估

理由：
- 先做好「識字解碼」（朗讀分析）
- 「背景知識」（理解）由老師在課堂做
```

---

### 作業模式（保持簡單）

```
老師流程：
1. 指派課文
2. 學生朗讀
3. AI 分析
4. 老師看報告

不包含：
- ❌ AI 問問題
- ❌ 自動評分理解度
```

---

## ⚠️ 蘇格拉底對話的處理

### 選項 A：完全不做（最簡單）✅ 推薦

```
理由：
1. 曾教授的閱讀方程式 = 識字解碼 × 背景知識
2. 我們先做好「識字解碼」（朗讀分析）
3. 「背景知識」由真人老師在課堂引導
4. 不需要 AI 對話

優點：
- 降低複雜度
- 減少外部依賴
- 降低成本
- 更快交付
```

### 選項 B：Phase 5 用 Rule-based（妥協方案）

```
如果真的需要對話：
- 用預設問題模板
- 不用 LLM
- 成本 $0
```

### 選項 C：未來用本地 LLM（長期方案）

```
如果未來要加智能對話：
- 用 Llama 3.1 / Qwen（開源）
- 本地運行（不用 API）
- 可 fine-tune 成教學專用模型
```

---

## 📊 簡化後的技術棧

| 層級 | 技術 | 原因 |
|------|------|------|
| **前端** | Next.js 14 | 不變 |
| **後端** | FastAPI | 不變 |
| **資料庫** | PostgreSQL（自架） | 不用 Cloud SQL |
| **語音辨識** | Whisper（本地） | 不用 Azure |
| **對話** | 暫不做 或 Rule-based | 不用 LLM API |
| **部署** | Docker + VM | 不用 Cloud Run |

---

## ✅ 立即行動（簡化版）

### Week 1
- [ ] GitHub 倉庫建立
- [ ] Docker Compose（Next.js + FastAPI + PostgreSQL）
- [ ] Whisper 本地測試環境

### Week 2
- [ ] Whisper zh-TW 測試（兒童語音）
- [ ] 文本比對測試（difflib）
- [ ] 成本評估（GPU VM）
- [ ] Demo 1：展示 Whisper 辨識結果

---

## 🎯 關鍵決策

**問題**：蘇格拉底對話要不要做？

**選項**：
1. **完全不做** ← 最簡單，最快
2. **用 Rule-based** ← 妥協方案
3. **Phase 5 再說** ← 保留彈性

**建議**：先選 1（完全不做），專注朗讀分析核心

---

**Generated with [Claude Code](https://claude.ai/code) via [Happy](https://happy.engineering)**

Co-Authored-By: Claude <noreply@anthropic.com>
Co-Authored-By: Happy <yesreply@happy.engineering>
